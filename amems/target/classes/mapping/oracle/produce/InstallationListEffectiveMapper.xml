<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.eray.thjw.produce.dao.InstallationListEffectiveMapper" >
  <resultMap id="BaseResultMap" type="com.eray.thjw.produce.po.InstallationListEffective" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="DPRTCODE" property="dprtcode" jdbcType="VARCHAR" />
    <result column="JX" property="jx" jdbcType="VARCHAR" />
    <result column="FJZCH" property="fjzch" jdbcType="VARCHAR" />
    <result column="WZ" property="wz" jdbcType="DECIMAL" />
    <result column="CJ" property="cj" jdbcType="DECIMAL" />
    <result column="FJDID" property="fjdid" jdbcType="VARCHAR" />
    <result column="BJH" property="bjh" jdbcType="VARCHAR" />
    <result column="XLH" property="xlh" jdbcType="VARCHAR" />
    <result column="PCH" property="pch" jdbcType="VARCHAR" />
    <result column="ZJSL" property="zjsl" jdbcType="DECIMAL" />
    <result column="LLKLX" property="llklx" jdbcType="DECIMAL" />
    <result column="LLKBH" property="llkbh" jdbcType="VARCHAR" />
    <result column="FJZW" property="fjzw" jdbcType="VARCHAR" />
    <result column="CHUCRQ" property="chucrq" jdbcType="TIMESTAMP" />
    <result column="TSN" property="tsn" jdbcType="VARCHAR" />
    <result column="TSO" property="tso" jdbcType="VARCHAR" />
    <result column="CSN" property="csn" jdbcType="DECIMAL" />
    <result column="CSO" property="cso" jdbcType="DECIMAL" />
    <result column="BJGZJL" property="bjgzjl" jdbcType="VARCHAR" />
    <result column="BZ" property="bz" jdbcType="VARCHAR" />
    <result column="SKBS" property="skbs" jdbcType="DECIMAL" />
    <result column="SSBS" property="ssbs" jdbcType="DECIMAL" />
    <result column="AZ_FXJLBID" property="azFxjlbid" jdbcType="VARCHAR" />
    <result column="AZSJ" property="azsj" jdbcType="TIMESTAMP" />
    <result column="AZJLDID" property="azjldid" jdbcType="VARCHAR" />
    <result column="AZJLDH" property="azjldh" jdbcType="VARCHAR" />
    <result column="AZRID" property="azrid" jdbcType="VARCHAR" />
    <result column="AZR" property="azr" jdbcType="VARCHAR" />
    <result column="AZBZ" property="azbz" jdbcType="VARCHAR" />
    <result column="CC_FXJLBID" property="ccFxjlbid" jdbcType="VARCHAR" />
    <result column="CCSJ" property="ccsj" jdbcType="TIMESTAMP" />
    <result column="CCJLDID" property="ccjldid" jdbcType="VARCHAR" />
    <result column="CCJLDH" property="ccjldh" jdbcType="VARCHAR" />
    <result column="CCRID" property="ccrid" jdbcType="VARCHAR" />
    <result column="CCR" property="ccr" jdbcType="VARCHAR" />
    <result column="CCBZ" property="ccbz" jdbcType="VARCHAR" />
    <result column="CJ_ZSJJH" property="cjZsjjh" jdbcType="VARCHAR" />
    <result column="CJ_ZSJXLH" property="cjZsjxlh" jdbcType="VARCHAR" />
    <result column="ZJZT" property="zjzt" jdbcType="DECIMAL" />
    <result column="YXBS" property="yxbs" jdbcType="DECIMAL" />
    <result column="WHBMID" property="whbmid" jdbcType="VARCHAR" />
    <result column="WHRID" property="whrid" jdbcType="VARCHAR" />
    <result column="WHSJ" property="whsj" jdbcType="TIMESTAMP" />
    <result column="ZJJLX" property="zjjlx" jdbcType="VARCHAR" />
    <result column="jldw" property="jldw" jdbcType="VARCHAR" />
    <result column="drbs" property="drbs" jdbcType="DECIMAL" />
    <result column="DPRTNAME" property="dprtname" jdbcType="VARCHAR" />
    <result column="CQID" property="cqid" jdbcType="VARCHAR" />
    <result column="KCCB" property="kccb" jdbcType="DECIMAL" />
    <result column="BIZ" property="biz" jdbcType="VARCHAR" />
    <result column="YWMC" property="ywmc" jdbcType="VARCHAR" />
    <result column="ZWMC" property="zwmc" jdbcType="VARCHAR" />
    
    <result column="D1XINGH" property="xh" jdbcType="VARCHAR" />
    <result column="D1JLDW" property="jldw" jdbcType="VARCHAR" />
    <result column="D1CJJH" property="cjjh" jdbcType="VARCHAR" />
    <result column="CERTIFICATECOUNT" property="paramsMap.certificateCount" jdbcType="VARCHAR" /><!-- 证书数量 -->
    
    <!-- 拆换记录附加字段 -->
    <result column="bjzwms" property="paramsMap.bjzwms" jdbcType="VARCHAR" />
    <result column="bjywms" property="paramsMap.bjywms" jdbcType="VARCHAR" />
    <result column="cjjh" property="paramsMap.cjjh" jdbcType="VARCHAR" />
    <result column="zjh" property="paramsMap.zjh" jdbcType="VARCHAR" />
    <result column="zjhzwms" property="paramsMap.zjhzwms" jdbcType="VARCHAR" />
    <result column="zjhywms" property="paramsMap.zjhywms" jdbcType="VARCHAR" />
    <result column="msn" property="paramsMap.msn" jdbcType="VARCHAR" />
    <result column="azjldid" property="paramsMap.azjldid" jdbcType="VARCHAR" />
    <result column="azjldh" property="paramsMap.azjldh" jdbcType="VARCHAR" />
    <result column="ccjldid" property="paramsMap.ccjldid" jdbcType="VARCHAR" />
    <result column="ccjldh" property="paramsMap.ccjldh" jdbcType="VARCHAR" />
    <result column="zjyysj" property="paramsMap.zjyysj" jdbcType="VARCHAR" />
    <result column="cj_zsjjh" property="paramsMap.cj_zsjjh" jdbcType="VARCHAR" /><!--  对应装上件号 -->
    <result column="cj_zsjxlh" property="paramsMap.cj_zsjxlh" jdbcType="VARCHAR" /> <!-- 对应装上件序列号 -->
    <result column="azfjCount" property="paramsMap.azfjCount" jdbcType="VARCHAR" />
    <result column="ccfjCount" property="paramsMap.ccfjCount" jdbcType="VARCHAR" />
    
    <result column="CAL" property="paramsMap.cal" jdbcType="VARCHAR" />
    <result column="CJJH" property="paramsMap.cjjh" jdbcType="VARCHAR" />
    <result column="JHLY" property="paramsMap.jhly" jdbcType="VARCHAR" />
    <result column="DQZT" property="paramsMap.dqzt" jdbcType="VARCHAR" />
    <result column="DQWZ" property="paramsMap.dqwz" jdbcType="VARCHAR" />

    <result column="azrq" property="paramsMap.azrq" jdbcType="VARCHAR" />	<!-- 安装日期 -->
    <result column="azsj" property="paramsMap.azsj" jdbcType="VARCHAR" />	<!-- 安装时间 -->
    <result column="czlx" property="paramsMap.czlx" jdbcType="VARCHAR" />	<!-- 操作类型 -->
    <result column="czrq" property="paramsMap.czrq" jdbcType="VARCHAR" />	<!-- 操作日期-->
    <result column="czsj" property="paramsMap.czsj" jdbcType="VARCHAR" />	<!-- 操作时间-->
    <result column="zjqdid" property="paramsMap.zjqdid" jdbcType="VARCHAR" />	<!-- 装机清单ID -->
    <result column="ywdjid" property="paramsMap.ywdjid" jdbcType="VARCHAR" />	<!-- 业务单据ID -->
    <result column="ywdjbh" property="paramsMap.ywdjbh" jdbcType="VARCHAR" />	<!-- 业务单据编号 -->
    <result column="ck_fjzch" property="paramsMap.ck_fjzch" jdbcType="VARCHAR" />	<!-- 仓库/飞机注册号 -->
    <result column="kw_zjwz" property="paramsMap.kw_zjwz" jdbcType="VARCHAR" />	<!-- 库位/装机位置 -->
    <result column="sjbj" property="paramsMap.sjbj" jdbcType="VARCHAR" />	<!-- 上级部件 -->
    <result column="czz" property="paramsMap.czz" jdbcType="VARCHAR" />	<!-- 操作者 -->
    <result column="bjyysj" property="paramsMap.bjyysj" jdbcType="VARCHAR" />	<!-- 部件已用：监控项目编号 + '#_#' + 部件使用量 + '#_#' + 在机使用量 -->
    <result column="czyy" property="paramsMap.czyy" jdbcType="VARCHAR" />	<!-- 拆装原因 -->
    <result column="CERTIFICATECOUNT" property="paramsMap.certificatecount" jdbcType="VARCHAR" />	<!-- 证书数量-->
    <result column="ZJH_YWMC" property="paramsMap.zjhywms" jdbcType="VARCHAR" />	<!-- 章节号英文名称-->
    <result column="ZJH_ZWMC" property="paramsMap.zjhzwms" jdbcType="VARCHAR" />	<!-- 章节号中文名-->


    <result column="D1HCLX" property="paramsMap.hclx" jdbcType="VARCHAR" />	<!-- 航材类型-->
  </resultMap>
  
  <resultMap type="com.eray.thjw.produce.po.InstallationListEffective" id="DetailResultMap" extends="BaseResultMap">
  	<association property="parent" javaType="com.eray.thjw.produce.po.InstallationListEffective">
    	<id column="PARID" property="id" jdbcType="VARCHAR"/>
	    <result column="PARWZ" property="wz" jdbcType="DECIMAL" />
	    <result column="PARCJ" property="cj" jdbcType="DECIMAL" />
	    <result column="PARBJH" property="bjh" jdbcType="VARCHAR" />
	    <result column="PARXLH" property="xlh" jdbcType="VARCHAR" />
	    <result column="PARPCH" property="pch" jdbcType="VARCHAR" />
    </association>
    <association property="whr" javaType="com.eray.thjw.po.User">  
        <id column="UWHRID" property="id"/>  
        <result column="WHRUSERNAME" property="username"/>  
        <result column="WHRREALNAME" property="realname"/>  
    </association>  
    <association property="hcMainData" javaType="com.eray.thjw.aerialmaterial.po.HCMainData">
    	<id column="D1ID" property="id" jdbcType="VARCHAR"/>
	    <result column="D1BJH" property="bjh" jdbcType="VARCHAR" />
	    <result column="D1ZWMS" property="zwms" jdbcType="VARCHAR" />
	    <result column="D1YWMS" property="ywms" jdbcType="VARCHAR" />
	    <result column="D1JLDW" property="jldw" jdbcType="VARCHAR" />
	    <result column="D1CJJH" property="cjjh" jdbcType="VARCHAR" />
	    <result column="D1ZJH" property="zjh" jdbcType="VARCHAR" />
	    <result column="D1HCJZ" property="hcjz" jdbcType="DECIMAL" />
	    <result column="D1GLJB" property="gljb" jdbcType="DECIMAL" />
	    <result column="D1SXKZ" property="sxkz" jdbcType="DECIMAL" />
	    <result column="D1HCLX" property="hclx" jdbcType="DECIMAL" />
	    <result column="D1HCLX_EJ" property="hclxEj" jdbcType="DECIMAL" />
	    <result column="D1IS_MEL" property="isMel" jdbcType="DECIMAL" />
	    <result column="D1MIN_KCL" property="minKcl" jdbcType="DECIMAL" />
	    <result column="D1MAX_KCL" property="maxKcl" jdbcType="DECIMAL" />
	    <result column="D1BZ" property="bz" jdbcType="VARCHAR" />
	    <result column="D1XH" property="xh" jdbcType="VARCHAR" />
	    <result column="D1GG" property="gg" jdbcType="VARCHAR" />
	    <result column="D1XINGH" property="xingh" jdbcType="VARCHAR" />
	    <result column="D1ZT" property="zt" jdbcType="DECIMAL" />
	    <result column="D1CJSJ" property="cjsj" jdbcType="TIMESTAMP" />
	    <result column="D1KCSL" property="kcsl" jdbcType="DECIMAL" />
	    <result column="D1KYKCSL" property="kykcsl" jdbcType="DECIMAL" />
    </association>
    <association property="fixChapter" javaType="com.eray.thjw.po.FixChapter">
    	<id column="D2ZJH" property="zjh" jdbcType="VARCHAR"/>
     	<result column="D2ZWMS" property="zwms" jdbcType="VARCHAR"/>
        <result column="D2YWMS" property="ywms" jdbcType="VARCHAR"/>
    </association>
    <collection property="initDatas" ofType="com.eray.thjw.produce.po.InstallationListEffective2Init">  
	   	<id column="D_ID" property="id" jdbcType="VARCHAR" />
	    <result column="D_MAINID" property="mainid" jdbcType="VARCHAR" />
	    <result column="D_JKLBH" property="jklbh" jdbcType="VARCHAR" />
	    <result column="D_JKFLBH" property="jkflbh" jdbcType="VARCHAR" />
	    <result column="D_ZSSYY" property="zssyy" jdbcType="VARCHAR" />
	    <result column="D_ZJSYL" property="zjsyl" jdbcType="VARCHAR" />
	    <result column="D_CXSYY" property="cxsyy" jdbcType="VARCHAR" />
	    <result column="D_WHBMID" property="whbmid" jdbcType="VARCHAR" />
	    <result column="D_WHRID" property="whrid" jdbcType="VARCHAR" />
	    <result column="D_WHSJ" property="whsj" jdbcType="TIMESTAMP" />
    </collection>
  </resultMap>
  <sql id="Base_Column_List" >
    ID, DPRTCODE, JX, FJZCH, WZ, CJ, FJDID, BJH, XLH, PCH, ZJSL, LLKLX, LLKBH, FJZW, 
    CHUCRQ, TSN, TSO, CSN, CSO, BJGZJL, BZ, SKBS, SSBS, AZ_FXJLBID, AZSJ, AZJLDID, AZJLDH, 
    AZRID, AZR, AZBZ, CC_FXJLBID, CCSJ, CCJLDID, CCJLDH, CCRID, CCR, CCBZ, CJ_ZSJJH, 
    CJ_ZSJXLH, ZJZT, YXBS, WHBMID, WHRID, WHSJ, ZJJLX, ZWMC, YWMC, CQID, KCCB, BIZ
  </sql>
  <sql id="Detail_Column_List" >
    B1.ID, B1.DPRTCODE, B1.JX, B1.FJZCH, B1.WZ, B1.CJ, B1.FJDID, B1.BJH, B1.XLH, B1.PCH, 
    B1.ZJSL, B1.LLKLX, B1.LLKBH, B1.FJZW, B1.CHUCRQ, B1.TSN, B1.TSO, B1.CSN, B1.CSO, B1.BJGZJL, 
    B1.BZ, B1.SKBS, B1.SSBS, B1.AZ_FXJLBID, B1.AZSJ, B1.AZJLDID, B1.AZJLDH, B1.AZRID, B1.AZR, 
    B1.AZBZ, B1.CC_FXJLBID, B1.CCSJ, B1.CCJLDID, B1.CCJLDH, B1.CCRID, B1.CCR, B1.CCBZ, B1.CJ_ZSJJH, 
    B1.CJ_ZSJXLH, B1.ZJZT, B1.YXBS, B1.WHBMID, B1.WHRID, B1.WHSJ, B1.ZJJLX, B1.ZWMC, 
    B1.YWMC, B1.CQID, B1.KCCB, B1.BIZ,
    D1.ID AS D1ID, D1.BJH AS D1BJH, D1.ZWMS AS D1ZWMS, D1.YWMS AS D1YWMS, D1.JLDW AS D1JLDW, 
    D1.CJJH AS D1CJJH, D1.ZJH AS D1ZJH, D1.HCJZ AS D1HCJZ, D1.GLJB AS D1GLJB, D1.SXKZ AS D1SXKZ, 
    D1.HCLX AS D1HCLX, D1.HCLX_EJ AS D1HCLX_EJ, D1.IS_MEL AS D1IS_MEL, D1.MIN_KCL AS D1MIN_KCL, 
    D1.MAX_KCL AS D1MAXKCL, D1.BZ AS D1BZ, D1.XH AS D1XH, D1.GG AS D1GG, D1.XINGH AS D1XINGH, D1.ZT AS D1ZT,
    D2.ZJH AS D2ZJH, D2.ZWMS AS D2ZWMS, D2.YWMS AS D2YWMS,
    PAR.ID AS PARID, PAR.BJH AS PARBJH, PAR.CJ AS PARCJ, PAR.WZ AS PARWZ
  </sql>
  <sql id="All_Column_List" >
    B1.ID, B1.DPRTCODE, B1.JX, B1.FJZCH, B1.WZ, B1.CJ, B1.FJDID, B1.BJH, D1.ZWMS AS D1ZWMS, D1.YWMS AS D1YWMS, 
    D1.CJJH AS D1CJJH, D1.XINGH AS D1XINGH, D1.ZJH, D1.JLDW AS D1JLDW, B1.XLH, B1.PCH, B1.ZJSL, B1.LLKLX, B1.LLKBH, B1.FJZW, 
    B1.CHUCRQ, B1.TSN, B1.TSO, B1.CSN, B1.CSO, B1.BJGZJL, B1.BZ, B1.SKBS, B1.SSBS, B1.AZ_FXJLBID, 
    B1.AZSJ, B1.AZJLDID, B1.AZJLDH, B1.AZRID, B1.AZR, B1.AZBZ, B1.CC_FXJLBID, B1.CCSJ, B1.CCJLDID, 
    B1.CCJLDH, B1.CCRID, B1.CCR, B1.CCBZ, B1.ZJZT, B1.WHBMID, B1.WHSJ, B1.ZJJLX, B1.ZWMC, 
    B1.YWMC, B1.CQID, B1.KCCB, B1.BIZ,
    D2.ZJH AS D2ZJH,D2.ZWMS AS D2ZWMS,D2.YWMS AS D2YWMS,
    U1.ID AS WHRID, U1.USERNAME AS WHRUSERNAME, U1.REALNAME AS WHRREALNAME,
    B2.ID AS D_ID, B2.JKLBH AS D_JKLBH, B2.JKFLBH AS D_JKFLBH, B2.ZSSYY AS D_ZSSYY,
    C1.ID AS C1ID, C1.JH AS C1JH, C1.XLH AS C1XLH, C1.PCH AS C1PCH, C1.ZSBH AS C1ZSBH, 
    C1.ZSCFWZ AS C1ZSCFWZ, C1.ZJLX AS C1ZJLX, C1.QSRQ AS C1QSRQ,
    P1.ID AS P1ID, P1.WZ AS P1WZ, P1.CJ AS P1CJ, P1.BJH AS P1BJH
  </sql>
  
  
   <select id="queryAllBj" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
	   SELECT SYS_GUID() KEY_, --KEY
	       BJLLXX.DPRTCODE, --机构代码
	       BJLLXX.BJH, --部件号
	       BJLLXX.XLH, --序列号
	       BJLLXX.CZRQ, --操作日期
	       BJLLXX.CZSJ, --操作时间
	       BJLLXX.CZLX, --操作类型：1装上、2拆下、5报废、10入库、11采购入库、12送修入库、13借用入库、14归还入库、20出库、21领用出库、22送修出库、23归还出库、24借调出库
	       BJLLXX.ZJQDID, --装机清单ID
	       BJLLXX.YWDJID, --业务单据ID
	       BJLLXX.YWDJBH, --业务单据编号
	       BJLLXX.CK_FJZCH, --仓库/飞机注册号
	       BJLLXX.KW_ZJWZ, --库位/装机位置
	       BJLLXX.FJDID, --父节点ID
	       BJLLXX.SJBJ, --上级部件
	       BJLLXX.CZZ, --操作者
	       BJLLXX.BJYYSJ, --部件已用：监控项目编号 + '#_#' + 部件使用量 + '#_#' + 在机使用量
	       BJLLXX.CZYY --拆装原因
	  FROM (
	         /* 1装上 */
        SELECT S2004.DPRTCODE,
                S2004.BJH,
                S2004.XLH,
                TO_CHAR(S2004.AZSJ, 'yyyy-mm-dd') CZRQ,
                S2004.AZSJ CZSJ,
                1 CZLX,
                S2004.ID ZJQDID,
                S2004.AZJLDID YWDJID,
                S2004.AZJLDH YWDJBH,
                S2004.FJZCH CK_FJZCH,
                (CASE
                  WHEN S2004.WZ = 21 THEN
                   '1#发件'
                  WHEN S2004.WZ = 22 THEN
                   '2#发件'
                  WHEN S2004.WZ = 23 THEN
                   '3#发件'
                  WHEN S2004.WZ = 24 THEN
                   '4#发件'
                  WHEN S2004.WZ = 31 THEN
                   'APU件'
                  ELSE
                   '机身件'
                END) KW_ZJWZ,
                S2004.FJDID,
                (S2004_F.BJH || ' ' || S2004_F.XLH) SJBJ,
                S2004.AZR CZZ,
                S200401.BJYYSJ,
                S2004.AZBZ CZYY
          FROM B_S2_004 S2004
          LEFT JOIN B_S2_004 S2004_F
            ON S2004.FJDID = S2004_F.ID
          LEFT JOIN (SELECT S200401.ZJQDID, MAX(S200401.BJYYSJ) BJYYSJ
                       FROM (SELECT S200401.MAINID ZJQDID,
                                    WM_CONCAT(S200401.JKLBH || '#_#' ||
                                              S200401.ZSSYY || '#_#' || '') OVER(PARTITION BY S200401.MAINID ORDER BY d00601.pxh) BJYYSJ
                               FROM B_S2_00401 S200401 left join d_00601  d00601 on d00601.JKLBH = S200401.JKLBH) S200401 
                      GROUP BY S200401.ZJQDID) S200401
            ON S200401.ZJQDID = S2004.ID
         WHERE 1 = 1
           AND S2004.YXBS = 1
           AND S2004.BJH = #{paramsMap.jh}
           AND S2004.XLH = #{paramsMap.xlh}
           AND S2004.DPRTCODE = #{paramsMap.dprtcode}
        UNION ALL
        /* 2、拆下 */
        SELECT S2004.DPRTCODE,
                S2004.BJH,
                S2004.XLH,
                TO_CHAR(S2004.CCSJ, 'yyyy-mm-dd') CZRQ,
                S2004.CCSJ CZSJ,
                S2004.ZJZT CZLX,
                S2004.ID ZJQDID,
                S2004.CCJLDID YWDJID,
                S2004.CCJLDH YWDJBH,
                S2004.FJZCH CK_FJZCH,
                (CASE
                  WHEN S2004.WZ = 21 THEN
                   '1#发件'
                  WHEN S2004.WZ = 22 THEN
                   '2#发件'
                  WHEN S2004.WZ = 23 THEN
                   '3#发件'
                  WHEN S2004.WZ = 24 THEN
                   '4#发件'
                  WHEN S2004.WZ = 31 THEN
                   'APU件'
                  ELSE
                   '机身件'
                END) KW_ZJWZ,
                S2004.FJDID,
                (S2004_F.BJH || ' ' || S2004_F.XLH) SJBJ,
                S2004.CCR CZZ,
                S200401.BJYYSJ,
                S2004.CCBZ CZYY
          FROM B_S2_004 S2004
          LEFT JOIN B_S2_004 S2004_F
            ON S2004.FJDID = S2004_F.ID
          LEFT JOIN (SELECT S200401.ZJQDID, MAX(S200401.BJYYSJ) BJYYSJ
                       FROM (SELECT S200401.MAINID ZJQDID,
                                    WM_CONCAT(S200401.JKLBH || '#_#' ||
                                              S200401.CXSYY || '#_#' ||
                                              S200401.ZJSYL) OVER(PARTITION BY S200401.MAINID ORDER BY d00601.pxh) BJYYSJ
                               FROM B_S2_00401 S200401 left join d_00601 d00601 on d00601.JKLBH = S200401.JKLBH) S200401
                      GROUP BY S200401.ZJQDID) S200401
            ON S200401.ZJQDID = S2004.ID
         WHERE 1 = 1
           AND S2004.YXBS = 1
           AND S2004.ZJZT = 2
           AND S2004.BJH = #{paramsMap.jh}
           AND S2004.XLH = #{paramsMap.xlh}
           AND S2004.DPRTCODE = #{paramsMap.dprtcode}
	        UNION ALL
	        <!-- /* 5、报废 */ -->
	        SELECT H017.DPRTCODE,
	                H017.BJH,
	                H017.SN XLH,
	                TO_CHAR(H009.SPSJ, 'yyyy-mm-dd') CZRQ,
	                H009.SPSJ CZSJ,
	                5 CZLX,
	                NULL ZJQDID,
	                H009.ID YWDJID,
	                H009.BFDH YWDJBH,
	                NULL CK_FJZCH,
	                NULL KW_ZJWZ,
	                NULL FJDID,
	                NULL SJBJ,
	                TUSER.USERNAME || ' ' || TUSER.REALNAME CZZ,
	                NULL BJYYSJ,
	                NULL CZYY
	          FROM B_H_017 H017
	          JOIN B_H_00901 H00901
	            ON H017.ID = H00901.KCLLID
	           AND H00901.ZT = 1
	           AND H017.DPRTCODE = #{paramsMap.dprtcode}
	           AND H017.BJH = #{paramsMap.jh}
	           AND H017.SN = #{paramsMap.xlh}
	          JOIN B_H_009 H009
	            ON H009.ID = H00901.MAINID
	           AND H009.ZT IN (3, 10)
	          LEFT JOIN T_USER TUSER
	            ON TUSER.ID = H009.BFRID
	        UNION ALL
	        <!-- /* 10入库 */ -->
	        SELECT H017.DPRTCODE,
	                H017.BJH,
	                H017.SN XLH,
	                TO_CHAR(H008NEW.RKRQ, 'yyyy-mm-dd') CZRQ,
	                H008NEW.ZDSJ CZSJ,
	                (CASE
	                  WHEN H008NEW.RKLX = 1 THEN
	                   11
	                  WHEN H008NEW.RKLX = 2 THEN
	                   12
	                  WHEN H008NEW.RKLX = 3 THEN
	                   13
	                  WHEN H008NEW.RKLX = 4 THEN
	                   14
	                  ELSE
	                   10
	                END) CZLX,
	                NULL ZJQDID,
	                H008NEW.ID YWDJID,
	                H008NEW.RKDH YWDJBH,
	                (H017.CKH || H017.CKMC) CK_FJZCH,
	                H017.KWH KW_ZJWZ,
	                NULL FJDID,
	                NULL SJBJ,
	                TUSER.USERNAME || ' ' || TUSER.REALNAME CZZ,
	                NULL BJYYSJ,
	                NULL CZYY
	          FROM B_H_017 H017
	          JOIN B_H_00801_NEW H00801NEW
	            ON H00801NEW.KCLLID = H017.ID
	           AND H00801NEW.ZT = 1
	           AND H017.DPRTCODE = #{paramsMap.dprtcode}
	           AND H017.BJH = #{paramsMap.jh}
	           AND H017.SN = #{paramsMap.xlh}
	          JOIN B_H_008_NEW H008NEW
	            ON H008NEW.ID = H00801NEW.MAINID
	           AND H008NEW.ZT IN (2, 10)
	          LEFT JOIN T_USER TUSER
	            ON TUSER.ID = H008NEW.ZDRID
	        UNION ALL
	        <!-- /* 20出库 */ -->
	        SELECT H017.DPRTCODE,
	                H017.BJH,
	                H017.SN XLH,
	                TO_CHAR(H013.CKSJ, 'yyyy-mm-dd') CZRQ,
	                H013.CKSJ CZSJ,
	                (CASE
	                  WHEN H013.CKLX = 1 THEN
	                   21
	                  WHEN H013.CKLX = 2 THEN
	                   22
	                  WHEN H013.CKLX = 3 THEN
	                   23
	                  WHEN H013.CKLX = 4 THEN
	                   24
	                  ELSE
	                   20
	                END) CZLX,
	                NULL ZJQDID,
	                H013.ID YWDJID,
	                H013.CKDH YWDJBH,
	                (H017.CKH || H017.CKMC) CK_FJZCH,
	                H017.KWH KW_ZJWZ,
	                NULL FJDID,
	                NULL SJBJ,
	                TUSER.USERNAME || ' ' || TUSER.REALNAME CZZ,
	                NULL BJYYSJ,
	                NULL CZYY
	          FROM B_H_017 H017
	          JOIN B_H_01301 H01301
	            ON H017.ID = H01301.KCLLID
	           AND H01301.ZT = 1
	           AND H017.DPRTCODE = #{paramsMap.dprtcode}
	           AND H017.BJH = #{paramsMap.jh}
	           AND H017.SN = #{paramsMap.xlh}
	          JOIN B_H_013 H013
	            ON H013.ID = H01301.MAINID
	           AND H013.CKLX &lt;&gt; 5
	           AND H013.ZT IN (2, 10)
	          LEFT JOIN T_USER TUSER
	            ON TUSER.ID = H013.CUKID) BJLLXX
	 WHERE 1 = 1
	 ORDER BY BJLLXX.CZRQ ASC, BJLLXX.CZSJ ASC
   
   </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from B_S2_004
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from B_S2_004
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    insert into B_S2_004 (ID, DPRTCODE, JX, 
      FJZCH, WZ, CJ, FJDID, 
      BJH, XLH, PCH, ZJSL, 
      LLKLX, LLKBH, FJZW, 
      CHUCRQ, TSN, TSO, 
      CSN, CSO, BJGZJL, BZ, 
      SKBS, SSBS, AZ_FXJLBID, 
      AZSJ, AZJLDID, AZJLDH, 
      AZRID, AZR, AZBZ, CC_FXJLBID, 
      CCSJ, CCJLDID, CCJLDH, 
      CCRID, CCR, CCBZ, CJ_ZSJJH, 
      CJ_ZSJXLH, ZJZT, YXBS, 
      WHBMID, WHRID, WHSJ
      )
    values (#{id,jdbcType=VARCHAR}, #{dprtcode,jdbcType=VARCHAR}, #{jx,jdbcType=VARCHAR}, 
      #{fjzch,jdbcType=VARCHAR}, #{wz,jdbcType=DECIMAL}, #{cj,jdbcType=DECIMAL}, #{fjdid,jdbcType=VARCHAR}, 
      #{bjh,jdbcType=VARCHAR}, #{xlh,jdbcType=VARCHAR}, #{pch,jdbcType=VARCHAR}, #{zjsl,jdbcType=DECIMAL}, 
      #{llklx,jdbcType=DECIMAL}, #{llkbh,jdbcType=VARCHAR}, #{fjzw,jdbcType=VARCHAR}, 
      #{chucrq,jdbcType=TIMESTAMP}, #{tsn,jdbcType=VARCHAR}, #{tso,jdbcType=VARCHAR}, 
      #{csn,jdbcType=DECIMAL}, #{cso,jdbcType=DECIMAL}, #{bjgzjl,jdbcType=VARCHAR}, #{bz,jdbcType=VARCHAR}, 
      #{skbs,jdbcType=DECIMAL}, #{ssbs,jdbcType=DECIMAL}, #{azFxjlbid,jdbcType=VARCHAR}, 
      #{azsj,jdbcType=TIMESTAMP}, #{azjldid,jdbcType=VARCHAR}, #{azjldh,jdbcType=VARCHAR}, 
      #{azrid,jdbcType=VARCHAR}, #{azr,jdbcType=VARCHAR}, #{azbz,jdbcType=VARCHAR}, #{ccFxjlbid,jdbcType=VARCHAR}, 
      #{ccsj,jdbcType=TIMESTAMP}, #{ccjldid,jdbcType=VARCHAR}, #{ccjldh,jdbcType=VARCHAR}, 
      #{ccrid,jdbcType=VARCHAR}, #{ccr,jdbcType=VARCHAR}, #{ccbz,jdbcType=VARCHAR}, #{cjZsjjh,jdbcType=VARCHAR}, 
      #{cjZsjxlh,jdbcType=VARCHAR}, #{zjzt,jdbcType=DECIMAL}, #{yxbs,jdbcType=DECIMAL}, 
      #{whbmid,jdbcType=VARCHAR}, #{whrid,jdbcType=VARCHAR}, #{whsj,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    insert into B_S2_004
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="dprtcode != null" >
        DPRTCODE,
      </if>
      <if test="jx != null" >
        JX,
      </if>
      <if test="fjzch != null" >
        FJZCH,
      </if>
      <if test="wz != null" >
        WZ,
      </if>
      <if test="cj != null" >
        CJ,
      </if>
      <if test="fjdid != null" >
        FJDID,
      </if>
      <if test="bjh != null" >
        BJH,
      </if>
      <if test="xlh != null" >
        XLH,
      </if>
      <if test="pch != null" >
        PCH,
      </if>
      <if test="zjsl != null" >
        ZJSL,
      </if>
      <if test="llklx != null" >
        LLKLX,
      </if>
      <if test="llkbh != null" >
        LLKBH,
      </if>
      <if test="fjzw != null" >
        FJZW,
      </if>
      <if test="chucrq != null" >
        CHUCRQ,
      </if>
      <if test="tsn != null" >
        TSN,
      </if>
      <if test="tso != null" >
        TSO,
      </if>
      <if test="csn != null" >
        CSN,
      </if>
      <if test="cso != null" >
        CSO,
      </if>
      <if test="bjgzjl != null" >
        BJGZJL,
      </if>
      <if test="bz != null" >
        BZ,
      </if>
      <if test="skbs != null" >
        SKBS,
      </if>
      <if test="ssbs != null" >
        SSBS,
      </if>
      <if test="azFxjlbid != null" >
        AZ_FXJLBID,
      </if>
      <if test="azsj != null" >
        AZSJ,
      </if>
      <if test="azjldid != null" >
        AZJLDID,
      </if>
      <if test="azjldh != null" >
        AZJLDH,
      </if>
      <if test="azrid != null" >
        AZRID,
      </if>
      <if test="azr != null" >
        AZR,
      </if>
      <if test="azbz != null" >
        AZBZ,
      </if>
      <if test="ccFxjlbid != null" >
        CC_FXJLBID,
      </if>
      <if test="ccsj != null" >
        CCSJ,
      </if>
      <if test="ccjldid != null" >
        CCJLDID,
      </if>
      <if test="ccjldh != null" >
        CCJLDH,
      </if>
      <if test="ccrid != null" >
        CCRID,
      </if>
      <if test="ccr != null" >
        CCR,
      </if>
      <if test="ccbz != null" >
        CCBZ,
      </if>
      <if test="cjZsjjh != null" >
        CJ_ZSJJH,
      </if>
      <if test="cjZsjxlh != null" >
        CJ_ZSJXLH,
      </if>
      <if test="zjzt != null" >
        ZJZT,
      </if>
      <if test="yxbs != null" >
        YXBS,
      </if>
      <if test="whbmid != null" >
        WHBMID,
      </if>
      <if test="whrid != null" >
        WHRID,
      </if>
      <if test="whsj != null" >
        WHSJ,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="dprtcode != null" >
        #{dprtcode,jdbcType=VARCHAR},
      </if>
      <if test="jx != null" >
        #{jx,jdbcType=VARCHAR},
      </if>
      <if test="fjzch != null" >
        #{fjzch,jdbcType=VARCHAR},
      </if>
      <if test="wz != null" >
        #{wz,jdbcType=DECIMAL},
      </if>
      <if test="cj != null" >
        #{cj,jdbcType=DECIMAL},
      </if>
      <if test="fjdid != null" >
        #{fjdid,jdbcType=VARCHAR},
      </if>
      <if test="bjh != null" >
        #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="xlh != null" >
        #{xlh,jdbcType=VARCHAR},
      </if>
      <if test="pch != null" >
        #{pch,jdbcType=VARCHAR},
      </if>
      <if test="zjsl != null" >
        #{zjsl,jdbcType=DECIMAL},
      </if>
      <if test="llklx != null" >
        #{llklx,jdbcType=DECIMAL},
      </if>
      <if test="llkbh != null" >
        #{llkbh,jdbcType=VARCHAR},
      </if>
      <if test="fjzw != null" >
        #{fjzw,jdbcType=VARCHAR},
      </if>
      <if test="chucrq != null" >
        #{chucrq,jdbcType=TIMESTAMP},
      </if>
      <if test="tsn != null" >
        #{tsn,jdbcType=VARCHAR},
      </if>
      <if test="tso != null" >
        #{tso,jdbcType=VARCHAR},
      </if>
      <if test="csn != null" >
        #{csn,jdbcType=DECIMAL},
      </if>
      <if test="cso != null" >
        #{cso,jdbcType=DECIMAL},
      </if>
      <if test="bjgzjl != null" >
        #{bjgzjl,jdbcType=VARCHAR},
      </if>
      <if test="bz != null" >
        #{bz,jdbcType=VARCHAR},
      </if>
      <if test="skbs != null" >
        #{skbs,jdbcType=DECIMAL},
      </if>
      <if test="ssbs != null" >
        #{ssbs,jdbcType=DECIMAL},
      </if>
      <if test="azFxjlbid != null" >
        #{azFxjlbid,jdbcType=VARCHAR},
      </if>
      <if test="azsj != null" >
        #{azsj,jdbcType=TIMESTAMP},
      </if>
      <if test="azjldid != null" >
        #{azjldid,jdbcType=VARCHAR},
      </if>
      <if test="azjldh != null" >
        #{azjldh,jdbcType=VARCHAR},
      </if>
      <if test="azrid != null" >
        #{azrid,jdbcType=VARCHAR},
      </if>
      <if test="azr != null" >
        #{azr,jdbcType=VARCHAR},
      </if>
      <if test="azbz != null" >
        #{azbz,jdbcType=VARCHAR},
      </if>
      <if test="ccFxjlbid != null" >
        #{ccFxjlbid,jdbcType=VARCHAR},
      </if>
      <if test="ccsj != null" >
        #{ccsj,jdbcType=TIMESTAMP},
      </if>
      <if test="ccjldid != null" >
        #{ccjldid,jdbcType=VARCHAR},
      </if>
      <if test="ccjldh != null" >
        #{ccjldh,jdbcType=VARCHAR},
      </if>
      <if test="ccrid != null" >
        #{ccrid,jdbcType=VARCHAR},
      </if>
      <if test="ccr != null" >
        #{ccr,jdbcType=VARCHAR},
      </if>
      <if test="ccbz != null" >
        #{ccbz,jdbcType=VARCHAR},
      </if>
      <if test="cjZsjjh != null" >
        #{cjZsjjh,jdbcType=VARCHAR},
      </if>
      <if test="cjZsjxlh != null" >
        #{cjZsjxlh,jdbcType=VARCHAR},
      </if>
      <if test="zjzt != null" >
        #{zjzt,jdbcType=DECIMAL},
      </if>
      <if test="yxbs != null" >
        #{yxbs,jdbcType=DECIMAL},
      </if>
      <if test="whbmid != null" >
        #{whbmid,jdbcType=VARCHAR},
      </if>
      <if test="whrid != null" >
        #{whrid,jdbcType=VARCHAR},
      </if>
      <if test="whsj != null" >
        #{whsj,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    update B_S2_004
    <set >
      <if test="dprtcode != null" >
        DPRTCODE = #{dprtcode,jdbcType=VARCHAR},
      </if>
      <if test="jx != null" >
        JX = #{jx,jdbcType=VARCHAR},
      </if>
      <if test="fjzch != null" >
        FJZCH = #{fjzch,jdbcType=VARCHAR},
      </if>
      <if test="wz != null" >
        WZ = #{wz,jdbcType=DECIMAL},
      </if>
      <if test="cj != null" >
        CJ = #{cj,jdbcType=DECIMAL},
      </if>
      <if test="fjdid != null" >
        FJDID = #{fjdid,jdbcType=VARCHAR},
      </if>
      <if test="bjh != null" >
        BJH = #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="xlh != null" >
        XLH = #{xlh,jdbcType=VARCHAR},
      </if>
      <if test="pch != null" >
        PCH = #{pch,jdbcType=VARCHAR},
      </if>
      <if test="zjsl != null" >
        ZJSL = #{zjsl,jdbcType=DECIMAL},
      </if>
      <if test="llklx != null" >
        LLKLX = #{llklx,jdbcType=DECIMAL},
      </if>
      <if test="llkbh != null" >
        LLKBH = #{llkbh,jdbcType=VARCHAR},
      </if>
      <if test="fjzw != null" >
        FJZW = #{fjzw,jdbcType=VARCHAR},
      </if>
      <if test="chucrq != null" >
        CHUCRQ = #{chucrq,jdbcType=TIMESTAMP},
      </if>
      <if test="tsn != null" >
        TSN = #{tsn,jdbcType=VARCHAR},
      </if>
      <if test="tso != null" >
        TSO = #{tso,jdbcType=VARCHAR},
      </if>
      <if test="csn != null" >
        CSN = #{csn,jdbcType=DECIMAL},
      </if>
      <if test="cso != null" >
        CSO = #{cso,jdbcType=DECIMAL},
      </if>
      <if test="bjgzjl != null" >
        BJGZJL = #{bjgzjl,jdbcType=VARCHAR},
      </if>
      <if test="bz != null" >
        BZ = #{bz,jdbcType=VARCHAR},
      </if>
      <if test="skbs != null" >
        SKBS = #{skbs,jdbcType=DECIMAL},
      </if>
      <if test="ssbs != null" >
        SSBS = #{ssbs,jdbcType=DECIMAL},
      </if>
      <if test="azFxjlbid != null" >
        AZ_FXJLBID = #{azFxjlbid,jdbcType=VARCHAR},
      </if>
      <if test="azsj != null" >
        AZSJ = #{azsj,jdbcType=TIMESTAMP},
      </if>
      <if test="azjldid != null" >
        AZJLDID = #{azjldid,jdbcType=VARCHAR},
      </if>
      <if test="azjldh != null" >
        AZJLDH = #{azjldh,jdbcType=VARCHAR},
      </if>
      <if test="azrid != null" >
        AZRID = #{azrid,jdbcType=VARCHAR},
      </if>
      <if test="azr != null" >
        AZR = #{azr,jdbcType=VARCHAR},
      </if>
      <if test="azbz != null" >
        AZBZ = #{azbz,jdbcType=VARCHAR},
      </if>
      <if test="ccFxjlbid != null" >
        CC_FXJLBID = #{ccFxjlbid,jdbcType=VARCHAR},
      </if>
      <if test="ccsj != null" >
        CCSJ = #{ccsj,jdbcType=TIMESTAMP},
      </if>
      <if test="ccjldid != null" >
        CCJLDID = #{ccjldid,jdbcType=VARCHAR},
      </if>
      <if test="ccjldh != null" >
        CCJLDH = #{ccjldh,jdbcType=VARCHAR},
      </if>
      <if test="ccrid != null" >
        CCRID = #{ccrid,jdbcType=VARCHAR},
      </if>
      <if test="ccr != null" >
        CCR = #{ccr,jdbcType=VARCHAR},
      </if>
      <if test="ccbz != null" >
        CCBZ = #{ccbz,jdbcType=VARCHAR},
      </if>
      <if test="cjZsjjh != null" >
        CJ_ZSJJH = #{cjZsjjh,jdbcType=VARCHAR},
      </if>
      <if test="cjZsjxlh != null" >
        CJ_ZSJXLH = #{cjZsjxlh,jdbcType=VARCHAR},
      </if>
      <if test="zjzt != null" >
        ZJZT = #{zjzt,jdbcType=DECIMAL},
      </if>
      <if test="yxbs != null" >
        YXBS = #{yxbs,jdbcType=DECIMAL},
      </if>
      <if test="whbmid != null" >
        WHBMID = #{whbmid,jdbcType=VARCHAR},
      </if>
      <if test="whrid != null" >
        WHRID = #{whrid,jdbcType=VARCHAR},
      </if>
      <if test="whsj != null" >
        WHSJ = #{whsj,jdbcType=TIMESTAMP},
      </if>
      <if test="zwmc != null" >
        ZWMC = #{zwmc,jdbcType=VARCHAR},
      </if>
      <if test="ywmc != null" >
        YWMC = #{ywmc,jdbcType=VARCHAR},
      </if>
      <if test="cqid != null" >
        CQID = #{cqid,jdbcType=VARCHAR},
      </if>
      <if test="kccb != null" >
        KCCB = #{kccb,jdbcType=DECIMAL},
      </if>
      <if test="biz != null" >
        BIZ = #{biz,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    update B_S2_004
    set DPRTCODE = #{dprtcode,jdbcType=VARCHAR},
      JX = #{jx,jdbcType=VARCHAR},
      FJZCH = #{fjzch,jdbcType=VARCHAR},
      WZ = #{wz,jdbcType=DECIMAL},
      CJ = #{cj,jdbcType=DECIMAL},
      FJDID = #{fjdid,jdbcType=VARCHAR},
      BJH = #{bjh,jdbcType=VARCHAR},
      XLH = #{xlh,jdbcType=VARCHAR},
      PCH = #{pch,jdbcType=VARCHAR},
      ZJSL = #{zjsl,jdbcType=DECIMAL},
      LLKLX = #{llklx,jdbcType=DECIMAL},
      LLKBH = #{llkbh,jdbcType=VARCHAR},
      FJZW = #{fjzw,jdbcType=VARCHAR},
      CHUCRQ = #{chucrq,jdbcType=TIMESTAMP},
      TSN = #{tsn,jdbcType=VARCHAR},
      TSO = #{tso,jdbcType=VARCHAR},
      CSN = #{csn,jdbcType=DECIMAL},
      CSO = #{cso,jdbcType=DECIMAL},
      BJGZJL = #{bjgzjl,jdbcType=VARCHAR},
      BZ = #{bz,jdbcType=VARCHAR},
      SKBS = #{skbs,jdbcType=DECIMAL},
      SSBS = #{ssbs,jdbcType=DECIMAL},
      AZ_FXJLBID = #{azFxjlbid,jdbcType=VARCHAR},
      AZSJ = #{azsj,jdbcType=TIMESTAMP},
      AZJLDID = #{azjldid,jdbcType=VARCHAR},
      AZJLDH = #{azjldh,jdbcType=VARCHAR},
      AZRID = #{azrid,jdbcType=VARCHAR},
      AZR = #{azr,jdbcType=VARCHAR},
      AZBZ = #{azbz,jdbcType=VARCHAR},
      CC_FXJLBID = #{ccFxjlbid,jdbcType=VARCHAR},
      CCSJ = #{ccsj,jdbcType=TIMESTAMP},
      CCJLDID = #{ccjldid,jdbcType=VARCHAR},
      CCJLDH = #{ccjldh,jdbcType=VARCHAR},
      CCRID = #{ccrid,jdbcType=VARCHAR},
      CCR = #{ccr,jdbcType=VARCHAR},
      CCBZ = #{ccbz,jdbcType=VARCHAR},
      CJ_ZSJJH = #{cjZsjjh,jdbcType=VARCHAR},
      CJ_ZSJXLH = #{cjZsjxlh,jdbcType=VARCHAR},
      ZJZT = #{zjzt,jdbcType=DECIMAL},
      YXBS = #{yxbs,jdbcType=DECIMAL},
      WHBMID = #{whbmid,jdbcType=VARCHAR},
      WHRID = #{whrid,jdbcType=VARCHAR},
      WHSJ = #{whsj,jdbcType=TIMESTAMP}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- 通用查询条件 -->
  <sql id="Common_Param">
  	 WHERE 1=1 AND B1.YXBS = 1
  	 	<!-- 拆下 -->
  	 	<if test="zjzt != null and zjzt != 0 ">
        	AND  B1.zjzt = #{zjzt,jdbcType=DECIMAL}
        </if>
  	 	<!-- 飞机注册号 -->
  	 	<if test="fjzch != null and fjzch != ''">
        	AND  B1.FJZCH = #{fjzch,jdbcType=VARCHAR}
        </if>
        <!-- 组织机构-->
	    <if test="dprtcode != null and dprtcode != ''">
            AND  B1.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
        </if>
        <!-- 位置-->
	    <if test="wz != null">
            AND  B1.WZ = #{wz,jdbcType=DECIMAL}
        </if>
        <!-- 父节点id-->
	    <if test="fjdid != null and fjdid != ''">
            AND  B1.FJDID = #{fjdid,jdbcType=VARCHAR}
        </if>
        <!-- 装机件类型-->
	    <if test="zjjlx != null and zjjlx != ''">
            AND  B1.ZJJLX = #{zjjlx,jdbcType=VARCHAR}
        </if>
        <if test="paramsMap != null and paramsMap.otherZjjlx != null and paramsMap.otherZjjlx.size > 0">
            AND  (B1.ZJJLX NOT IN
            <foreach collection="paramsMap.otherZjjlx" item="item" index="index" open="(" close=")" separator=",">
			#{item}
		    </foreach>
		    OR B1.ZJJLX IS NULL)
        </if>
        <!-- 装机状态-->
	    <if test="zjzt != null">
            AND  B1.ZJZT = #{zjzt,jdbcType=DECIMAL}
        </if>
        <!-- 关键字-->
        <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
        	AND  (
        	      UPPER(D2.ZJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
        		  UPPER(D2.YWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
        		  UPPER(B1.BJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
          	      UPPER(B1.XLH) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
          	      UPPER(D1.ZWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
          	      UPPER(D1.YWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') OR
          	      UPPER(B1.AZJLDH) LIKE UPPER('%'||#{paramsMap.keyword}||'%')
          	)
       </if>
       <!-- 父节点关键字-->
        <if test="paramsMap != null and paramsMap.fjdKeyword != null and paramsMap.fjdKeyword != ''">
        	AND  (
        	      UPPER(D2.ZJH) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%') OR
        		  UPPER(D2.YWMS) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%') OR
        		  UPPER(B1.BJH) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%') OR
          	      UPPER(B1.XLH) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%') OR
          	      UPPER(D1.ZWMS) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%') OR
          	      UPPER(D1.YWMS) LIKE UPPER('%'||#{paramsMap.fjdKeyword}||'%')
          	)
       </if>
       <!-- 拆下件查询关键字-->
       <if test="paramsMap != null and paramsMap.cxKeyword != null and paramsMap.cxKeyword != ''">
        	AND  (
        	      UPPER(B1.BJH) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%') OR
          	      UPPER(B1.XLH) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%') OR
          	      UPPER(D1.ZWMS) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%') OR
          	      UPPER(D1.YWMS) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%') OR
          	      UPPER(D1.XINGH) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%') OR
          	      UPPER(D1.CJJH) LIKE UPPER('%'||#{paramsMap.cxKeyword}||'%')
          	)
       </if>
       <!-- 不属于该父节点-->
        <if test="paramsMap != null and paramsMap.notParentId != null and paramsMap.notParentId != ''">
        	AND  B1.ID != #{paramsMap.notParentId}
        	AND  B1.FJDID != #{paramsMap.notParentId}
       </if>
       <!-- 控制类型-->
       <if test="paramsMap != null and paramsMap.kzlxList != null">
        	<if test="paramsMap.kzlxList.size > 0">
			    AND
	   			<foreach item="item" index="index" collection="paramsMap.kzlxList" open="(" separator=" or " close=")">  
	   				<if test="item == 1">
	   					B1.SKBS = 1
	   				</if>
	   				<if test="item == 2">
	   					B1.SSBS = 1
	   				</if>
	   				<if test="item == 3">
	   					(B1.SKBS = 0 AND B1.SSBS = 0)
	   				</if>
	   			</foreach>  
   	   		</if>
   	   		<if test="paramsMap.kzlxList.size == 0">
			    AND 1 = 0
   	   		</if>
       </if>
       <!-- 计算时间-->
       <if test="jssj != null">
        	AND #{jssj,jdbcType=TIMESTAMP} &gt;
        	  COALESCE(B1.AZSJ, TO_DATE('17900101000000', 'YYYYMMDDHH24MISS'))
            AND #{jssj,jdbcType=TIMESTAMP} &lt;
              COALESCE(B1.CCSJ, TO_DATE('9999-12-31 23:59:00', 'YYYY-MM-DD HH24:MI:SS'))
       </if>
  </sql>
  
  <!-- 查询装机清单-生效区的数据集合 -->
  <select id="queryList" resultMap="DetailResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    SELECT 
    <include refid="Detail_Column_List" />, DPRT.DPRTNAME
    ,U1.ID AS UWHRID
    ,U1.USERNAME AS WHRUSERNAME
    ,U1.REALNAME AS WHRREALNAME
    ,(SELECT 1 FROM B_H2_024 C1
	         WHERE CASE WHEN B1.XLH IS NULL THEN '-' ELSE B1.XLH END = C1.XLH 
			   AND CASE WHEN B1.PCH IS NULL OR B1.XLH IS NOT NULL THEN '-' ELSE B1.PCH END = C1.PCH
			   AND CASE WHEN B1.XLH IS NOT NULL THEN '-' ELSE C1.PCH END = C1.PCH
			   AND B1.BJH = C1.JH
		       AND B1.DPRTCODE = C1.DPRTCODE
		       AND C1.ZT = 1
	           AND ROWNUM = 1) CERTIFICATECOUNT
    FROM B_S2_004 B1
    LEFT JOIN D_008 D1 ON B1.BJH = D1.BJH AND B1.DPRTCODE = D1.DPRTCODE AND D1.ZT = 1
    LEFT JOIN D_005 D2 ON D1.ZJH = D2.ZJH AND D1.DPRTCODE = D2.DPRTCODE AND D2.ZT = 1
    LEFT JOIN B_S2_004 PAR ON B1.FJDID = PAR.ID
    LEFT JOIN T_USER U1 ON B1.WHRID = U1.ID
    LEFT JOIN T_DEPARTMENT DPRT ON B1.DPRTCODE = DPRT.ID
    <include refid="Common_Param" />
    <choose>
	 	<when test='pagination.sort == "auto"'>
	 		ORDER BY B1.WZ, B1.CJ, B1.BJH,B1.ID
	 	</when>
	 	<otherwise>
		    ORDER BY B1.${pagination.sort} ${pagination.order}
	 	</otherwise>
 	</choose>	
  </select>
  
  <!-- 查询装机清单详情 -->
  <select id="queryDetail" resultMap="DetailResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
    SELECT 
    <include refid="All_Column_List" />
    FROM B_S2_004 B1
    LEFT JOIN D_008 D1 ON B1.BJH = D1.BJH AND B1.DPRTCODE = D1.DPRTCODE AND D1.ZT = 1
    LEFT JOIN D_005 D2 ON D1.ZJH = D2.ZJH AND D1.DPRTCODE = D2.DPRTCODE AND D2.ZT = 1
    LEFT JOIN T_USER U1 ON B1.WHRID = U1.ID
    LEFT JOIN B_S2_00401 B2 ON B1.ID = B2.MAINID
    LEFT JOIN B_S2_004 P1 ON B1.FJDID = P1.ID
    LEFT JOIN B_H2_024 C1 ON 
    	  CASE WHEN B1.XLH IS NULL THEN '-' ELSE B1.XLH END = C1.XLH 
      AND CASE WHEN B1.PCH IS NULL OR B1.XLH IS NOT NULL THEN '-' ELSE B1.PCH END = C1.PCH
      AND CASE WHEN B1.XLH IS NOT NULL THEN '-' ELSE C1.PCH END = C1.PCH
      AND B1.BJH = C1.JH
      AND B1.DPRTCODE = C1.DPRTCODE
      AND C1.ZT = 1
    WHERE B1.ID = #{id,jdbcType=VARCHAR}
  </select>
  
   <!-- 查询部件拆装记录列表数据-->
 <!--  <select id="queryComponentiohistoryList" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
	   select s2004.id zjqdid, 装机清单id
	       s2004.dprtcode, 组织机构
	       s2004.bjh, 部件号
	       s2004.xlh, 序列号
	       d008.zwms bjzwms, 部件中文名称
	       d008.ywms bjywms, 部件英文名称
	       d008.cjjh, 厂家件号
	       d008.zjh, 章节号
	       d005.zwms zjhzwms, 章节号中文名称
	       d005.ywms zjhywms, 章节号英文名称
	       s2004.fjzch, 飞机注册号
	       d007.xlh msn, 飞机MSN
	       s2004.azsj, 安装时间
	       s2008_zs.id azjldid, 安装记录单id（135工单id）
	       COALESCE(s2008_zs.gdbh, s2004.azjldh) azjldh, 安装记录单号
	       s2004.azr, 安装人
	       s2004.azbz, 安装备注（安装原因）
	       s2004.ccsj, 拆下时间
	       s2008_cx.id ccjldid, 拆下记录单id（135工单id）
	       COALESCE(s2008_cx.gdbh, s2004.ccjldh) ccjldh, 拆下记录单号
	       s2004.ccr, 拆下人
	       s2004.ccbz, 拆下备注（拆下原因）
	       s2004.cj_zsjjh, 对应装上件号
	       s2004.cj_zsjxlh, 对应装上件序列号
	       s200401.zjyysj, 装机已用数据：监控项目编号 #_# 装上时已用 #_# 在机使用量 #_# 拆下时已用 , 监控项目编号 #_# 装上时已用 #_# 在机使用量 #_# 拆下时已用 , ......
	       AZ_FJ.ATTACHCOUNT azfjCount,
	       CC_FJ.ATTACHCOUNT ccfjCount
	  from b_s2_004 s2004
	  left join d_008 d008
	    on s2004.dprtcode = d008.dprtcode
	   and s2004.bjh = d008.bjh
	  left join d_005 d005
	    on d008.dprtcode = d005.dprtcode
	   and d008.zjh = d005.zjh
	  left join d_007 d007
	    on s2004.dprtcode = d007.dprtcode
	   and s2004.fjzch = d007.fjzch
	  left join b_s2_008 s2008_zs
	    on s2008_zs.id = s2004.azjldid
	  left join b_s2_008 s2008_cx
	    on s2008_cx.id = s2004.ccjldid
	  left join (select s200401.zjqdid, max(s200401.zjyysj) zjyysj
	               from (select s200401.mainid zjqdid,
	                            wm_concat(s200401.jklbh || '#_#' || s200401.zssyy ||
	                                      '#_#' || s200401.zjsyl || '#_#' ||
	                                      s200401.cxsyy) over(PARTITION BY s200401.mainid order by s200401.jklbh) zjyysj
	                       from b_s2_00401 s200401) s200401
	              group by s200401.zjqdid
	             
	             ) s200401
	    on s2004.id = s200401.zjqdid
	    
	     装上附件数量   
	 LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) AZ_FJ
         ON AZ_FJ.MAINID = s2004.azjldid
	     拆下附件数量   
	 LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) CC_FJ
         ON CC_FJ.MAINID = s2004.ccjldid
	 where 1 = 1 and s2004.dprtcode =#{dprtcode,jdbcType=VARCHAR} and s2004.fjzch = #{fjzch,jdbcType=VARCHAR}
	  <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
	   and (s2004.bjh like '%'||#{paramsMap.keyword}||'%'
	   		or s2004.xlh like '%'||#{paramsMap.keyword}||'%'
	   		or d008.zwms like '%'||#{paramsMap.keyword}||'%'
	   		or d008.ywms like '%'||#{paramsMap.keyword}||'%'
	   		or d008.zjh like '%'||#{paramsMap.keyword}||'%')
	 </if> 
	 查询条件 
	<choose>                                                                                 
	   	<when test='pagination.sort == "auto"'>                       
	   		order by bjh,xlh,azsj desc
	   		
	   	</when>
	   	<otherwise>
		    order by ${pagination.sort} ${pagination.order}
	   	</otherwise>
	 </choose> 
	
  </select> -->
  
   <select id="queryComponentiohistoryList" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
  	select czjl.zjqdid, --装机清单id
       czjl.dprtcode, --组织机构
       czjl.bjh, --部件号
       czjl.xlh, --序列号
       czjl.bjzwms, --部件中文名称
       czjl.bjywms, --部件英文名称
       czjl.cjjh, --厂家件号
       czjl.zjh, --章节号
       czjl.zjhzwms, --章节号中文名称
       czjl.zjhywms, --章节号英文名称
       czjl.fjzch, --飞机注册号
       d007.xlh msn, --飞机MSN
       czjl.azsj, --安装时间
       czjl.azjldid, --安装记录单id（135工单id）
       czjl.azjldh, --安装记录单号
       czjl.azr, --安装人
       czjl.azbz, --安装备注（安装原因）
       czjl.ccsj, --拆下时间
       czjl.ccjldid, --拆下记录单id（135工单id）
       czjl.ccjldh, --拆下记录单号
       czjl.ccr, --拆下人
       czjl.ccbz, --拆下备注（拆下原因）
       czjl.cj_zsjjh, --对应装上件号
       czjl.cj_zsjxlh, --对应装上件序列号
       czjl.zjyysj, --装机已用数据：监控项目编号 #_# 装上时已用 #_# 在机使用量 #_# 拆下时已用 , 监控项目编号 #_# 装上时已用 #_# 在机使用量 #_# 拆下时已用 , ......
       czjl.pch, --批次号
       czjl.zjsl, --装机数量
       czjl.jldw , --单位
       czjl.fjzw, --飞机站位
       czjl.zjjlx, --装机件类型
       czjl.drbs, --导入标识：0非导入、1导入
       AZ_FJ.ATTACHCOUNT azfjCount,
	   CC_FJ.ATTACHCOUNT ccfjCount
  from (select s2004.id zjqdid,
               s2004.dprtcode,
               s2004.bjh,
               s2004.xlh,
               s2004.zwmc bjzwms,
               s2004.ywmc bjywms,
               d008.cjjh,
               d008.zjh,
               d005.zwms zjhzwms,
               d005.ywms zjhywms,
               s2004.fjzch,
               s2004.azsj,
               s2008_zs.id azjldid,
               COALESCE(s2008_zs.gdbh, s2004.azjldh) azjldh,
               s2004.azr,
               s2004.azbz,
               s2004.ccsj,
               s2008_cx.id ccjldid,
               COALESCE(s2008_cx.gdbh, s2004.ccjldh) ccjldh,
               s2004.ccr,
               s2004.ccbz,
               s2004.cj_zsjjh,
               s2004.cj_zsjxlh,
               s200401.zjyysj,
               s2004.pch,
               s2004.zjsl,
               d008.jldw,
               s2004.fjzw,
               s2004.zjjlx,
               0 drbs
          from b_s2_004 s2004 
          left join d_008 d008
            on s2004.dprtcode = d008.dprtcode
           and s2004.bjh = d008.bjh
          left join d_005 d005
            on d008.dprtcode = d005.dprtcode
           and d008.zjh = d005.zjh
          left join b_s2_008 s2008_zs
            on s2008_zs.id = s2004.azjldid
          left join b_s2_008 s2008_cx
            on s2008_cx.id = s2004.ccjldid
          left join (select s200401.zjqdid, max(s200401.zjyysj) zjyysj
                      from (select s200401.mainid zjqdid,
                                   wm_concat(s200401.jklbh || '#_#' ||
                                             s200401.zssyy || '#_#' ||
                                             s200401.zjsyl || '#_#' ||
                                             s200401.cxsyy) over(PARTITION BY s200401.mainid  order by d00601.pxh) zjyysj
                              from b_s2_00401 s200401
                              left join d_00601 d00601 on s200401.jklbh = d00601.jklbh) s200401
                     group by s200401.zjqdid
                    
                    ) s200401
            on s2004.id = s200401.zjqdid
   
		 where 1 = 1 and s2004.yxbs = 1
	 and s2004.dprtcode =#{dprtcode,jdbcType=VARCHAR}  
	  <if test="fjzch != null and fjzch != ''">
	 and s2004.fjzch = #{fjzch,jdbcType=VARCHAR}
	 </if>
	  <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
	   and (
	        UPPER(s2004.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(s2004.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(d008.zwms) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(d008.ywms) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(d008.zjh) like UPPER('%'||#{paramsMap.keyword}||'%'))
	 </if> 
	 <!-- 装上时间-->
     <if test="paramsMap != null and paramsMap.azsjBegin != null and paramsMap.azsjBegin != ''">
     	AND  TRUNC(s2004.azsj) &gt;= TO_DATE(#{paramsMap.azsjBegin}, 'YYYY-MM-DD')
     </if>
     <if test="paramsMap != null and paramsMap.azsjEnd != null and paramsMap.azsjEnd != ''">
     	AND  TRUNC(s2004.azsj) &lt;= TO_DATE(#{paramsMap.azsjEnd}, 'YYYY-MM-DD')
     </if>
     <!-- 拆下时间-->
     <if test="paramsMap != null and paramsMap.ccsjBegin != null and paramsMap.ccsjBegin != ''">
     	AND  TRUNC(s2004.ccsj) &gt;= TO_DATE(#{paramsMap.ccsjBegin}, 'YYYY-MM-DD')
     </if>
     <if test="paramsMap != null and paramsMap.ccsjEnd != null and paramsMap.ccsjEnd != ''">
     	AND  TRUNC(s2004.ccsj) &lt;= TO_DATE(#{paramsMap.ccsjEnd}, 'YYYY-MM-DD')
     </if>
        union all
        select s2005.id zjqdid,
               s2005.dprtcode,
               s2005.bjh,
               s2005.xlh,
               s2005.bjmc bjzwms,
               '' bjywms,
               s2005.cjjh,
               s2005.zjh,
               '' zjhzwms,
               '' zjhywms,
               s2005.fjzch,
               s2005.azsj,
               '' azjldid,
               s2005.azjldh,
               s2005.azr,
               s2005.azbz,
               s2005.ccsj,
               '' ccjldid,
               s2005.ccjldh,
               s2005.ccr,
               s2005.ccbz,
               s2005.cj_zsjj cj_zsjjh,
               '' cj_zsjxlh,
               '' zjyysj,
               s2005.pch,
               s2005.zjsl,
               s2005.jldw,
               s2005.fjzw,
               s2005.zjjlx,
               1 drbs
          from b_s2_005 s2005
          where 1 = 1 
		 and s2005.dprtcode =#{dprtcode,jdbcType=VARCHAR} 
		   <if test="fjzch != null and fjzch != ''">
		 and s2005.fjzch = #{fjzch,jdbcType=VARCHAR}
		 </if>
		
	  <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
	   and (UPPER(s2005.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(s2005.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
	   		or UPPER(s2005.zjh) like UPPER('%'||#{paramsMap.keyword}||'%'))
	 </if>
	 <!-- 装上时间-->
     <if test="paramsMap != null and paramsMap.azsjBegin != null and paramsMap.azsjBegin != ''">
     	AND  TRUNC(s2005.azsj) &gt;= TO_DATE(#{paramsMap.azsjBegin}, 'YYYY-MM-DD')
     </if>
     <if test="paramsMap != null and paramsMap.azsjEnd != null and paramsMap.azsjEnd != ''">
     	AND  TRUNC(s2005.azsj) &lt;= TO_DATE(#{paramsMap.azsjEnd}, 'YYYY-MM-DD')
     </if>
     <!-- 拆下时间-->
     <if test="paramsMap != null and paramsMap.ccsjBegin != null and paramsMap.ccsjBegin != ''">
     	AND  TRUNC(s2005.ccsj) &gt;= TO_DATE(#{paramsMap.ccsjBegin}, 'YYYY-MM-DD')
     </if>
     <if test="paramsMap != null and paramsMap.ccsjEnd != null and paramsMap.ccsjEnd != ''">
     	AND  TRUNC(s2005.ccsj) &lt;= TO_DATE(#{paramsMap.ccsjEnd}, 'YYYY-MM-DD')
     </if> 
        <!-- /* 查询条件 */ -->
        ) czjl
	  left join d_007 d007
	    on czjl.dprtcode = d007.dprtcode
	   and czjl.fjzch = d007.fjzch
     <!--  装上附件数量 -->   
	 LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) AZ_FJ
         ON AZ_FJ.MAINID = czjl.azjldid
	 <!--  拆下附件数量 -->   
	 LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) CC_FJ
         ON CC_FJ.MAINID = czjl.ccjldid
         where 1 = 1
        <choose>                                                                 
	    	<when test='paramsMap.userType!=null and paramsMap.userType == "admin"'>                       
	    		 AND exists 
	    		( SELECT 1 from D_007 where 
	    		czjl.fjzch = FJZCH
	    		AND czjl.dprtcode = DPRTCODE
	    		AND zt = 1
	    		)
	    	</when>
	    	<when test='paramsMap.userId!=null and paramsMap.userId != "" '>                       
	    		 AND exists 
	    		( SELECT 1 from V_ROLE_JX where 
	    		czjl.fjzch= FJZCH
	    		AND czjl.dprtcode = DPRTCODE
	    		AND USER_ID = #{paramsMap.userId,jdbcType=VARCHAR}
	    		)
	    	</when>
	   	</choose>
         
         <if test="drbs != null and  drbs != ''">
         and czjl.drbs = #{drbs}
         </if>
 	<choose>                                                                                 
	   	<when test='pagination.sort == "auto"'>                       
	   		order by bjh,xlh,azsj desc
	   		
	   	</when>
	   	<otherwise>
		    order by ${pagination.sort} ${pagination.order}
	   	</otherwise>
	 </choose> 
  
  
   </select>
  
  <select id="queryComponenthistoryList" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
	  	SELECT BJXX.DPRTCODE, --机构代码
	  	   BJXX.ID,		--id
	       BJXX.BJH, --部件号
	       BJXX.XLH, --序列号
	       BJXX.DQZT , --当前状态：1在机、2外场、3在库、4送修、5报废、6借出、7销售
	       BJXX.DQWZ , --当前位置
	       BJXX.CAL, --CAL
	       (BJXX.CS_TSN + BJXX.LJ_FXSJ) TSN, --TSN
	       (BJXX.CS_TSO + BJXX.LJ_FXSJ) TSO, --TSO
	       (BJXX.CS_CSN + BJXX.LJ_FXXH) CSN, --CSN
	       (BJXX.CS_CSO + BJXX.LJ_FXXH) CSO, --CSO
	       CASE WHEN DQZT IN (1,2,3) THEN BJXX.ZWMC ELSE D008.ZWMS END AS BJZWMS, --部件中文名称
	       CASE WHEN DQZT IN (1,2,3) THEN BJXX.YWMC ELSE D008.YWMS END AS BJYWMS, --部件英文名称
	       D008.CJJH, --厂家件号
	       D008.ZJH, --章节号
	       D008.JHLY, --件号来源
	       D005.ZWMS zjhzwms, --章节号中文名称
	       D005.YWMS zjhywms, --章节号英文名称
	        (SELECT 1 FROM B_H2_024 C1
	         WHERE CASE WHEN BJXX.XLH IS NULL THEN '-' ELSE BJXX.XLH END = C1.XLH 
			   AND CASE WHEN BJXX.XLH IS NOT NULL THEN '-' ELSE C1.PCH END = C1.PCH
			   AND BJXX.BJH = C1.JH
		       AND BJXX.DPRTCODE = C1.DPRTCODE
		       AND C1.ZT = 1
	           AND ROWNUM = 1) CERTIFICATECOUNT
	  FROM (SELECT BJXX.DPRTCODE,
	  			   BJXX.ID,
	               BJXX.BJH,
	               BJXX.XLH,
	               BJXX.ZWMC,
	               BJXX.YWMC,
	               BJXX.DQZT,
	               BJXX.DQWZ,
	               CASE
	                 WHEN H010.CHUCRQ IS NOT NULL THEN
	                   (SYSDATE - H010.CHUCRQ) 
	                 ELSE
	                  NULL
	               END CAL,
	               CAST(COALESCE(H010.TSN, '0') AS INTEGER) CS_TSN,
	               CAST(COALESCE(H010.TSO, '0') AS INTEGER) CS_TSO,
	               CAST(COALESCE(H010.CSN, 0) AS INTEGER) CS_CSN,
	               CAST(COALESCE(H010.CSO, 0) AS INTEGER) CS_CSO,
	               (SELECT COALESCE(SUM(T00601.FXSJ_FZ), 0)
	                  FROM B_S2_00601 T00601
	                  JOIN B_S2_006 T006
	                    ON T00601.MAINID = T006.ID
	                   AND T00601.ZT = 1
	                   AND T006.ZT IN (2, 12, 99)
	                   AND T006.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	                  JOIN B_S2_004 S2004
	                    ON S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	                   AND S2004.FJZCH = T006.FJZCH
	                   AND COALESCE(S2004.AZSJ,
	                                TO_DATE('17900101000000', 'YYYYMMDDHH24MISS')) &lt;=
	                       T00601.KCSJ
	                   AND COALESCE(S2004.CCSJ,
	                                TO_DATE('89991231235900', 'YYYYMMDDHH24MISS')) &gt;
	                       T00601.KCSJ
	                 WHERE 1 = 1
	                   AND BJXX.BJH = S2004.BJH
	                   AND BJXX.XLH = S2004.XLH
<!-- 	                   AND T00601.KCSJ >= H010.WHSJ -->
	                   ) LJ_FXSJ,
	               (SELECT COALESCE(SUM(T00601.FXXH), 0)
	                  FROM B_S2_00601 T00601
	                  JOIN B_S2_006 T006
	                    ON T00601.MAINID = T006.ID
	                   AND T00601.ZT = 1
	                   AND T006.ZT IN (2, 12, 99)
	                   AND T006.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	                  JOIN B_S2_004 S2004
	                    ON S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	                   AND S2004.FJZCH = T006.FJZCH
	                   AND COALESCE(S2004.AZSJ,
	                                TO_DATE('17900101000000', 'YYYYMMDDHH24MISS')) &lt;=
	                       T00601.KCSJ
	                   AND COALESCE(S2004.CCSJ,
	                                TO_DATE('89991231235900', 'YYYYMMDDHH24MISS'))  &gt;
	                       T00601.KCSJ
	                 WHERE 1 = 1
	                   AND BJXX.BJH = S2004.BJH
	                   AND BJXX.XLH = S2004.XLH
<!-- 	                   AND T00601.KCSJ >= H010.WHSJ -->
	                   ) LJ_FXXH
	          FROM (
	          
	          		<if test="fjzch != '-'.toString()">
	               <!--  /* 1、在机 */ -->
	                SELECT S2004.DPRTCODE,
	                		S2004.ID,
	                        S2004.BJH,
	                        S2004.XLH,
	                        1 DQZT,
	                        S2004.FJZCH || ' ' || (CASE
	                          WHEN S2004.WZ = 21 THEN
	                           '1#发件'
	                          WHEN S2004.WZ = 22 THEN
	                           '2#发件'
	                          WHEN S2004.WZ = 23 THEN
	                           '3#发件'
	                          WHEN S2004.WZ = 24 THEN
	                           '4#发件'
	                          WHEN S2004.WZ = 31 THEN
	                           'APU件'
	                          ELSE
	                           '机身件'
	                        END) DQWZ,
	                        S2004.ZWMC,
	                        S2004.YWMC
	                  FROM B_S2_004 S2004
	                 WHERE 1 = 1
	                   AND S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	                   AND S2004.YXBS = 1
	                   AND S2004.XLH IS NOT NULL
	                   AND S2004.ZJZT = 1
	                    <choose>                                                                 
					    	<when test='paramsMap.userType!=null and paramsMap.userType == "admin"'>                       
					    		 AND exists 
					    		( SELECT 1 from D_007 where 
					    		S2004.fjzch = FJZCH
					    		AND S2004.dprtcode = DPRTCODE
					    		AND zt = 1
					    		)
					    	</when>
					    	<when test='paramsMap.userId!=null and paramsMap.userId != "" '>                       
					    		 AND exists 
					    		( SELECT 1 from V_ROLE_JX where 
					    		S2004.fjzch= FJZCH
					    		AND S2004.dprtcode = DPRTCODE
					    		AND USER_ID = #{paramsMap.userId,jdbcType=VARCHAR}
					    		)
					    	</when>
				   	</choose>
	                   </if>
	                   		<if test="fjzch != null and fjzch != '' and fjzch != '-'.toString()">
						   		AND S2004.FJZCH = #{fjzch,jdbcType=VARCHAR}
						   	</if>
						  
							<if test="fjzch == null or fjzch == '' or fjzch == '-'.toString()">
							 	<if test="fjzch != '-'.toString()">
							     UNION ALL
							 	</if>
				              <!--   /* 2、外场 */ -->
				                SELECT H003.DPRTCODE, H003.ID, H003.BJH, H003.SN XLH, 2 DQZT, '-' DQWZ,
				                H003.ZWMS AS ZWMC, H003.YWMS AS YWMC
				                  FROM B_H_003 H003
				                 WHERE 1 = 1
				                   AND H003.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
				                   AND H003.SN IS NOT NULL
				                UNION ALL
				               <!--  /* 3、在库 */ -->
				                SELECT H001.DPRTCODE,
				                		H001.ID,
				                        H001.BJH,
				                        H001.SN XLH,
				                        3 DQZT,
				                        H001.CKH || H001.CKMC || ' ' || H001.KWH DQWZ,
				                        H001.ZWMS AS ZWMC, H001.YWMS AS YWMC
				                  FROM B_H_001 H001
				                 WHERE 1 = 1
				                   AND H001.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
				                   AND H001.SN IS NOT NULL
				                UNION ALL
				               <!--  /* 4、送修 */ -->
				                SELECT H012.DPRTCODE,
				               			H012.ID,
				                        H012.BJH,
				                        H012.SN XLH,
				                        4 DQZT,
				                        D015.GYSBM || D015.GYSMC DQWZ,
				                        NULL AS ZWMC, NULL AS YWMC
				                  FROM B_H_012 H012
				                  LEFT JOIN D_015 D015
				                    ON H012.WPDXID = D015.ID
				                 WHERE 1 = 1
				                   AND H012.ZT = 1
				                   AND H012.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
				                   AND H012.SN IS NOT NULL
				                   AND H012.JDLX = 3
				                   AND COALESCE(H012.KCSL, 0) - COALESCE(H012.GHSL, 0) &gt; 0
				                UNION ALL
				               <!--  /* 5、报废 */ -->
				                SELECT H017.DPRTCODE, H017.ID, H017.BJH, H017.SN XLH, 5 DQZT, '-' DQWZ,
				                	NULL AS ZWMC, NULL AS YWMC
				                  FROM B_H_017 H017
				                  JOIN B_H_00901 H00901
				                    ON H017.ID = H00901.KCLLID
				                   AND H00901.ZT = 1
				                   AND H017.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
				                   AND H017.SN IS NOT NULL
				                  JOIN B_H_009 H009
				                    ON H009.ID = H00901.MAINID
				                   AND H009.ZT IN (3, 10)
				                UNION ALL
				                <!-- /* 6、借出 */ -->
				                SELECT H012.DPRTCODE,
				                		H012.ID,
				                        H012.BJH,
				                        H012.SN XLH,
				                        6 DQZT,
				                        H014.JDDXBH || H014.JDDXMS DQWZ,
				                        NULL AS ZWMC, NULL AS YWMC
				                  FROM B_H_012 H012
				                  LEFT JOIN B_H_014 H014
				                    ON H012.WPDXID = H014.ID
				                 WHERE 1 = 1
				                   AND H012.ZT = 1
				                   AND H012.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
				                   AND H012.SN IS NOT NULL
				                   AND H012.JDLX = 1
				                   AND COALESCE(H012.KCSL, 0) - COALESCE(H012.GHSL, 0) &gt; 0
				                --UNION ALL
	               			</if>
	               <!--  /* 7、销售 */ -->
	                ) BJXX
	          LEFT JOIN B_H_010 H010
	            ON H010.DPRTCODE = BJXX.DPRTCODE
	           AND H010.JH = BJXX.BJH
	           AND H010.XLH = BJXX.XLH
	         WHERE 1 = 1) BJXX
	  LEFT JOIN D_008 D008
	    ON D008.DPRTCODE = BJXX.DPRTCODE
	   AND D008.BJH = BJXX.BJH
	  LEFT JOIN D_005 D005
	    ON D005.DPRTCODE = D008.DPRTCODE
	   AND D005.ZJH = D008.ZJH
	 WHERE 1 = 1
	     <!--  /* 查询条件 */
	      /* KEYWORDS */ -->
	   AND (
	       UPPER(BJXX.BJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%')
	    OR UPPER(BJXX.XLH) LIKE UPPER('%'||#{paramsMap.keyword}||'%')
	    OR UPPER(D008.ZWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	    OR UPPER(D008.YWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	    OR UPPER(D008.CJJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%')
	    )
  	
  	<choose>                                                                                 
    	<when test='pagination.sort == "auto"'>                       
    		ORDER BY BJXX.BJH, BJXX.XLH
    		
    	</when>
    	<otherwise>
		    order by ${pagination.sort} ${pagination.order}
    	</otherwise>
	 </choose>
  	
  </select>
  
  <!-- 从编辑区更新到生效区 -->
  <update id="updateFromEditable" parameterType="java.lang.String">
  	update B_S2_004 SET (ID, DPRTCODE, JX, 
      FJZCH, WZ, CJ, FJDID, 
      BJH, XLH, PCH, ZJSL, 
      LLKLX, LLKBH, FJZW, 
      CHUCRQ, TSN, TSO, 
      CSN, CSO, BJGZJL, BZ, 
      SKBS, SSBS, AZ_FXJLBID, 
      AZSJ, AZJLDID, AZJLDH, 
      AZRID, AZR, AZBZ, CC_FXJLBID, 
      CCSJ, CCJLDID, CCJLDH, 
      CCRID, CCR, CCBZ, 
      ZJZT,
      WHBMID, WHRID, WHSJ, ZJJLX,
      ZWMC, YWMC, CQID, KCCB, BIZ
      ) = 
     (select ID, DPRTCODE, JX, 
      FJZCH, WZ, CJ, FJDID, 
      BJH, XLH, PCH, ZJSL, 
      LLKLX, LLKBH, FJZW, 
      CHUCRQ, TSN, TSO, 
      CSN, CSO, BJGZJL, BZ, 
      SKBS, SSBS, AZ_FXJLBID, 
      AZSJ, AZJLDID, AZJLDH, 
      AZRID, AZR, AZBZ, CC_FXJLBID, 
      CCSJ, CCJLDID, CCJLDH, 
      CCRID, CCR, CCBZ,  
      ZJZT, 
      WHBMID, WHRID, WHSJ, ZJJLX,
      ZWMC, YWMC, CQID, KCCB, BIZ
      FROM B_S2_001 WHERE ID = B_S2_004.id
      ) WHERE ID = #{id, jdbcType=VARCHAR}
  </update>
  <!-- 从编辑区新增到生效区 -->
  <insert id="insertFromEditable" parameterType="java.lang.String">
  	insert into B_S2_004 (ID, DPRTCODE, JX, 
      FJZCH, WZ, CJ, FJDID, 
      BJH, XLH, PCH, ZJSL, 
      LLKLX, LLKBH, FJZW, 
      CHUCRQ, TSN, TSO, 
      CSN, CSO, BJGZJL, BZ, 
      SKBS, SSBS, AZ_FXJLBID, 
      AZSJ, AZJLDID, AZJLDH, 
      AZRID, AZR, AZBZ, CC_FXJLBID, 
      CCSJ, CCJLDID, CCJLDH, 
      CCRID, CCR, CCBZ, 
      ZJZT, YXBS, 
      WHBMID, WHRID, WHSJ, ZJJLX, CJ_ZSJJH, CJ_ZSJXLH,
      ZWMC, YWMC, CQID, KCCB, BIZ
      )
     select ID, DPRTCODE, JX, 
      FJZCH, WZ, CJ, FJDID, 
      BJH, XLH, PCH, ZJSL, 
      LLKLX, LLKBH, FJZW, 
      CHUCRQ, TSN, TSO, 
      CSN, CSO, BJGZJL, BZ, 
      SKBS, SSBS, AZ_FXJLBID, 
      AZSJ, AZJLDID, AZJLDH, 
      AZRID, AZR, AZBZ, CC_FXJLBID, 
      CCSJ, CCJLDID, CCJLDH, 
      CCRID, CCR, CCBZ,  
      ZJZT, 1, 
      WHBMID, WHRID, WHSJ, ZJJLX, #{thjh, jdbcType=VARCHAR}, #{thxlh, jdbcType=VARCHAR},
      ZWMC, YWMC, CQID, KCCB, BIZ
      FROM B_S2_001 WHERE ID = #{id, jdbcType=VARCHAR}
  </insert>
  
  <select id="selectWithInitById" resultMap="DetailResultMap">
  	select T1.ID, T1.DPRTCODE, T1.JX, T1.FJZCH, T1.WZ, T1.CJ, T1.FJDID, T1.BJH, T1.XLH, T1.PCH, T1.ZJSL, T1.LLKLX, T1.LLKBH, T1.FJZW, 
    T1.CHUCRQ, T1.TSN, T1.TSO, T1.CSN, T1.CSO, T1.BJGZJL, T1.BZ, T1.SKBS, T1.SSBS, T1.AZ_FXJLBID, T1.AZSJ, T1.AZJLDID, T1.AZJLDH, 
    T1.AZRID, T1.AZR, T1.AZBZ, T1.CC_FXJLBID, T1.CCSJ, T1.CCJLDID, T1.CCJLDH, T1.CCRID, T1.CCR, T1.CCBZ, T1.CJ_ZSJJH, 
    T1.CJ_ZSJXLH, T1.ZJZT, T1.YXBS, T1.WHBMID, T1.WHRID, T1.WHSJ, T1.ZWMC, T1.YWMC, T1.KCCB, T1.BIZ, T1.CQID,
    T2.ID D_ID, T2.MAINID D_MAINID, T2.JKLBH d_JKLBH, T2.JKFLBH D_JKFLBH, T2.ZSSYY D_ZSSYY
  	from b_s2_004 t1
  	left join b_s2_00401 t2 on t1.id =t2.mainid
  	where t1.id=#{id, jdbcType=VARCHAR}
  </select>
  <select id="getLoadinglistByfjzch" parameterType="String" resultMap="DetailResultMap">
    select B1.ID, B1.DPRTCODE, B1.JX, B1.FJZCH, B1.WZ, B1.CJ, B1.FJDID, B1.BJH, B1.XLH, B1.PCH, 
    B1.ZJSL, B1.LLKLX, B1.LLKBH, B1.FJZW, B1.CHUCRQ, B1.TSN, B1.TSO, B1.CSN, B1.CSO, B1.BJGZJL, 
    B1.BZ, B1.SKBS, B1.SSBS, B1.AZ_FXJLBID, B1.AZSJ, B1.AZJLDID, B1.AZJLDH, B1.AZRID, B1.AZR, 
    B1.AZBZ, B1.CC_FXJLBID, B1.CCSJ, B1.CCJLDID, B1.CCJLDH, B1.CCRID, B1.CCR, B1.CCBZ, B1.CJ_ZSJJH, 
    B1.CJ_ZSJXLH, B1.ZJZT, B1.YXBS, B1.WHBMID, B1.WHRID, B1.WHSJ, B1.ZWMC, B1.YWMC,
    D1.ID AS D1ID, D1.BJH AS D1BJH, D1.ZWMS AS D1ZWMS, D1.YWMS AS D1YWMS, D1.JLDW AS D1JLDW, 
    D1.CJJH AS D1CJJH, D1.ZJH AS D1ZJH, D1.HCJZ AS D1HCJZ, D1.GLJB AS D1GLJB, D1.SXKZ AS D1SXKZ, 
    D1.HCLX AS D1HCLX, D1.HCLX_EJ AS D1HCLX_EJ, D1.IS_MEL AS D1IS_MEL, D1.MIN_KCL AS D1MIN_KCL, 
    D1.MAX_KCL AS D1MAXKCL, D1.BZ AS D1BZ, D1.XH AS D1XH, D1.GG AS D1GG, D1.XINGH AS D1XINGH, D1.ZT AS D1ZT 
    from b_s2_004 b1 
    LEFT JOIN D_008 D1 ON B1.BJH = D1.BJH AND B1.DPRTCODE = D1.DPRTCODE AND D1.ZT = 1
    where b1.zjzt=1 AND b1.yxbs=1 and b1.xlh is not null and b1.bjh=#{bjh,jdbcType=VARCHAR} and b1.dprtcode=#{dprtcode,jdbcType=VARCHAR} and 
    fjzch in (
		select fjzch from d_007 where dprtcode=#{dprtcode,jdbcType=VARCHAR} and fjjx =#{fjjx,jdbcType=VARCHAR}
		)
    </select>
    
  <!-- start 获取数量 -->
  <select id="getCountByParam" parameterType="String" resultType="int">
  	select count(1) from b_s2_004  
  	where dprtcode=#{dprtcode,jdbcType=VARCHAR} and fjzch =#{fjzch,jdbcType=VARCHAR}
  </select>
  <!-- end -->
    
  <!-- 查询飞机一级部件（除机身） -->
  <select id="queryLevelOnePart" resultMap="BaseResultMap">
    SELECT ID, BJH, XLH, WZ, AZSJ, CCSJ FROM (
    	SELECT ID, BJH, XLH, WZ, AZSJ, CCSJ, ROW_NUMBER() OVER(PARTITION BY WZ ORDER BY AZSJ DESC) AS RN
         FROM B_S2_004
        WHERE FJZCH = #{fjzch,jdbcType=VARCHAR}
          AND DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
          AND CJ = 1
          AND YXBS = 1
          AND WZ != '11'
          AND #{jssj,jdbcType=TIMESTAMP} &gt;
        	  COALESCE(AZSJ, TO_DATE('17900101000000', 'YYYYMMDDHH24MISS'))
          AND #{jssj,jdbcType=TIMESTAMP} &lt;=
              COALESCE(CCSJ, TO_DATE('9999-12-31 23:59:00', 'YYYY-MM-DD HH24:MI:SS'))
    ) WHERE RN = 1
  </select>
  <!-- 根据id清除拆下数据 -->
  <update id="update4ClearRemoveDataById">
  	UPDATE B_S2_004 SET CC_FXJLBID=NULL, CCSJ=NULL, CCJLDID=NULL, CCJLDH=NULL, CCRID=NULL, CCR=NULL, CCBZ=NULL, CJ_ZSJJH=NULL, CJ_ZSJXLH=NULL, ZJZT=1 WHERE ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- start 获取发动机数量 -->
  <select id="getCountFdjgsByParam" parameterType="String" resultType="int">
  	select nvl(max(fdjsl),0) from d_007  
  	where dprtcode=#{dprtcode,jdbcType=VARCHAR} and fjzch =#{fjzch,jdbcType=VARCHAR}
  </select>
  <!-- end -->
  
  
  <!--LW:根据条件查询物料履历 -->
  <select id="queryMaterialhistoryList" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
	  	SELECT BJXX.DPRTCODE, 
		       BJXX.BJH, 
		       BJXX.XLH,
		       BJXX.DQZT, 
		       BJXX.DQWZ,
		       BJXX.CAL,
		       (BJXX.CS_TSN + BJXX.LJ_FXSJ) TSN, 
		       (BJXX.CS_TSO + BJXX.LJ_FXSJ) TSO, 
		       (BJXX.CS_CSN + BJXX.LJ_FXXH) CSN, 
		       (BJXX.CS_CSO + BJXX.LJ_FXXH) CSO, 
		       COALESCE(BJXX.BJZWMC, D008.ZWMS) BJH_ZWMC, 
		       COALESCE(BJXX.BJYWMC, D008.YWMS) BJH_YWMC, 
		       D008.CJJH,
		       D008.ZJH, 
		       D008.JHLY, 
		       D008.ZWMS bjywms, 
		       D008.YWMS bjzwms, 
		       D005.ZWMS ZJH_ZWMC, 
		       D005.YWMS ZJH_YWMC, 
		       BJXX.FJZCH FJZCH 
		  FROM (SELECT H010.DPRTCODE,
		               H010.JH BJH,
		               H010.XLH,
		               BJXX.BJZWMC,
		               BJXX.BJYWMC,
		               BJXX.DQZT,
		               BJXX.DQWZ,
		               CASE
		                 WHEN H010.CHUCRQ IS NOT NULL THEN
		                  (SYSDATE - H010.CHUCRQ)
		                 ELSE
		                  NULL
		               END CAL,
		               CAST(COALESCE(H010.TSN, '0') AS INTEGER) CS_TSN,
		               CAST(COALESCE(H010.TSO, '0') AS INTEGER) CS_TSO,
		               CAST(COALESCE(H010.CSN, 0) AS INTEGER) CS_CSN,
		               CAST(COALESCE(H010.CSO, 0) AS INTEGER) CS_CSO,
		               (SELECT COALESCE(SUM(T00601.FXSJ_FZ), 0)
		                  FROM B_S2_00601 T00601
		                  JOIN B_S2_006 T006
		                    ON T00601.MAINID = T006.ID
		                   AND T00601.ZT = 1
		                   AND T006.ZT IN (2, 12, 99)
		                   AND T006.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                  JOIN B_S2_004 S2004
		                    ON S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                   AND S2004.FJZCH = T006.FJZCH
		                   AND COALESCE(S2004.AZSJ,
		                                TO_DATE('17900101000000', 'YYYYMMDDHH24MISS')) &lt;=
		                       T00601.KCSJ
		                   AND COALESCE(S2004.CCSJ,
		                                TO_DATE('89991231235900', 'YYYYMMDDHH24MISS')) &gt;=
		                       T00601.KCSJ
		                 WHERE 1 = 1
		                   AND BJXX.BJH = S2004.BJH
		                   AND BJXX.XLH = S2004.XLH
<!-- 		                   AND T00601.KCSJ >= H010.WHSJ -->
		                   ) LJ_FXSJ,
		               (SELECT COALESCE(SUM(T00601.FXXH), 0)
		                  FROM B_S2_00601 T00601
		                  JOIN B_S2_006 T006
		                    ON T00601.MAINID = T006.ID
		                   AND T00601.ZT = 1
		                   AND T006.ZT IN (2, 12, 99)
		                   AND T006.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                  JOIN B_S2_004 S2004
		                    ON S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                   AND S2004.FJZCH = T006.FJZCH
		                   AND COALESCE(S2004.AZSJ,
		                                TO_DATE('17900101000000', 'YYYYMMDDHH24MISS')) &lt;=
		                       T00601.KCSJ
		                   AND COALESCE(S2004.CCSJ,
		                                TO_DATE('89991231235900', 'YYYYMMDDHH24MISS')) &gt;=
		                       T00601.KCSJ
		                 WHERE 1 = 1
		                   AND BJXX.BJH = S2004.BJH
		                   AND BJXX.XLH = S2004.XLH
<!-- 		                   AND T00601.KCSJ >= H010.WHSJ -->
		                   ) LJ_FXXH,
		                 BJXX.FJZCH
		          FROM B_H_010 H010
		          LEFT JOIN (
		               <if test="fjzch != '-'.toString()">
		          
		                    SELECT S2004.DPRTCODE,
		                            S2004.BJH,
		                            S2004.XLH,
		                            S2004.ZWMC BJZWMC,
		                            S2004.YWMC BJYWMC,
		                            1 DQZT,
		                            S2004.FJZCH || ' ' || (CASE
		                              WHEN S2004.WZ = 21 THEN
		                               '1#发件'
		                              WHEN S2004.WZ = 22 THEN
		                               '2#发件'
		                              WHEN S2004.WZ = 23 THEN
		                               '3#发件'
		                              WHEN S2004.WZ = 24 THEN
		                               '4#发件'
		                              WHEN S2004.WZ = 31 THEN
		                               'APU件'
		                              ELSE
		                               '机身件'
		                            END) DQWZ,
		                            S2004.FJZCH
		                      FROM B_S2_004 S2004
		                     WHERE 1 = 1
		                       AND S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                       AND S2004.YXBS = 1
		                       AND S2004.XLH IS NOT NULL
		                       AND S2004.ZJZT = 1
			                  <choose>                                                                 
						    	<when test='paramsMap.userType!=null and paramsMap.userType == "admin"'>                       
						    		 AND exists 
						    		( SELECT 1 from D_007 where 
						    		S2004.fjzch = FJZCH
						    		AND S2004.dprtcode = DPRTCODE
						    		AND zt = 1
						    		)
						    	</when>
						    	<when test='paramsMap.userId!=null and paramsMap.userId != "" '>                       
						    		 AND exists 
						    		( SELECT 1 from V_ROLE_JX where 
						    		S2004.fjzch= FJZCH
						    		AND S2004.dprtcode = DPRTCODE
						    		AND USER_ID = #{paramsMap.userId,jdbcType=VARCHAR}
						    		)
						    	</when>
					   		</choose>
		                </if>
		               
	                    <if test="fjzch != null and fjzch != '' and fjzch != '-'.toString()">
					   		AND S2004.FJZCH = #{fjzch,jdbcType=VARCHAR}
					   	</if>
						  
						<if test="fjzch == null or fjzch == '' or fjzch == '-'.toString()">
						 	<if test="fjzch != '-'.toString()">
						     	UNION ALL
						 	</if>
		                   
		                    SELECT H003.DPRTCODE,
		                            H003.BJH,
		                            H003.SN XLH,
		                            H003.ZWMS BJZWMC,
		                            H003.YWMS BJYWMC,
		                            2 DQZT,
		                            '-' DQWZ,
		                            '' FJZCH
		                      FROM B_H_003 H003
		                     WHERE 1 = 1
		                       AND H003.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                       AND H003.SN IS NOT NULL
		                    UNION ALL
		                
		                    SELECT H001.DPRTCODE,
		                            H001.BJH,
		                            H001.SN XLH,
		                            H001.ZWMS BJZWMC,
		                            H001.YWMS BJYWMC,
		                            3 DQZT,
		                            H001.CKH || H001.CKMC || ' ' || H001.KWH DQWZ,
		                            '' FJZCH
		                      FROM B_H_001 H001
		                     WHERE 1 = 1
		                       AND H001.DPRTCODE =  #{dprtcode,jdbcType=VARCHAR}
		                       AND H001.SN IS NOT NULL
		                       AND NOT EXISTS
		                     (SELECT 1
		                              FROM B_H_00101 H00101
		                             WHERE H00101.ID = H001.ID)
		                    UNION ALL
		                   
		                    SELECT H001.DPRTCODE,
		                            H001.BJH,
		                            H001.SN XLH,
		                            H001.ZWMS BJZWMC,
		                            H001.YWMS BJYWMC,
		                            4 DQZT,
		                            H001.CKH || H001.CKMC || ' ' || H001.KWH DQWZ,
		                            '' FJZCH
		                      FROM B_H_001 H001
		                     WHERE 1 = 1
		                       AND H001.DPRTCODE =  #{dprtcode,jdbcType=VARCHAR}
		                       AND H001.SN IS NOT NULL
		                       AND EXISTS (SELECT 1
		                              FROM B_H_00101 H00101
		                             WHERE H00101.ID = H001.ID)
		                     </if> 
		                           
		                   ) BJXX
		            ON H010.DPRTCODE = BJXX.DPRTCODE
		           AND H010.JH = BJXX.BJH
		           AND H010.XLH = BJXX.XLH) BJXX
		  LEFT JOIN D_008 D008
		    ON D008.DPRTCODE = BJXX.DPRTCODE
		   AND D008.BJH = BJXX.BJH
		  LEFT JOIN D_005 D005
		    ON D005.DPRTCODE = D008.DPRTCODE
		   AND D005.ZJH = D008.ZJH
		  WHERE  BJXX.DQZT IS NOT NULL
	     <!--  查询条件-->
	     AND BJXX.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}  
	     <if test="fjzch != null and fjzch != '' and fjzch != '-'.toString()">
	     	AND BJXX.FJZCH = #{fjzch,jdbcType=VARCHAR} 
	     </if>
	      <!-- KEYWORDS -->
	   	 AND (
	   	      UPPER(BJXX.BJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	   	   OR UPPER(BJXX.XLH) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	   	   OR UPPER(D008.ZWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	       OR UPPER(D008.YWMS) LIKE UPPER('%'||#{paramsMap.keyword}||'%') 
	       OR UPPER(D008.CJJH) LIKE UPPER('%'||#{paramsMap.keyword}||'%')
	       )
  	 <choose>                                                                                 
    	<when test='pagination.sort == "auto"'>                       
    		ORDER BY BJXX.BJH, BJXX.XLH
    	</when>
    	<otherwise>
		    order by ${pagination.sort} ${pagination.order}
    	</otherwise>
	 </choose>
  </select>
  
   <!--LW:物料履历列表信息 -->
   <select id="queryMaterialAllBj" resultMap="BaseResultMap" parameterType="com.eray.thjw.produce.po.InstallationListEffective" >
	   SELECT SYS_GUID() KEY_, --KEY
		       BJLLXX.DPRTCODE, --机构代码
		       BJLLXX.BJH, --部件号
		       BJLLXX.XLH, --序列号
		       BJLLXX.CZRQ, --操作日期
		       BJLLXX.CZSJ, --操作时间
		       BJLLXX.CZLX, --操作类型：1装上、2拆下、11收货-采购、12收货-修理、13收货-租进、14收货-租出、15收货-交换、16收货-退料、17收货-其他、18收货-入库上架、19收货-撤销、21出库-修理、22出库-租进、23出库-租出、24出库-交换、25出库外销、26出库发料、27出库-采购、28出库-其他、29出库-撤销、31移库-移入、32移库-移出、41盘点-盘亏、42盘点盘盈、51销毁-下架、59销毁-撤销
		       BJLLXX.ZJQDID, --装机清单ID
		       BJLLXX.YWDJID, --业务单据ID
		       BJLLXX.YWDJBH, --业务单据编号
		       BJLLXX.CK_FJZCH, --仓库/飞机注册号
		       BJLLXX.KW_ZJWZ, --库位/装机位置
		       BJLLXX.FJDID, --父节点ID
		       BJLLXX.SJBJ, --上级部件
		       BJLLXX.CZZ, --操作者
		       BJLLXX.BJYYSJ, --部件已用：监控项目编号 + '#_#' + 部件使用量 + '#_#' + 在机使用量
		       BJLLXX.CZYY --拆装原因
		  FROM (
		        /* 1装上 */
		        SELECT S2004.DPRTCODE,
		                S2004.BJH,
		                S2004.XLH,
		                TO_CHAR(S2004.AZSJ, 'yyyy-mm-dd hh24:mi:ss') CZRQ,
		                TO_CHAR(S2004.AZSJ, 'yyyy-mm-dd hh24:mi:ss') CZSJ,
		                1 CZLX,
		                S2004.ID ZJQDID,
		                S2004.AZJLDID YWDJID,
		                S2004.AZJLDH YWDJBH,
		                S2004.FJZCH CK_FJZCH,
		                (CASE
		                  WHEN S2004.WZ = 21 THEN
		                   '1#发件'
		                  WHEN S2004.WZ = 22 THEN
		                   '2#发件'
		                  WHEN S2004.WZ = 23 THEN
		                   '3#发件'
		                  WHEN S2004.WZ = 24 THEN
		                   '4#发件'
		                  WHEN S2004.WZ = 31 THEN
		                   'APU件'
		                  ELSE
		                   '机身件'
		                END) KW_ZJWZ,
		                S2004.FJDID,
		                (S2004_F.BJH || ' ' || S2004_F.XLH) SJBJ,
		                S2004.AZR CZZ,
		                S200401.BJYYSJ,
		                S2004.AZBZ CZYY
		          FROM B_S2_004 S2004
		          LEFT JOIN B_S2_004 S2004_F
		            ON S2004.FJDID = S2004_F.ID
		          LEFT JOIN (SELECT S200401.ZJQDID, MAX(S200401.BJYYSJ) BJYYSJ
		                       FROM (SELECT S200401.MAINID ZJQDID,
		                                    WM_CONCAT(S200401.JKLBH || '#_#' ||
		                                              S200401.ZSSYY || '#_#' || '') OVER(PARTITION BY S200401.MAINID ORDER BY S200401.JKLBH) BJYYSJ
		                               FROM B_S2_00401 S200401) S200401
		                      GROUP BY S200401.ZJQDID) S200401
		            ON S200401.ZJQDID = S2004.ID
		         WHERE 1 = 1
		           AND S2004.Dprtcode = #{paramsMap.dprtcode}
		           AND S2004.YXBS = 1
		           AND S2004.BJH = #{paramsMap.jh}
		           AND S2004.XLH = #{paramsMap.xlh}
		        UNION ALL
		        /* 2、拆下 */
		        SELECT S2004.DPRTCODE,
		                S2004.BJH,
		                S2004.XLH,
		                TO_CHAR(S2004.CCSJ, 'yyyy-mm-dd hh24:mi:ss') CZRQ,
		                TO_CHAR(S2004.CCSJ, 'yyyy-mm-dd hh24:mi:ss') CZSJ,
		                S2004.ZJZT CZLX,
		                S2004.ID ZJQDID,
		                S2004.CCJLDID YWDJID,
		                S2004.CCJLDH YWDJBH,
		                S2004.FJZCH CK_FJZCH,
		                (CASE
		                  WHEN S2004.WZ = 21 THEN
		                   '1#发件'
		                  WHEN S2004.WZ = 22 THEN
		                   '2#发件'
		                  WHEN S2004.WZ = 23 THEN
		                   '3#发件'
		                  WHEN S2004.WZ = 24 THEN
		                   '4#发件'
		                  WHEN S2004.WZ = 31 THEN
		                   'APU件'
		                  ELSE
		                   '机身件'
		                END) KW_ZJWZ,
		                S2004.FJDID,
		                (S2004_F.BJH || ' ' || S2004_F.XLH) SJBJ,
		                S2004.CCR CZZ,
		                S200401.BJYYSJ,
		                S2004.CCBZ CZYY
		          FROM B_S2_004 S2004
		          LEFT JOIN B_S2_004 S2004_F
		            ON S2004.FJDID = S2004_F.ID
		          LEFT JOIN (SELECT S200401.ZJQDID, MAX(S200401.BJYYSJ) BJYYSJ
		                       FROM (SELECT S200401.MAINID ZJQDID,
		                                    WM_CONCAT(S200401.JKLBH || '#_#' ||
		                                              S200401.CXSYY || '#_#' ||
		                                              S200401.ZJSYL) OVER(PARTITION BY S200401.MAINID ORDER BY S200401.JKLBH) BJYYSJ
		                               FROM B_S2_00401 S200401) S200401
		                      GROUP BY S200401.ZJQDID) S200401
		            ON S200401.ZJQDID = S2004.ID
		         WHERE 1 = 1
		           AND S2004.Dprtcode = #{paramsMap.dprtcode}
		           AND S2004.YXBS = 1
		           AND S2004.ZJZT = 2
		           AND S2004.BJH = #{paramsMap.jh}
		           AND S2004.XLH = #{paramsMap.xlh}
		        UNION ALL
		        /* 库存履历 */
		        SELECT H025.DPRTCODE,
		                H017.BJH,
		                H017.SN XLH,
		                TO_CHAR(H025.CZSJ, 'yyyy-mm-dd hh24:mi:ss') CZRQ,
		                TO_CHAR(H025.CZSJ, 'yyyy-mm-dd hh24:mi:ss') CZSJ,
		                COALESCE(H025.CZZLX,H025.CZLX) CZLX,
		                NULL ZJQDID,
		                H025.YWID YWDJID,
		                H025.YWBH YWDJBH,
		                H017.CKH CK_FJZCH,
		                H017.KWH KW_ZJWZ,
		                NULL FJDID,
		                NULL SJBJ,
		                H025.CZR CZZ,
		                NULL BJYYSJ,
		                NULL CZYY
		          FROM B_H_025 H025
		          JOIN B_H_017 H017
		            ON H025.ID = H017.ID
		         WHERE 
		                H025.DPRTCODE = #{paramsMap.dprtcode}
		            AND H017.BJH = #{paramsMap.jh}
		            AND H017.SN = #{paramsMap.xlh}
		         	AND H025.CZLX IN (10, 20, 30, 40, 50)
		        ) BJLLXX
		 WHERE 1 = 1
		 ORDER BY BJLLXX.CZRQ ASC, BJLLXX.CZSJ ASC
   </select>
  
</mapper>