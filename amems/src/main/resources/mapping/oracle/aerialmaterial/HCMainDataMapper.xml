<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.eray.thjw.aerialmaterial.dao.HCMainDataMapper" >
  <resultMap id="BaseResultMap" type="com.eray.thjw.aerialmaterial.po.HCMainData" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="JHLY" property="jhly" jdbcType="VARCHAR" />
    <result column="BJH" property="bjh" jdbcType="VARCHAR" />
    <result column="BZJH" property="bzjh" jdbcType="VARCHAR" />
    <result column="GSE" property="gse" jdbcType="VARCHAR" />
    <result column="ZZCS" property="zzcs" jdbcType="VARCHAR" />
    <result column="ZZJBS" property="zzjbs" jdbcType="DECIMAL" />
    <result column="DPRTCODE" property="dprtcode" jdbcType="VARCHAR" />
    <result column="ZWMS" property="zwms" jdbcType="VARCHAR" />
    <result column="YWMS" property="ywms" jdbcType="VARCHAR" />
    <result column="JLDW" property="jldw" jdbcType="VARCHAR" />
    <result column="CJJH" property="cjjh" jdbcType="VARCHAR" />
    <result column="ZJH" property="zjh" jdbcType="VARCHAR" />
    <result column="HCJZ" property="hcjz" jdbcType="DECIMAL" />
    <result column="GLJB" property="gljb" jdbcType="DECIMAL" />
    <result column="SXKZ" property="sxkz" jdbcType="DECIMAL" />
    <result column="HCLX" property="hclx" jdbcType="DECIMAL" />
    <result column="HCLX_EJ" property="hclxEj" jdbcType="DECIMAL" />
    <result column="IS_MEL" property="isMel" jdbcType="DECIMAL" />
    <result column="MIN_KCL" property="minKcl" jdbcType="DECIMAL" />
    <result column="MAX_KCL" property="maxKcl" jdbcType="DECIMAL" />
    <result column="BZ" property="bz" jdbcType="VARCHAR" />
    <result column="XH" property="xh" jdbcType="VARCHAR" />
     <result column="GG" property="gg" jdbcType="VARCHAR" />
      <result column="XINGH" property="xingh" jdbcType="VARCHAR" />
    <result column="ZT" property="zt" jdbcType="DECIMAL" />
    <result column="BMID" property="bmid" jdbcType="VARCHAR" />
    <result column="CJRID" property="cjrid" jdbcType="VARCHAR" />
    <result column="CJSJ" property="cjsj" jdbcType="TIMESTAMP" />
    <result column="KCSL" property="kcsl" jdbcType="DECIMAL" />
    <result column="KYKCSL" property="kykcsl" jdbcType="DECIMAL" />
    
    <result column="JUESCB" jdbcType="DECIMAL" property="juescb" />
    <result column="JIESCB" jdbcType="DECIMAL" property="jiescb" />
    <result column="GSCB" jdbcType="DECIMAL" property="gscb" />
    <result column="WHRID" jdbcType="VARCHAR" property="whrid" />
    <result column="CBWHSJ" jdbcType="TIMESTAMP" property="cbwhsj" />
    
    <result column="USERNAME" jdbcType="VARCHAR" property="username" />
    <result column="REALNAME" jdbcType="VARCHAR" property="realname" />
    <result column="DPRTNAME" jdbcType="VARCHAR" property="dprtname" />
    <result column="ZJHMS" jdbcType="VARCHAR" property="zjhms" />
    <result column="dxtdsl" property="paramsMap.dxtdsl" jdbcType="DECIMAL" />
    <result column="tdjczs" property="paramsMap.tdjczs" jdbcType="DECIMAL" />
    <result column="xlh" property="paramsMap.xlh" jdbcType="DECIMAL" />
    <result column="pch" property="paramsMap.pch" jdbcType="DECIMAL" />
    <result column="zjhzwms" property="paramsMap.zjhzwms" jdbcType="VARCHAR" />
    <result column="zjhywms" property="paramsMap.zjhywms" jdbcType="VARCHAR" />
    <result column="CERTIFICATECOUNT" property="paramsMap.certificatecount" jdbcType="VARCHAR" />	<!-- 证书数量-->
    <result column="TDJXX" property="paramsMap.tdjxx" jdbcType="VARCHAR" /><!-- 替代件信息-->
    <result column="grn" property="paramsMap.grn" jdbcType="VARCHAR" /><!-- 替代件信息-->
    
  </resultMap>
  
  <resultMap id="HcTaskInfoResultMap" type="com.eray.thjw.aerialmaterial.po.HcTaskInfo" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="bjid" property="bjid" jdbcType="VARCHAR" />
    <result column="rwlx" property="rwlx" jdbcType="VARCHAR" />
    <result column="rwzlx" property="rwzlx" jdbcType="VARCHAR" />
    <result column="rwxx" property="rwxx" jdbcType="VARCHAR" />
    <result column="rwgdid" property="rwgdid" jdbcType="VARCHAR" />
    <result column="rwgdbh" property="rwgdbh" jdbcType="VARCHAR" />
    <result column="xh" property="xh" jdbcType="VARCHAR" />
    <result column="gdid" property="gdid" jdbcType="VARCHAR" />
    <result column="gdjcid" property="gdjcid" jdbcType="VARCHAR" />
    
  </resultMap>
  
   <resultMap id="HcRelOrdersResultMap" type="com.eray.thjw.aerialmaterial.po.HcTaskRelOrder" >
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="bjid" property="bjid" jdbcType="VARCHAR" />
    <result column="rwgdid" property="rwgdid" jdbcType="VARCHAR" />
    <result column="gdid" property="gdid" jdbcType="VARCHAR" />
    <result column="gdbh" property="gdbh" jdbcType="VARCHAR" />
    <result column="zgdid" property="zgdid" jdbcType="VARCHAR" />
    <result column="zgdbh" property="zgdbh" jdbcType="VARCHAR" />
    <result column="scheduleCheck" property="scheduleCheck" jdbcType="VARCHAR" />
    <result column="masterBill" property="masterBill" jdbcType="VARCHAR" />
    <result column="gdlx" property="gdlx" jdbcType="DECIMAL" />
    <result column="gdjcid" property="gdjcid" jdbcType="VARCHAR" />
    <result column="xh" property="xh" jdbcType="VARCHAR" />
  </resultMap>
  
	<!-- 注意：在写对应关系时,id字段需要重命名 -->
	<resultMap type="com.eray.thjw.aerialmaterial.po.HCMainData" id="MaterialJoinMap" extends="BaseResultMap">  
       
        <association property="fixChapter" javaType="com.eray.thjw.po.FixChapter">
	    	<id column="FZJH" property="zjh"/>
	     	<result column="FZWMS" property="zwms"/>
	        <result column="FYWMS" property="ywms"/>
	    </association>
       
		<association property="materialToStore" javaType="com.eray.thjw.aerialmaterial.po.MaterialToStore">
         	<id column="SID" property="id"/>
         	<result column="SMAINID" property="mainid"/>
         	<result column="SCKH" property="ckh"/>
         	<result column="SKWH" property="kwh"/>
		</association>
      
     	<collection property="materialToPlaneModelList" ofType="com.eray.thjw.aerialmaterial.po.MaterialToPlaneModel" >  
           	<id property="id" column="MID" />  
           	<result property="mainid" column="MMAINID" />  
          	 <result property="fjjx" column="MFJJX" />  
       	</collection>
        
   </resultMap> 
   
   <!-- 注意：在写对应关系时,id字段需要重命名 -->
  <resultMap type="com.eray.thjw.aerialmaterial.po.HCMainData" id="MaterialToUserMap" extends="BaseResultMap">  
       <association property="zdr" javaType="com.eray.thjw.po.User">
         <id column="ZDRID" property="id"/>
         <result column="REALNAME" property="realname"/>
         <result column="USERNAME" property="username"/>
      </association>
      
      <association property="fixChapter" javaType="com.eray.thjw.po.FixChapter">
         <id column="FZJH" property="zjh"/>
         <result column="FZWMS" property="zwms"/>
         <result column="FYWMS" property="ywms"/>
      </association>
       
   </resultMap> 
  
  <!-- 注意：在写对应关系时,id字段需要重命名 -->
	<resultMap type="com.eray.thjw.aerialmaterial.po.HCMainData" id="certificateMap" extends="BaseResultMap">   
       <collection property="certificates" ofType="com.eray.thjw.aerialmaterial.po.ComponentCertificate">  
	    <id column="C1ID" property="id" jdbcType="VARCHAR" />
	    <result column="C1JH" property="jh" jdbcType="VARCHAR" />
	    <result column="C1XLH" property="xlh" jdbcType="VARCHAR" />
	    <result column="C1PCH" property="pch" jdbcType="VARCHAR" />
	    <result column="C1ZSBH" property="zsbh" jdbcType="VARCHAR" />
	    <result column="C1ZSCFWZ" property="zscfwz" jdbcType="VARCHAR" />
	    <result column="C1ZJLX" property="zjlx" jdbcType="VARCHAR" />
	    <result column="C1QSRQ" property="qsrq" jdbcType="TIMESTAMP" />
   	 </collection>
    </resultMap>
  
  <sql id="Base_Column_List" >
    ID, BJH, DPRTCODE, ZWMS, YWMS, JLDW, CJJH, ZJH, HCJZ, GLJB, SXKZ, HCLX, HCLX_EJ, 
    IS_MEL, MIN_KCL, MAX_KCL, BZ,XH,GG,XINGH, ZT, BMID, CJRID, CJSJ,jhly,zzcs
  </sql>
  
  <sql id="Material_User_List" >
    D.ID, D.BJH,D.BZJH,D.GSE,D.ZZJBS,D.DPRTCODE, D.ZWMS, D.YWMS, D.JLDW, D.CJJH, D.ZJH, D.HCJZ, D.GLJB, D.SXKZ, D.HCLX, D.HCLX_EJ, D.jhly,D.ZZCS,
    D.IS_MEL, D.MIN_KCL, D.MAX_KCL, D.BZ,D.XH,D.GG,D.XINGH, D.ZT, D.BMID, D.CJRID, D.CJSJ,U.ID AS ZDRID,U.REALNAME,U.USERNAME,
    D005.ZJH AS FZJH,D005.ZWMS AS FZWMS,D005.YWMS AS FYWMS
  </sql>
  
  <sql id="Material_Join_List" >
    D008.ID, D008.BJH, D008.DPRTCODE,D008.JHLY,D008.BZJH,D008.GSE,D008.ZZJBS,D008.ZWMS, D008.YWMS, D008.JLDW, D008.CJJH, D008.ZJH, D008.HCJZ, D008.GLJB, D008.SXKZ, D008.HCLX,
    D008.HCLX_EJ, D008.IS_MEL, D008.MIN_KCL, D008.MAX_KCL, D008.BZ,D008.XH,D008.GG,D008.XINGH, D008.ZT, D008.BMID, D008.CJRID, D008.CJSJ,D008.ZZCS,
    D00801.ID AS MID,D00801.MAINID AS MMAINID,D00801.FJJX AS MFJJX,
    D00802.ID AS SID,D00802.MAINID AS SMAINID,D00802.CKH AS SCKH,D00802.KWH AS SKWH,
    D005.ZJH AS FZJH,D005.ZWMS AS FZWMS,D005.YWMS AS FYWMS
  </sql>
  
    <select id="selectByPrimaryHCMainData" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from D_008
    where  ZT=1 AND bjh = #{0,jdbcType=VARCHAR} AND DPRTCODE = #{1,jdbcType=VARCHAR}
  </select>
  
    <select id="selectByBjhAndDprcode" resultMap="MaterialToUserMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    select 
    <include refid="Material_User_List" />
    from D_008 D
    left join T_USER U
           on D.CJRID = U.ID
    left join D_005 D005
           on D.ZJH = D005.ZJH and D.DPRTCODE = D005.DPRTCODE and d.zt = 1
    where  D.ZT=1 AND D.bjh = #{bjh,jdbcType=VARCHAR} AND D.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
  </select>
  
  <!-- 根据盘点id、关键字查询航材信息 -->
  	<select id="queryMaterialListByPdid" parameterType="java.lang.String" resultMap="BaseResultMap">
	   select 
	   		D008.jhly, D008.ID, D008.BJH, D008.DPRTCODE, D008.ZWMS, D008.YWMS, D008.JLDW, D008.CJJH, D008.ZJH, D008.HCJZ, D008.GLJB, D008.SXKZ, 
	   		D008.HCLX, D008.HCLX_EJ,D008.IS_MEL, D008.MIN_KCL, D008.MAX_KCL, D008.BZ,D008.XH,D008.GG,D008.XINGH, D008.ZT, D008.BMID, D008.CJRID, D008.CJSJ,D008.ZZCS
	   from D_008 D008
	   where (
	   		exists (select 1 from B_H_01602 B01602 where B01602.ZT = 1 and B01602.PDLX = 3 and B01602.MAINID= #{pdid} AND B01602.DXID = D008.ID) 
    	 	or 
    	 	not exists(select 1 from B_H_01602 B01602 where B01602.ZT = 1 and B01602.PDLX = 3 and B01602.MAINID= #{pdid})
    	 )
	   <if test="keyword != null and keyword != ''">
		    and (UPPER(D008.BJH) like UPPER('%'||#{keyword}||'%')
		    	OR UPPER(D008.YWMS) like UPPER('%'||#{keyword}||'%')
		    	OR UPPER(D008.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	OR UPPER(D008.CJJH) like UPPER('%'||#{keyword}||'%')
		    )
		</if>
		and D008.DPRTCODE = (select DPRTCODE from B_H_016 B01602 where ID= #{pdid})
	</select>
  
	
  	<select id="selectById" resultMap="MaterialJoinMap" parameterType="java.lang.String" >
    	select 
		    <include refid="Material_Join_List" />
		from D_008 D008
		left join D_00801 D00801 
	    on D008.ID = D00801.MAINID
	    left join D_00802 D00802
	    on D008.ID = D00802.MAINID
	    left join D_005 D005
	    on D008.ZJH = D005.ZJH and D008.DPRTCODE = D005.DPRTCODE
		where D008.ID = #{id,jdbcType=VARCHAR}
  	</select>
  
          <!-- 到航材主数据中加入查询部件号信息 -->
     <select id="selectHCMainDataList" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >

		select distinct t1.BJH, t2.ZWMS, t2.YWMS,t2.dprtcode
		from (select BJH, dprtcode
		from D_008
		WHERE ZT = 1
		UNION all
		select JH BJH, dprtcode
		from b_s_003
		WHERE BJLX = 1
		and ZT = 1) t1
		left join d_008 t2
		on t1.bjh = t2.bjh
		and t1.dprtcode = t2.dprtcode 
		and t2.zt = 1
		      
		 <include refid="BJParmer"></include>
	    	
      </select>
      
      
       <!-- 工单的查询航材耗材 -->
        <sql id="BJParmer">
	   where 
	   1=1
        <if test="keyword != null and keyword != ''">
		    and (UPPER(t2.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(t2.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(t1.BJH) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
		</if> 
		<if test="dprtcode != null and dprtcode != ''">
            and  t2.dprtcode =#{dprtcode}
         </if>
	</sql>
      
       <!-- 到航材主数据中加入查询部件号信息 -->
     <select id="queryAllPageLists" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
	
		select b.bjid,
		       b.bjh,
		       b.jhly,
<!-- 		       b.bzjh, -->
<!-- 		       b.gse, -->
<!-- 		       b.zzjbs, -->
		       b.ywms,
		       b.zwms,
		       b.min_kcl,
		       b.max_kcl,
		       b.kcsl,
		       b.cjjh,
		       b.gljb,
		       b.hclx,
		       b.jldw,
		       b.dprtCode
		  from (select b1.bjid,
		               b2.bjh,
		               b2.jhly,
		               b2.ywms,
		               b2.zwms,
		               b2.min_kcl,
		               b2.max_kcl,
		               (CASE WHEN b1.kcsl IS NULL THEN 0 ELSE b1.kcsl END) kcsl,
		               b2.cjjh,
		               b2.gljb,
		               b2.hclx,
		               b2.jldw,
		               b1.dprtCode
		          from (select b_h_001.bjid, b_h_001.dprtcode, sum(b_h_001.kcsl) kcsl
		                  from b_h_001
		                 group by b_h_001.bjid, b_h_001.dprtcode) b1
		          left join d_008 b2
		            on b1.bjid = b2.id
            
             <include refid="yjParmer"></include>
        
			) b
			 where 1 = 1
  			<choose>
			    	<when test='pagination.sort == "auto"'>
			    		order by b.bjh
			    	</when>
			    	<otherwise>
					    order by ${pagination.sort} ${pagination.order}
			    	</otherwise>
		 	</choose>
      </select>
      
   <!-- 预警-->
     <sql id="yjParmer">
	   where 
	   1=1
	   
	   <if test="maxKcl == 2 and minKcl ==2">
	         and  b1.dprtcode =#{dprtcode} 
  			<if test="hclx != null ">
           	and  b2.hclx =#{hclx}
             </if>
           and (UPPER(b2.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.BJH) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
        union all
        select b1.id bjid,
               b1.bjh,
               b1.jhly,
               b1.ywms,
               b1.zwms,
               b1.min_kcl,
               b1.max_kcl,
               0 kcsl,
               b1.cjjh,
               b1.gljb,
               b1.hclx,
               b1.jldw,
               b1.dprtCode
          from d_008 b1
         where not exists (select 1 from b_h_001 where bjid = b1.id)
           and b1.min_kcl > 0
           and b1.dprtCode =#{dprtcode} 
            <if test="hclx != null ">
           	and  b1.hclx =#{hclx}
             </if>
           and (UPPER(b1.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.BJH) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
	     </if>
	     
		 <if test="maxKcl == 1 and minKcl ==2">
            and  b2.max_kcl is not null and kcsl&gt;=b2.max_kcl   and  b1.dprtcode =#{dprtcode} 
	             <if test="hclx != null ">
	           		and  b2.hclx =#{hclx}
	             </if>
           and (UPPER(b2.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.BJH) like UPPER('%'||#{keyword}||'%'))   
         </if>
         
         
       	 <if test="maxKcl == 2 and minKcl ==1">
           and   kcsl&lt;=b2.min_kcl   and  b1.dprtcode =#{dprtcode} 

  			<if test="hclx != null ">
           	and  b2.hclx =#{hclx}
             </if>
           and (UPPER(b2.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b2.BJH) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
        union all
        select b1.id bjid,
               b1.bjh,
               b1.jhly,
               b1.ywms,
               b1.zwms,
               b1.min_kcl,
               b1.max_kcl,
               0 kcsl,
               b1.cjjh,
               b1.gljb,
               b1.hclx,
               b1.jldw,
               b1.dprtCode
          from d_008 b1
         where not exists (select 1 from b_h_001 where bjid = b1.id)
           and b1.min_kcl > 0
           and b1.dprtCode =#{dprtcode} 
           
            <if test="hclx != null ">
           	and  b1.hclx =#{hclx}
             </if>
           and (UPPER(b1.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(b1.BJH) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
         </if>
         
         
	</sql>
  

  
  
  <!-- 检查航材是否存在 -->
	<select id="checkMaterial" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="BaseResultMap">
		select 
           	<include refid="Base_Column_List" />
           from D_008
           where ZT = 1 and BJH = #{bjh,jdbcType=VARCHAR} and DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	</select>
	
	 <!-- 检查航材是否存在（删除数据） -->
	<select id="selectByBjh" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="BaseResultMap">
		select 
           	<include refid="Base_Column_List" />
           from D_008
           where ZT = 0 and BJH = #{bjh,jdbcType=VARCHAR} and DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
	</select>
  
  <sql id="HcParam2">
	   where 
	   1=1
	     <if test="bjh != null and bjh != ''">
            and  BJH =#{bjh}
         </if>
	</sql>
	
	<!-- 搜索参数 -->
	<sql id="MaterialParam">
		<!--id-->
		<if test="id != null and id != ''">
			and D.ID = #{id}
		</if>
		<if test="keyword != null and keyword != ''">
		    and (<!-- UPPER(D.BJH) like CONCAT(UPPER(#{keyword}),'%') -->
		    	UPPER(D.BJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.BZ) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D005.ZJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D005.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(U.USERNAME) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(U.REALNAME) like UPPER('%'||#{keyword}||'%')
		    )
		</if>
		<if test="hcjz != null">
		    and D.HCJZ = #{hcjz}
		</if>
		<if test="gljb != null">
		    and D.GLJB = #{gljb}
		</if>
		<if test="sxkz != null">
		    and D.SXKZ = #{sxkz}
		</if>
		<if test="hclx != null">
		    and D.HCLX = #{hclx}
		</if>
		<if test="hclxEj != null">
		    and D.HCLX_EJ = #{hclxEj}
		</if>
		<if test="isMel != null">
		    and D.IS_MEL = #{isMel}
		</if>
		
		<if test="paramsMap != null and paramsMap.whrqBegin != null and paramsMap.whrqBegin != ''">
		    and D.CJSJ &gt;= to_date(#{paramsMap.whrqBegin, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS') 
		</if>
		<if test="paramsMap != null and paramsMap.whrqEnd != null and paramsMap.whrqEnd != ''">
		    and D.CJSJ &lt;= to_date(#{paramsMap.whrqEnd, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS') 
		</if>

		<if test="paramsMap != null and paramsMap.whrname != null and paramsMap.whrname != ''">
		    and (UPPER(U.REALNAME) like UPPER('%'||#{paramsMap.whrname}||'%')
		    or UPPER(U.USERNAME) like UPPER('%'||#{paramsMap.whrname}||'%')
		    )
		</if>
		<if test="dprtcode != null">
		    and D.DPRTCODE = #{dprtcode}
		</if>
		<if test="bz != null and bz != ''">
		    and UPPER(D.BZ) like UPPER('%'||#{bz}||'%')
		</if>
		
		<if test="paramsMap != null and paramsMap.idList != null and paramsMap.idList != ''">
		    and D.ID not in
     			 <foreach item="item" index="index" collection="paramsMap.idList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
	</sql>
	
		<!-- 搜索参数 -->
	<sql id="MaterialWinParam">
		<!--id-->
		<if test="id != null and id != ''">
			and D.ID = #{id}
		</if>
		<if test="keyword != null and keyword != ''">
		    and (UPPER(D.BJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.CJJH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(D.BZ) like UPPER('%'||#{keyword}||'%')
		    )
		</if>
		<if test="hcjz != null">
		    and D.HCJZ = #{hcjz}
		</if>
		<if test="gljb != null">
		    and D.GLJB = #{gljb}
		</if>
		<if test="sxkz != null">
		    and D.SXKZ = #{sxkz}
		</if>
		<if test="hclx != null">
		    and D.HCLX = #{hclx}
		</if>
		<if test="hclxEj != null">
		    and D.HCLX_EJ = #{hclxEj}
		</if>
		<if test="isMel != null">
		    and D.IS_MEL = #{isMel}
		</if>
		
		<if test="paramsMap != null and paramsMap.whrqBegin != null and paramsMap.whrqBegin != ''">
		    and D.CJSJ &gt;= to_date(#{paramsMap.whrqBegin, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS') 
		</if>
		<if test="paramsMap != null and paramsMap.whrqEnd != null and paramsMap.whrqEnd != ''">
		    and D.CJSJ &lt;= to_date(#{paramsMap.whrqEnd, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS') 
		</if>

		<if test="paramsMap != null and paramsMap.whrname != null and paramsMap.whrname != ''">
		    and (UPPER(U.REALNAME) like UPPER('%'||#{paramsMap.whrname}||'%')
		    or UPPER(U.USERNAME) like UPPER('%'||#{paramsMap.whrname}||'%')
		    )
		</if>
		<if test="dprtcode != null">
		    and D.DPRTCODE = #{dprtcode}
		</if>
		<if test="bz != null and bz != ''">
		    and UPPER(D.BZ) like UPPER('%'||#{bz}||'%')
		</if>
		
		<if test="paramsMap != null and paramsMap.existsBjhList != null and paramsMap.existsBjhList != ''">
		    and D.BJH not in
     			 <foreach item="item" index="index" collection="paramsMap.existsBjhList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
		
		<if test="paramsMap != null and paramsMap.idList != null and paramsMap.idList != ''">
		    and D.ID not in
     			 <foreach item="item" index="index" collection="paramsMap.idList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
		
		<if test="paramsMap != null and paramsMap.hclxList != null and paramsMap.hclxList != ''">
		    and D.HCLX in
     			 <foreach item="item" index="index" collection="paramsMap.hclxList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
	</sql>
	
	<!-- 根据查询条件分页查询航材信息(弹窗需要的数据) -->
	<select id="queryWinAllPageList" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="MaterialJoinMap">
	
		select D.ID, D.BJH,D.jhly, D.DPRTCODE, D.ZWMS, D.YWMS, D.JLDW, D.CJJH, D.ZJH, D.HCJZ, D.GLJB, D.SXKZ, D.HCLX, D.HCLX_EJ, D.ZZCS,
  				   D.IS_MEL, D.MIN_KCL, D.MAX_KCL, D.BZ,D.XH,D.GG,D.XINGH, D.ZT, D.BMID, D.CJRID, D.CJSJ, D.BZJH,KC.KCSL AS KCSL,
  				   D005.ZJH AS FZJH,D005.ZWMS AS FZWMS,D005.YWMS AS FYWMS
           from D_008 D
           left join (select h.bjh,h.DPRTCODE,sum(h.kcsl) as KCSL from b_h_001 h where 
           	h.cklb in (5,6,7,8)
           	<if test="dprtcode != null">
			    and h.DPRTCODE = #{dprtcode}
			</if>
           	 and h.zt = 2 group by h.bjh,h.DPRTCODE) KC
           on D.bjh = KC.bjh and d.DPRTCODE = kc.DPRTCODE and d.zt = 1
           left join D_005 D005
   		on D.ZJH = D005.ZJH and D.DPRTCODE = D005.DPRTCODE
   		
           where D.ZT = 1
           	<include refid="MaterialWinParam"></include>
           <!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>                       
	    		order by D.ID ${pagination.order}
	    	</when>
	    	<otherwise>
			    order by ${pagination.sort} ${pagination.order}
	    	</otherwise>
		</choose>
		
	</select>
	
	<!-- 根据查询条件分页查询航材信息 -->
	<select id="queryAllPageList" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="MaterialToUserMap">
		select 
           	<include refid="Material_User_List" />
           	,t.dprtname
           from D_008 D
           left join T_USER U
           on D.CJRID = U.ID
           left join D_005 D005
           on D.ZJH = D005.ZJH and D.DPRTCODE = D005.DPRTCODE and d.zt = 1
           left join t_department t on d.dprtcode = t.id
           where D.ZT = 1
           	<include refid="MaterialParam"></include>
           <!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>                       
	    		order by D.CJSJ ${pagination.order},D.bjh asc
	    	</when>
	    	<otherwise>
			    order by ${pagination.sort} ${pagination.order},D.bjh asc
	    	</otherwise>
		</choose>
	</select>
	
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from D_008
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    insert into D_008 (ID, BJH,jhly, DPRTCODE, 
      ZWMS, YWMS, JLDW, CJJH, 
      ZJH, HCJZ, GLJB, SXKZ, 
      HCLX, HCLX_EJ, IS_MEL, 
      MIN_KCL, MAX_KCL, BZ,XH,
      XINGH,GG,
      ZT, BMID, CJRID, CJSJ,ZZCS
      )
    values (#{id,jdbcType=VARCHAR}, #{bjh,jdbcType=VARCHAR},#{jhly,jdbcType=VARCHAR}, #{dprtcode,jdbcType=VARCHAR}, 
      #{zwms,jdbcType=VARCHAR}, #{ywms,jdbcType=VARCHAR}, #{jldw,jdbcType=VARCHAR}, #{cjjh,jdbcType=VARCHAR}, 
      #{zjh,jdbcType=VARCHAR}, #{hcjz,jdbcType=DECIMAL}, #{gljb,jdbcType=DECIMAL}, #{sxkz,jdbcType=DECIMAL}, 
      #{hclx,jdbcType=DECIMAL}, #{hclxEj,jdbcType=DECIMAL}, #{isMel,jdbcType=DECIMAL}, 
      #{minKcl,jdbcType=DECIMAL}, #{maxKcl,jdbcType=DECIMAL}, #{bz,jdbcType=VARCHAR}, #{xh,jdbcType=VARCHAR},
      #{xingh,jdbcType=VARCHAR},#{gg,jdbcType=VARCHAR},
      #{zt,jdbcType=DECIMAL}, #{bmid,jdbcType=VARCHAR}, #{cjrid,jdbcType=VARCHAR}, sysdate,#{zzcs,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    insert into D_008
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="bjh != null" >
        BJH,
      </if>
      <if test="jhly != null" >
        JHLY,
      </if>
      <if test="bzjh !=null">
        BZJH,
      </if>     
      <if test="gse !=null">
        GSE,
      </if> 
      <if test="zzjbs !=null">
      ZZJBS,
      </if>    
      <if test="dprtcode != null" >
        DPRTCODE,
      </if>
      <if test="zwms != null" >
        ZWMS,
      </if>
      <if test="ywms != null" >
        YWMS,
      </if>
      <if test="jldw != null" >
        JLDW,
      </if>
      <if test="cjjh != null" >
        CJJH,
      </if>
      <if test="zjh != null" >
        ZJH,
      </if>
      <if test="hcjz != null" >
        HCJZ,
      </if>
      <if test="gljb != null" >
        GLJB,
      </if>
      <if test="sxkz != null" >
        SXKZ,
      </if>
      <if test="hclx != null" >
        HCLX,
      </if>
      <if test="hclxEj != null" >
        HCLX_EJ,
      </if>
      <if test="isMel != null" >
        IS_MEL,
      </if>
      <if test="minKcl != null" >
        MIN_KCL,
      </if>
      <if test="maxKcl != null" >
        MAX_KCL,
      </if>
      <if test="bz != null" >
        BZ,
      </if>
      <if test="xh != null" >
        XH,
      </if>
      <if test="xingh != null" >
        XINGH,
      </if>
      <if test="gg != null" >
        GG,
      </if>
      <if test="zt != null" >
        ZT,
      </if>
      <if test="bmid != null" >
        BMID,
      </if>
      <if test="zzcs != null" >
        ZZCS,
      </if>
      <if test="cjrid != null" >
        CJRID,
      </if>
        CJSJ,
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="bjh != null" >
        #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="jhly != null" >
        #{jhly,jdbcType=VARCHAR},
      </if>
      <if test="bzjh !=null">
       #{bzjh,jdbcType=VARCHAR},
      </if>
      <if test="gse !=null">
       #{gse,jdbcType=VARCHAR},
      </if>
       <if test="zzjbs !=null">
       #{zzjbs,jdbcType=DECIMAL},
      </if>
      <if test="dprtcode != null" >
        #{dprtcode,jdbcType=VARCHAR},
      </if>
      <if test="zwms != null" >
        #{zwms,jdbcType=VARCHAR},
      </if>
      <if test="ywms != null" >
        #{ywms,jdbcType=VARCHAR},
      </if>
      <if test="jldw != null" >
        #{jldw,jdbcType=VARCHAR},
      </if>
      <if test="cjjh != null" >
        #{cjjh,jdbcType=VARCHAR},
      </if>
      <if test="zjh != null" >
        #{zjh,jdbcType=VARCHAR},
      </if>
      <if test="hcjz != null" >
        #{hcjz,jdbcType=DECIMAL},
      </if>
      <if test="gljb != null" >
        #{gljb,jdbcType=DECIMAL},
      </if>
      <if test="sxkz != null" >
        #{sxkz,jdbcType=DECIMAL},
      </if>
      <if test="hclx != null" >
        #{hclx,jdbcType=DECIMAL},
      </if>
      <if test="hclxEj != null" >
        #{hclxEj,jdbcType=DECIMAL},
      </if>
      <if test="isMel != null" >
        #{isMel,jdbcType=DECIMAL},
      </if>
      <if test="minKcl != null" >
        #{minKcl,jdbcType=DECIMAL},
      </if>
      <if test="maxKcl != null" >
        #{maxKcl,jdbcType=DECIMAL},
      </if>
      <if test="bz != null" >
        #{bz,jdbcType=VARCHAR},
      </if>
      <if test="xh != null" >
        #{xh,jdbcType=VARCHAR},
      </if>
      <if test="xingh != null" >
        #{xingh,jdbcType=VARCHAR},
      </if>
      <if test="gg != null" >
        #{gg,jdbcType=VARCHAR},
      </if>
      <if test="zt != null" >
        #{zt,jdbcType=DECIMAL},
      </if>
      <if test="bmid != null" >
        #{bmid,jdbcType=VARCHAR},
      </if>
      <if test="zzcs != null" >
        #{zzcs,jdbcType=VARCHAR},
      </if>
      <if test="cjrid != null" >
        #{cjrid,jdbcType=VARCHAR},
      </if>
        sysdate,
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    update D_008
    <set >
      <if test="bjh != null" >
        BJH = #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="jhly != null" >
        JHLY = #{jhly,jdbcType=VARCHAR},
      </if>
       <if test="bzjh != null" >
        BZJH = #{bzjh,jdbcType=VARCHAR},
      </if>
       <if test="gse != null" >
        GSE = #{gse,jdbcType=VARCHAR},
      </if>
      <if test="zzjbs != null" >
        ZZJBS = #{zzjbs,jdbcType=DECIMAL},
      </if>
<!--       <if test="dprtcode != null" > -->
<!--         DPRTCODE = #{dprtcode,jdbcType=VARCHAR}, -->
<!--       </if> -->
      <if test="zwms != null" >
        ZWMS = #{zwms,jdbcType=VARCHAR},
      </if>
      <if test="ywms != null" >
        YWMS = #{ywms,jdbcType=VARCHAR},
      </if>
      <if test="jldw != null" >
        JLDW = #{jldw,jdbcType=VARCHAR},
      </if>
      <if test="cjjh != null" >
        CJJH = #{cjjh,jdbcType=VARCHAR},
      </if>
      <if test="zjh != null" >
        ZJH = #{zjh,jdbcType=VARCHAR},
      </if>
      <if test="hcjz != null" >
        HCJZ = #{hcjz,jdbcType=DECIMAL},
      </if>
      <if test="gljb != null" >
        GLJB = #{gljb,jdbcType=DECIMAL},
      </if>
      <if test="sxkz != null" >
        SXKZ = #{sxkz,jdbcType=DECIMAL},
      </if>
      <if test="hclx != null" >
        HCLX = #{hclx,jdbcType=DECIMAL},
      </if>
      <if test="hclx != null" >
        HCLX_EJ = #{hclxEj,jdbcType=DECIMAL},
      </if>
      <if test="isMel != null" >
        IS_MEL = #{isMel,jdbcType=DECIMAL},
      </if>
      <if test="minKcl != null" >
        MIN_KCL = #{minKcl,jdbcType=DECIMAL},
      </if>
      <if test="maxKcl != null" >
        MAX_KCL = #{maxKcl,jdbcType=DECIMAL},
      </if>
      <if test="bz != null" >
        BZ = #{bz,jdbcType=VARCHAR},
      </if>
      <if test="xh != null" >
        XH = #{xh,jdbcType=DECIMAL},
      </if>
      <if test="xingh != null" >
        XINGH = #{xingh,jdbcType=DECIMAL},
      </if>
      <if test="gg != null" >
        GG = #{gg,jdbcType=DECIMAL},
      </if>
      <if test="zt != null" >
        ZT = #{zt,jdbcType=DECIMAL},
      </if>
      <if test="bmid != null" >
        BMID = #{bmid,jdbcType=VARCHAR},
      </if>
      <if test="cjrid != null" >
        CJRID = #{cjrid,jdbcType=VARCHAR},
      </if>
      <if test="cjrid != null" >
        CJSJ = sysdate,
      </if>
      <if test="zzcs != null" >
        ZZCS = #{zzcs,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    update D_008
    set BJH = #{bjh,jdbcType=VARCHAR},
      JHLY = #{jhly,jdbcType=VARCHAR},
<!--       DPRTCODE = #{dprtcode,jdbcType=VARCHAR}, -->
      ZWMS = #{zwms,jdbcType=VARCHAR},
      YWMS = #{ywms,jdbcType=VARCHAR},
      JLDW = #{jldw,jdbcType=VARCHAR},
      CJJH = #{cjjh,jdbcType=VARCHAR},
      ZJH = #{zjh,jdbcType=VARCHAR},
      HCJZ = #{hcjz,jdbcType=DECIMAL},
      GLJB = #{gljb,jdbcType=DECIMAL},
      SXKZ = #{sxkz,jdbcType=DECIMAL},
      HCLX = #{hclx,jdbcType=DECIMAL},
      HCLX_EJ = #{hclxEj,jdbcType=DECIMAL},
      IS_MEL = #{isMel,jdbcType=DECIMAL},
      MIN_KCL = #{minKcl,jdbcType=DECIMAL},
      MAX_KCL = #{maxKcl,jdbcType=DECIMAL},
      BZ = #{bz,jdbcType=VARCHAR},
      XH = #{xh,jdbcType=VARCHAR},
      XINGH = #{xingh,jdbcType=VARCHAR},
      GG = #{gg,jdbcType=VARCHAR},
      ZT = #{zt,jdbcType=DECIMAL},
      BMID = #{bmid,jdbcType=VARCHAR},
      CJRID = #{cjrid,jdbcType=VARCHAR},
      CJSJ = #{cjsj,jdbcType=TIMESTAMP},
      ZZCS = #{zzcs,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <!-- 修改部件基本信息 -->
  <update id="updateBasicInformationById" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    update D_008
    set ZWMS = #{zwms,jdbcType=VARCHAR},
      jhly = #{jhly,jdbcType=VARCHAR},
      YWMS = #{ywms,jdbcType=VARCHAR},
      JLDW = #{jldw,jdbcType=VARCHAR},
      CJJH = #{cjjh,jdbcType=VARCHAR},
      ZJH = #{zjh,jdbcType=VARCHAR},
      IS_MEL = #{isMel,jdbcType=DECIMAL},
      BZ = #{bz,jdbcType=VARCHAR},
      XH = #{xh,jdbcType=VARCHAR},
      XINGH = #{xingh,jdbcType=VARCHAR},
      GG = #{gg,jdbcType=VARCHAR},
      BMID = #{bmid,jdbcType=VARCHAR},
      CJRID = #{cjrid,jdbcType=VARCHAR},
      CJSJ = sysdate,
      ZZCS = #{zzcs,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <!-- 修改部件生产信息 -->
  <update id="updateProductionInformationById" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
    update D_008
    set HCJZ = #{hcjz,jdbcType=DECIMAL},
      GLJB = #{gljb,jdbcType=DECIMAL},
      SXKZ = #{sxkz,jdbcType=DECIMAL},
      HCLX = #{hclx,jdbcType=DECIMAL},
      HCLX_EJ = #{hclxEj,jdbcType=DECIMAL},
      MIN_KCL = #{minKcl,jdbcType=DECIMAL},
      MAX_KCL = #{maxKcl,jdbcType=DECIMAL},
      BMID = #{bmid,jdbcType=VARCHAR},
      CJRID = #{cjrid,jdbcType=VARCHAR},
      CJSJ = sysdate
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
        <!-- 工单的查询航材耗材 -->
        <sql id="HCMainDataParam">
	   where 
	   1=1
      <if test="keyword != null and keyword != ''">
		    and (UPPER(d.zwms) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.ywms) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.bjh) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
		</if> 
         <!-- 组织机构-->
         <if test="dprtcode != null and dprtcode!= ''">
            and  d.dprtcode = #{dprtcode}
         </if> 
       	<if test="hcids!=null">  
   			 and not exists (select 1 from d_008 where id=d.id and id in  
   			 <foreach item="item" index="index" collection="hcids" open="("  
       		 separator="," close=")">  
        		#{item}  
   			 </foreach> 
   			 ) 
   		</if> 
         <if test="hclxlist != null ">
            and d.hclx in
             <foreach item="item" index="index" collection="hclxlist" open="("  
       		 separator="," close=")">  
        		#{item}  
   			 </foreach> 
         </if> 
         and d.zt =1 
	</sql>
  
  <select id="selectHCList" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
		select d.id, d.zwms, d.ywms, d.bjh, d.jldw, d.hclx,d.xingh, t1.kykcsl,
			t6.tdjczs,
       		t6.kcsl dxtdsl
		  from d_008 d
		  left join (select t.bjid, sum(t.kcsl) kykcsl, t.dprtcode
              from (select b_h_001.bjid, b_h_001.kcsl, b_h_001.dprtcode
                      from b_h_001
                     Where b_h_001.cklb in (0,4, 5, 6, 7, 8)
                       and b_h_001.zt = 2
                    union all
                    select b_h_003.bjid, b_h_003.kcsl, b_h_003.dprtcode
                      from b_h_003
                      join d_008
                        on b_h_003.bjid = d_008.id
                     Where d_008.hclx in (2, 3)) t
                     Group by t.bjid, t.dprtcode) t1
		          on d.id = t1.bjid
		          
			left join (select d017.dprtcode,
                    d017.bjh,
                    count(d017.bs) tdjczs,
                    sum(h001.kcsl) kcsl,
                    sum(h001.kykcsl) kykcsl
               from (select d_017.dprtcode, d_017.bjh, d_017.tdjh, 1 bs
                       from d_017
                      where d_017.zt = 1
                     union
                     select d_017.dprtcode,
                            d_017.tdjh     bjh,
                            d_017.bjh      tdjh,
                            1              bs
                       from d_017
                      where d_017.knxbs = 2
                        and d_017.zt = 1) d017
               left join (select dprtcode,
                                	  bjh,
                                sum(kcsl) kcsl,
                                sum(kcsl - (CASE WHEN djsl IS NULL THEN 0 ELSE djsl END)) kykcsl
                           from b_h_001
                          where zt = 2
                          group by dprtcode, bjh) h001
                 on d017.dprtcode = h001.dprtcode
                and d017.tdjh = h001.bjh
              group by d017.dprtcode, d017.bjh) t6
    		on d.dprtcode = t6.dprtcode
   			and d.bjh = t6.bjh

        <include refid="HCMainDataParam"></include>
  </select>
  
  <select id="selectHcxhFir" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
  <!-- 航材消耗件 -->
	<!-- 主表数据sql -->
	select b1.bjid, <!-- 部件id -->
	       b1.xqsl, <!-- 需求数量 -->
	       (CASE WHEN b3.kcsl IS NULL THEN 0 ELSE b3.kcsl END) kcsl, <!-- 库存数量 -->
		   b2.id, <!-- 部件id -->
	       b2.bjh, <!-- 部件号 -->
	       b2.zwms, <!-- 中文名称 -->
	       b2.ywms, <!-- 英文名称 -->
	       b2.jldw, <!-- 计量单位 -->
	       b2.hclx <!-- 航材类型：0其他、1航材、2设备、3工具、4危险品、5低值易耗品 -->
	  from (select t2.bjid, sum(t2.sl) xqsl, t2.dprtcode
	          from (
	              <!--   定检任务(自身工单基础id) -->
	                select a3.gdjcid
	                  from b_s_009 a1
	                  join b_g_014 a2
	                    on a1.xggdid = a2.id
		       			  and a1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>   
	                  join b_g_016 a3
	                    on a3.djrwdid = a2.id
	                union all
	                <!-- 定检任务（相关工单基础id） -->
	                select b5.xgjcgdid gdjcid
	                  from b_s_009 b1
	                  join b_g_014 b2
	                    on b1.xggdid = b2.id
	                     and b1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach> 
	                  join b_g_016 b3
	                    on b3.djrwdid = b2.id
	                  join b_g_013 b4
	                    on b3.djgkid = b4.id
	                  join b_g_00605 b5
	                    on b4.gdjcid = b5.mainid
	                union all
	                <!-- 非例行任务（自身工单基础id。包含：1时控件任务、2附加任务、3排故任务） -->
	                select c2.gdjcid
	                  from b_s_009 c1
	                  join b_g_007 c2
	                    on c1.xggdid = c2.id
	                       and c1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                union all
	                <!-- 非例行任务（相关工单基础id） -->
	                select d3.xgjcgdid gdjcid
	                  from b_s_009 d1
	                  join b_g_007 d2
	                    on d1.xggdid = d2.id
	                   and d1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                  join b_g_00605 d3
	                    on d2.gdjcid = d3.mainid
	                union all
	                <!-- EO工单任务（自身工单基础id） -->
	                select e2.gdjcid
	                  from b_s_009 e1
	                  join b_g_010 e2
	                    on e1.xggdid = e2.id
	                    and e1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                union all
	                <!-- EO工单任务（相关工单基础id） -->
	                select f3.xgjcgdid gdjcid
	                  from b_s_009 f1
	                  join b_g_010 f2
	                    on f1.xggdid = f2.id
	                     and f1.id in 
		       			 <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>   
	                  join b_g_00605 f3
	                    on f2.gdjcid = f3.mainid) t1
	          join b_g_00601 t2
	            on t1.gdjcid = t2.mainid
	           and t2.zt = 1
	           and t2.lx in ('0', '1', '4', '5') 
	         group by t2.bjid , t2.dprtcode) b1
	  left join d_008 b2
	    on b1.bjid = b2.id
	  left join (    select b_h_001.bjid, sum(b_h_001.kcsl) as kcsl,b_h_001.dprtcode
	                 from b_h_001 
	                 Where b_h_001.cklb in (0,4, 5, 6, 7, 8)
	                 and b_h_001.zt = 2
	                 Group by b_h_001.bjid, b_h_001.dprtcode
	              ) b3
	    on b1.bjid = b3.bjid
	    and b1.dprtcode = b3.dprtcode
	    
    	<if test='paramsMap.type == "Lack"'>
    		 where  (CASE WHEN b1.xqsl IS NULL THEN 0 ELSE b1.xqsl END) > (CASE WHEN b3.kcsl IS NULL THEN 0 ELSE b3.kcsl END)
    	</if>
  </select>
  
  
 <select id="selectHcxhSec" resultMap="HcTaskInfoResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
 
select distinct t2.bjid,  
       t1.rwlx,  
       t1.rwzlx,  
       t1.rwxx,  
       t1.rwgdid gdid,  
       t1.rwgdbh ,  
       t1.xh 
      <!--  ,t1.rwxx -->
      <!--  ,t1.gdjcid -->
      ,t1.xh
      
  from (
       
        select a1.rwlx,
                a1.rwzlx,
                a2.id     rwgdid,
                a2.djrwbh rwgdbh,
                a4.nbxh   xh,
                a3.gdjcid
                ,'定检'||':'||(CASE WHEN a2.djrwbh IS NULL THEN '' ELSE a2.djrwbh END)||' '||(CASE WHEN a2.ywms IS NULL THEN '' ELSE a2.ywms END)||(CASE WHEN a2.zwms IS NULL THEN '' ELSE a2.zwms END) ||'/'|| (CASE WHEN a4.nbxh IS NULL THEN '' ELSE a4.nbxh END) rwxx
                
          from b_s_009 a1
          join b_g_014 a2
            on a1.xggdid = a2.id
           and a1.id in 
 				<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_016 a3
            on a3.djrwdid = a2.id
          join b_g_013 a4
            on a3.djgkid = a4.id
        union all
         
        select b1.rwlx,
                b1.rwzlx,
                b2.id     rwgdid,
                b2.djrwbh rwgdbh,
                b4.nbxh   xh,
                b5.xgjcgdid gdjcid 
                 
                ,'定检'||':'||(CASE WHEN b2.djrwbh IS NULL THEN '' ELSE b2.djrwbh END)||' '||(CASE WHEN b2.ywms IS NULL THEN '' ELSE b2.ywms END)||(CASE WHEN b2.zwms IS NULL THEN '' ELSE b2.zwms END) ||'/'|| (CASE WHEN b4.nbxh IS NULL THEN '' ELSE b4.nbxh END) rwxx
          from b_s_009 b1
          join b_g_014 b2
            on b1.xggdid = b2.id
           and b1.id in 
      			<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
          		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_016 b3
            on b3.djrwdid = b2.id
          join b_g_013 b4
            on b3.djgkid = b4.id
          join b_g_00605 b5
            on b4.gdjcid = b5.mainid
             and b5.xggd_lx != 5
        union all
         
        select c1.rwlx,
                c1.rwzlx,
                c2.id rwgdid,
                c2.gdbh rwgdbh,
                '' xh,
                c2.gdjcid
                 
                ,'非例行工单'||':'||(CASE WHEN c2.gdbh IS NULL THEN '' ELSE c2.gdbh END)||' '||(CASE WHEN c2.zhut IS NULL THEN '' ELSE c2.zhut END) rwxx
          from b_s_009 c1
          join b_g_007 c2
            on c1.xggdid = c2.id
           and c1.id in 
            	<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
        union all

        select d1.rwlx,
                d1.rwzlx,
                d2.id rwgdid,
                d2.gdbh rwgdbh,
                '' xh,
                d3.xgjcgdid gdjcid
                
                ,'非例行工单'||':'||(CASE WHEN d2.gdbh IS NULL THEN '' ELSE d2.gdbh END)||' '||(CASE WHEN d2.zhut IS NULL THEN '' ELSE d2.zhut END) rwxx

          from b_s_009 d1
          join b_g_007 d2
            on d1.xggdid = d2.id
           and d1.id in
 				<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_00605 d3
            on d2.gdjcid = d3.mainid
        union all
         
        select e1.rwlx,
                e1.rwzlx,
                e2.id rwgdid,
                e2.gdbh rwgdbh,
                '' xh,
                e2.gdjcid
                 
                ,'EO工单'||':'||(CASE WHEN e2.gdbh IS NULL THEN '' ELSE e2.gdbh END)||' '||(CASE WHEN e2.zhut IS NULL THEN '' ELSE e2.zhut END) rwxx
          from b_s_009 e1
          join b_g_010 e2
            on e1.xggdid = e2.id
           and e1.id in 
 				<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
        union all
         
        select f1.rwlx,
                f1.rwzlx,
                f2.id rwgdid,
                f2.gdbh rwgdbh,
                '' xh,
                f3.xgjcgdid gdjcid
                
                ,'EO工单'||':'||(CASE WHEN f2.gdbh IS NULL THEN '' ELSE f2.gdbh END)||' '||(CASE WHEN f2.zhut IS NULL THEN '' ELSE f2.zhut END) rwxx
          from b_s_009 f1
          join b_g_010 f2
            on f1.xggdid = f2.id
           and f1.id in 
 				<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_00605 f3
            on f2.gdjcid = f3.mainid) t1
  join b_g_00601 t2
    on t1.gdjcid = t2.mainid
   and t2.zt = 1
   and t2.lx in (0, 1, 4, 5) 
   order by t2.bjid,t1.rwxx
  
  </select> 
  
   
  
  
  <!-- 工单，工卡分任务显示 -->
  
  <select id="selectHcxhThi" resultMap="HcRelOrdersResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
  select rownum id,
      t2.bjid,  
         t1.rwgdid,  
         t1.gdid,  
         t1.gdbh, 
         t1.zgdid,  
         t1.zgdbh  
         ,t1.scheduleCheck
         ,t1.masterBill
         ,t1.gdlx
         ,t1.gdjcid
         ,t1.xh
    from (
        select a3.gdjcid,
                a2.id rwgdid,
                a3.id gdid,
                a3.gdbh,
                '' zgdid,
                '' zgdbh
                 ,1 gdlx
                 ,'1' scheduleCheck
	             ,'1' masterBill
	             ,a4.nbxh xh
	                 
                  
          from b_s_009 a1
          join b_g_014 a2
            on a1.xggdid = a2.id
           and a1.id in  
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_016 a3
            on a3.djrwdid = a2.id
          join b_g_013 a4
            on a3.djgkid = a4.id
        union all
              select 
                
              	b5.xgjcgdid gdjcid,
                b2.id     rwgdid,
                b6.id     gdid,
                b6.gdbh,
                b3.id     zgdid,
                b3.gdbh   zgdbh,
                b6.gdlx,
                '1' scheduleCheck,
                '0' masterBill
                 ,b4.nbxh   xh
          from b_s_009 b1
          join b_g_014 b2
            on b1.xggdid = b2.id
           and b1.id in 
 			<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_016 b3
            on b3.djrwdid = b2.id
          join b_g_013 b4
            on b3.djgkid = b4.id
          join b_g_00605 b5
            on b4.gdjcid = b5.mainid
            join 
			(
	           select id, gdbh,5 gdlx  from b_g_013
                union all
                select id, gdbh, 1 gdlx from b_g_016
                union all
                  select id, gdbh, 2 gdlx from  b_g_007 
                   union all
                  select id, gdbh, 3 gdlx from  B_G_010  
          
           ) b6
            on b6.id = b5.xggdid
            
        union all
      <!--   非例行任务（自身工单基础id。包含：1时控件任务、2附加任务、3排故任务） -->
        select c2.gdjcid,
                c2.id rwgdid,
                c2.id gdid,
                c2.gdbh,
                '' zgdid,
                '' zgdbh
                 , 2 gdlx,
                '0' scheduleCheck,
                '1' masterBill
                ,'' xh
          from b_s_009 c1
          join b_g_007 c2
            on c1.xggdid = c2.id
           and c1.id in 
             <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
        union all
          select d3.xgjcgdid gdjcid,
                d2.id       rwgdid,
                d4.id       gdid,
                d4.gdbh,
                d2.id       zgdid,
                d2.gdbh     zgdbh
                , d4.gdlx gdlx,
                '0' scheduleCheck,
                '0' masterBill
                ,'' xh
          from b_s_009 d1
          join b_g_007 d2
            on d1.xggdid = d2.id
           and d1.id in 
             <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_00605 d3
               on d2.gdjcid = d3.mainid
          join (
	           select id, gdbh,5 gdlx  from b_g_013
                union all
                select id, gdbh, 1 gdlx from b_g_016
                union all
                  select id, gdbh, 2 gdlx from  b_g_007 
                   union all
                  select id, gdbh, 3 gdlx from  B_G_010  
               
          )d4 on d4.id = d3.xggdid 
          
        union all
       <!--  EO工单任务（自身工单基础id） -->
        select e2.gdjcid,
                e2.id rwgdid,
                e2.id gdid,
                e2.gdbh,
                '' zgdid,
                '' zgdbh
                ,3 gdlx,
                '0' scheduleCheck,
                '1' masterBill
                ,'' xh
          from b_s_009 e1
          join b_g_010 e2
            on e1.xggdid = e2.id
           and e1.id in 
             <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
        union all
        <!-- EO工单任务（相关工单基础id） -->
          select f3.xgjcgdid gdjcid,
                f2.id       rwgdid,
                f4.id       gdid,
                f4.gdbh,
                f2.id       zgdid,
                f2.gdbh     zgdbh
                  ,3 gdlx,
                '0' scheduleCheck,
                '0' masterBill
                ,'' xh
          from b_s_009 f1
          join b_g_010 f2
            on f1.xggdid = f2.id
           and f1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
           		#{item}  
      		  </foreach>
          join b_g_00605 f3
            on f2.gdjcid = f3.mainid
          join (
	            select id, gdbh,5 gdlx  from b_g_013
                union all
                select id, gdbh, 1 gdlx from b_g_016
                union all
                  select id, gdbh, 2 gdlx from  b_g_007 
                   union all
                  select id, gdbh, 3 gdlx from  B_G_010  
          
               ) f4
            on f4.id = f3.xggdid 
            ) t1
	  join b_g_00601 t2
	    on t1.gdjcid = t2.mainid
	   and t2.zt = 1
	   and t2.lx in ('0', '1', '4', '5')  
	   
  </select>
 
  
  <select id="selectToolDemandFir" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
	  select  b1.bjid, <!-- 部件id -->
	       b1.xqsl, <!-- 需求数量 -->
	       (CASE WHEN b3.kcsl IS NULL THEN 0 ELSE b3.kcsl END) kcsl, <!-- 库存数量 -->
	       b2.id, <!-- 部件ID -->
	       b2.bjh, <!-- 部件号 -->
	       b2.zwms, <!-- 中文名称 -->
	       b2.ywms, <!-- 英文名称 -->
	       b2.jldw, <!-- 计量单位 -->
	       b2.hclx <!-- 航材类型：0其他、1航材、2设备、3工具、4危险品、5低值易耗品 -->
	  <!-- from (select t2.bjid, max(t2.sl) xqsl, t2.dprtcode -->
	  from (select t2.bjid, sum(t2.sl) xqsl, t2.dprtcode
	          from (
	                <!-- 定检任务(自身工单基础id) -->
	                select a3.gdjcid
	                  from b_s_009 a1
	                  join b_g_014 a2
	                    on a1.xggdid = a2.id
	                   and a1.id in 
						<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  

	                  join b_g_016 a3
	                    on a3.djrwdid = a2.id
	                union all
	                <!-- 定检任务（相关工单基础id） -->
	                select b5.xgjcgdid gdjcid
	                  from b_s_009 b1
	                  join b_g_014 b2
	                    on b1.xggdid = b2.id
	                   and b1.id in 
	                   <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                  join b_g_016 b3
	                    on b3.djrwdid = b2.id
	                  join b_g_013 b4
	                    on b3.djgkid = b4.id
	                  join b_g_00605 b5
	                    on b4.gdjcid = b5.mainid
	                union all
	                <!-- 非例行任务（自身工单基础id。包含：1时控件任务、2附加任务、3排故任务） -->
	                select c2.gdjcid
	                  from b_s_009 c1
	                  join b_g_007 c2
	                    on c1.xggdid = c2.id
	                   and c1.id in 
	                   <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                union all
	                <!-- 非例行任务（相关工单基础id） -->
	                select d3.xgjcgdid gdjcid
	                  from b_s_009 d1
	                  join b_g_007 d2
	                    on d1.xggdid = d2.id
	                   and d1.id in 
	                   <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                  join b_g_00605 d3
	                    on d2.gdjcid = d3.mainid
	                union all
	                <!-- EO工单任务（自身工单基础id） -->
	                select e2.gdjcid
	                  from b_s_009 e1
	                  join b_g_010 e2
	                    on e1.xggdid = e2.id
	                   and e1.id in 
	                   <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                union all
	                <!-- EO工单任务（相关工单基础id） -->
	                select f3.xgjcgdid gdjcid
	                  from b_s_009 f1
	                  join b_g_010 f2
	                    on f1.xggdid = f2.id
	                   and f1.id in  
	                   <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
		           		 separator="," close=")">  
		            		#{item}  
		       			 </foreach>  
	                  join b_g_00605 f3
	                    on f2.gdjcid = f3.mainid) t1
	          join b_g_00601 t2
	            on t1.gdjcid = t2.mainid
	           and t2.zt = 1
	           and t2.lx in ('2', '3')
	         group by t2.bjid, t2.dprtcode
	         ) b1
	  left join d_008 b2
	    on b1.bjid = b2.id
	  
	    left join (select t.bjid, sum(t.kcsl) as kcsl, t.dprtcode
               from (select b_h_001.bjid, b_h_001.kcsl, b_h_001.dprtcode
                       from b_h_001
                       Where b_h_001.cklb in (0, 4, 5, 6, 7, 8)
                       and b_h_001.zt = 2
                     
                        union all
	                     select b_h_003.bjid, b_h_003.kcsl, b_h_003.dprtcode
	                     from b_h_003 join d_008 on b_h_003.bjid = d_008.id
	                     Where d_008.hclx in (2, 3)
                      ) t
              Group by t.bjid, t.dprtcode) b3
    on b1.bjid = b3.bjid
    
    <if test='paramsMap.type == "Lack"'>
   		 where  (CASE WHEN b1.xqsl IS NULL THEN 0 ELSE b1.xqsl END) > (CASE WHEN b3.kcsl IS NULL THEN 0 ELSE b3.kcsl END)
   	</if>
  </select>
   
  
    
      <!-- 工单，工卡分主工单显示 -->
   <select id="selectToolDemandSec" resultMap="HcTaskInfoResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
   
	<!-- 任务自身工单信息 -->
	select distinct t2.bjid, 
	       t1.rwlx,  
	       t1.rwzlx,  
	       t1.rwxx,  
	       t1.rwgdid gdid,  
	       t1.rwgdbh,  
	       t1.xh  
	        <!-- ,t1.gdjcid -->
	  from ( 
	  
        <!-- 定检任务(自身工单基础id) -->
        select a1.rwlx,
                a1.rwzlx,
                '定检'||':'||(CASE WHEN a2.djrwbh IS NULL THEN '' ELSE a2.djrwbh END)||' '||(CASE WHEN a2.ywms IS NULL THEN '' ELSE a2.ywms END)||(CASE WHEN a2.zwms IS NULL THEN '' ELSE a2.zwms END) ||'/'|| (CASE WHEN a4.nbxh IS NULL THEN '' ELSE a4.nbxh END) rwxx,
                 a2.id     rwgdid,
                 a2.djrwbh rwgdbh,
                a4.nbxh   xh,
                a3.gdjcid
          from b_s_009 a1
          join b_g_014 a2
            on a1.xggdid = a2.id
           and a1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_016 a3
            on a3.djrwdid = a2.id
          join b_g_013 a4
            on a3.djgkid = a4.id
        union all
        <!-- 定检任务（相关工单基础id） -->
        select b1.rwlx,
                b1.rwzlx,
                '定检'||':'||(CASE WHEN b2.djrwbh IS NULL THEN '' ELSE b2.djrwbh END)||' '||(CASE WHEN b2.ywms IS NULL THEN '' ELSE b2.ywms END)||(CASE WHEN b2.zwms IS NULL THEN '' ELSE b2.zwms END) ||'/'|| (CASE WHEN b4.nbxh IS NULL THEN '' ELSE b4.nbxh END) rwxx,
                 b2.id     rwgdid,
                 b2.djrwbh rwgdbh,
                b4.nbxh   xh,
                b5.xgjcgdid gdjcid
          from b_s_009 b1
          join b_g_014 b2
            on b1.xggdid = b2.id
           and b1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_016 b3
            on b3.djrwdid = b2.id
          join b_g_013 b4
            on b3.djgkid = b4.id
          join b_g_00605 b5
            on b4.gdjcid = b5.mainid
        union all
        <!-- 非例行任务（自身工单基础id。包含：1时控件任务、2附加任务、3排故任务） -->
        select c1.rwlx,
                c1.rwzlx,
                '非例行工单'||':'||(CASE WHEN c2.gdbh IS NULL THEN '' ELSE c2.gdbh END)||' '||(CASE WHEN c2.zhut IS NULL THEN '' ELSE c2.zhut END) rwxx,
                c2.id rwgdid,
                c2.gdbh rwgdbh,
                '' xh,
                c2.gdjcid
          from b_s_009 c1
          join b_g_007 c2
            on c1.xggdid = c2.id
           and c1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
        union all
        <!-- 非例行任务（相关工单基础id） -->
        select d1.rwlx,
                d1.rwzlx,
                '非例行工单'||':'||(CASE WHEN d2.gdbh IS NULL THEN '' ELSE d2.gdbh END)||' '||(CASE WHEN d2.zhut IS NULL THEN '' ELSE d2.zhut END) rwxx,
                d2.id rwgdid,
                d2.gdbh rwgdbh,
                '' xh,
                d3.xgjcgdid gdjcid
          from b_s_009 d1
          join b_g_007 d2
            on d1.xggdid = d2.id
           and d1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_00605 d3
            on d2.gdjcid = d3.mainid
        union all
        <!-- EO工单任务（自身工单基础id） -->
        select e1.rwlx,
                e1.rwzlx,
                'EO工单'||':'||(CASE WHEN e2.gdbh IS NULL THEN '' ELSE e2.gdbh END)||' '||(CASE WHEN e2.zhut IS NULL THEN '' ELSE e2.zhut END) rwxx,
                e2.id rwgdid,
                e2.gdbh rwgdbh,
                '' xh,
                e2.gdjcid
          from b_s_009 e1
          join b_g_010 e2
            on e1.xggdid = e2.id
           and e1.id in 
			<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
        union all
        <!-- EO工单任务（相关工单基础id） -->
        select f1.rwlx,
                f1.rwzlx,
                'EO工单'||':'||(CASE WHEN f2.gdbh IS NULL THEN '' ELSE f2.gdbh END)||' '||(CASE WHEN f2.zhut IS NULL THEN '' ELSE f2.zhut END) rwxx,
                f2.id rwgdid,
                f2.gdbh rwgdbh,
                '' xh,
                f3.xgjcgdid gdjcid
          from b_s_009 f1
          join b_g_010 f2
            on f1.xggdid = f2.id
           and f1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_00605 f3
            on f2.gdjcid = f3.mainid
            
	     ) t1
	  join b_g_00601 t2
	    on t1.gdjcid = t2.mainid
	   and t2.zt = 1
	   and t2.lx in ('2', '3')
    order by t2.bjid,t1.rwxx
  
  </select>
  
  <!-- 工单，工卡分主工单显示 -->
<select id="selectToolDemandThi" resultMap="HcRelOrdersResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
<!-- 任务：工单-主工单 -->
select t2.bjid,  
       t1.rwgdid,  
       t1.gdid,  
       t1.gdbh,  
       t1.zgdid,  
       t1.zgdbh  
       ,t1.scheduleCheck
       ,t1.masterBill
       ,t1.gdlx
       ,t1.gdjcid
       ,t1.xh
  from (
        <!-- 定检任务(自身工单基础id) -->
        select a3.gdjcid,
                a2.id rwgdid,
                a3.id gdid,
                a3.gdbh,
                '' zgdid,
                '' zgdbh,
                 1 gdlx,
                '1' scheduleCheck,
                '1' masterBill
                 ,a4.nbxh xh
          from b_s_009 a1
          join b_g_014 a2
            on a1.xggdid = a2.id
           and a1.id in 
		<foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_016 a3
            on a3.djrwdid = a2.id
          join b_g_013 a4
            on a3.djgkid = a4.id
        union all
        <!-- 定检任务（相关工单基础id） -->
        select  b5.xgjcgdid gdjcid,
                b2.id     rwgdid,
                b6.id     gdid,
                b6.gdbh,
                b3.id     zgdid,
                b3.gdbh   zgdbh,
                 b6.gdlx,
                '1' scheduleCheck,
                '0' masterBill
                ,b4.nbxh   xh
          from b_s_009 b1
          join b_g_014 b2
            on b1.xggdid = b2.id
           and b1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_016 b3
            on b3.djrwdid = b2.id
          join b_g_013 b4
            on b3.djgkid = b4.id
          join b_g_00605 b5
            on b4.gdjcid = b5.mainid
          join 
			(
	            select id, gdbh,5 gdlx  from b_g_013
                union all
                select id, gdbh, 1 gdlx from b_g_016
                union all
                select id, gdbh, 2 gdlx from  b_g_007 
                 union all
                select id, gdbh, 3 gdlx from  B_G_010                
                
           ) b6
            on b6.id = b5.xggdid
            
        union all
        <!-- 非例行任务（自身工单基础id。包含：1时控件任务、2附加任务、3排故任务） -->
        select c2.gdjcid,
                c2.id rwgdid,
                c2.id gdid,
                c2.gdbh,
                '' zgdid,
                '' zgdbh,
                 2 gdlx,
                '0' scheduleCheck,
                '1' masterBill
                ,'' xh
          from b_s_009 c1
          join b_g_007 c2
            on c1.xggdid = c2.id
           and c1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
        union all
        <!-- 非例行任务（相关工单基础id） -->
        select d3.xgjcgdid gdjcid,
                d2.id       rwgdid,
                d4.id       gdid,
                d4.gdbh,
                d2.id       zgdid,
                d2.gdbh     zgdbh,
                 2 gdlx,
                '0' scheduleCheck,
                '0' masterBill
                 ,'' xh
          from b_s_009 d1
          join b_g_007 d2
            on d1.xggdid = d2.id
           and d1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_00605 d3
            on d2.gdjcid = d3.mainid
          join (
	           select id, gdbh,5 gdlx  from b_g_013
                union all
                select id, gdbh, 1 gdlx from b_g_016
                union all
                  select id, gdbh, 2 gdlx from  b_g_007 
                   union all
                  select id, gdbh, 3 gdlx from  B_G_010  
               
          )d4 on d4.id = d3.xggdid 
        union all
        <!-- EO工单任务（自身工单基础id） -->
        select e2.gdjcid,
                e2.id rwgdid,
                e2.id gdid,
                e2.gdbh,
                '' zgdid,
                '' zgdbh,
                 3 gdlx,
                '0' scheduleCheck,
                '1' masterBill
                 ,'' xh
          from b_s_009 e1
          join b_g_010 e2
            on e1.xggdid = e2.id
           and e1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
        union all
        <!-- EO工单任务（相关工单基础id） -->
        select f3.xgjcgdid gdjcid,
                f2.id       rwgdid,
                f4.id       gdid,
                f4.gdbh,
                f2.id       zgdid,
                f2.gdbh     zgdbh,
                 3 gdlx,
                '0' scheduleCheck,
                '0' masterBill
                 ,'' xh
          from b_s_009 f1
          join b_g_010 f2
            on f1.xggdid = f2.id
           and f1.id in 
           <foreach item="item" index="index" collection="paramsMap.planTaskIds" open="("  
	           		 separator="," close=")">  
	            		#{item}  
	       			 </foreach> 
          join b_g_00605 f3
            on f2.gdjcid = f3.mainid
          join (
           select id, gdbh,5 gdlx  from b_g_013
              union all
              select id, gdbh, 1 gdlx from b_g_016
              union all
                select id, gdbh, 2 gdlx from  b_g_007 
                 union all
                select id, gdbh, 3 gdlx from  B_G_010  
          ) f4
          on f4.id = f3.xggdid 
           
       ) t1
  join b_g_00601 t2
    on t1.gdjcid = t2.mainid
   and t2.zt = 1
   and t2.lx in (2, 3)
	   
  </select>  
   
  
   <!--  查询航材成本列表参数 -->
  <sql id="MaterialCostListParam">
	    <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
			and (
				UPPER(BJH) like UPPER('%'||#{paramsMap.keyword}||'%')
				or UPPER(CJJH) like UPPER('%'||#{paramsMap.keyword}||'%')
				or UPPER(ZWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
				or UPPER(YWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    )             
		</if>
		<if test="paramsMap != null and paramsMap.dateBegin != null and paramsMap.dateBegin != ''">
		    and trunc(CBWHSJ) &gt;= trunc(to_date(#{paramsMap.dateBegin, jdbcType=VARCHAR},'yyyy-mm-dd'))  
		</if>
		<if test="paramsMap != null and paramsMap.dateEnd != null and paramsMap.dateEnd != ''">
		    and trunc(CBWHSJ) &lt;= trunc(to_date(#{paramsMap.dateEnd, jdbcType=VARCHAR},'yyyy-mm-dd'))
		</if> 
		  <if test="paramsMap != null and paramsMap.hclx != null  and paramsMap.hclx != ''">                      
            and  hclx = #{paramsMap.hclx,jdbcType=DECIMAL} 
         </if>
          <if test="paramsMap != null and paramsMap.gljb!= null and paramsMap.gljb != ''">                      
            and  gljb = #{paramsMap.gljb,jdbcType=DECIMAL} 
          </if>
          <if test="paramsMap != null and paramsMap.sxkz!= null  and paramsMap.sxkz != ''">                              
            and  sxkz = #{paramsMap.sxkz,jdbcType=DECIMAL} 
          </if>
          <if test="paramsMap != null and paramsMap.dprtcode!= null  and paramsMap.dprtcode!= ''" >            <!-- 组织机构  -->
            and  dprtcode  = #{paramsMap.dprtcode,jdbcType=VARCHAR}
          </if>
          <if test="id != null and id != ''" >            <!-- 组织机构  -->
            and  id  = #{id}
          </if>
	</sql>
  <!--  查询航材成本列表 -->
  
  
  <select id="selectMaterialCostList" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData">
	         
            SELECT ID,  BJH, DPRTCODE,  ZWMS, YWMS, JLDW, CJJH, ZJH, HCJZ,GLJB, 
            
            SXKZ,HCLX, HCLX_EJ, IS_MEL,  MIN_KCL, MAX_KCL,BZ,XH,ZT,BMID,
            
            MAINID, JUESCB, JIESCB, GSCB, WHRID, CBWHSJ,
            
            USERNAME,REALNAME,zjhms
           
            FROM (SELECT a.ID ,a.BJH, a.DPRTCODE, a.ZWMS, a.YWMS, a.JLDW, a.CJJH, a.ZJH, a.HCJZ,  a.GLJB, 
            
                 a.SXKZ,a.HCLX,a.HCLX_EJ,a.IS_MEL,a.MIN_KCL,a.MAX_KCL,a.BZ,a.XH,a.ZT, a.BMID, 
      
                 b.MAINID, b.JUESCB, b.JIESCB, b.GSCB, b.WHRID, b.WHSJ as CBWHSJ,
                 
                 row_number() over(partition by a.id ORDER BY b.whsj DESC) as  SN,
                 
                 c.username,c.realname,d.dprtname,e.zjh ||' '|| e.zwms zjhms  
                 
                 FROM  D_008 a  left join D_00803 b on a.id=b.mainid
                 
                 left join  t_user c on b.WHRID=c.id   
                 
                 left join  t_department d on a.dprtcode=d.id
                 
                 left join d_005 e on a.zjh=e.zjh AND A.DPRTCODE = E.DPRTCODE
                 
                 Where a.zt=1
                ) 
			where SN = 1 <include refid="MaterialCostListParam"></include>
           
           <choose>
	    	<when test='pagination.sort == "auto"'>
	    		order by CBWHSJ desc 
	    	</when>
	    	<otherwise>
			    order by ${pagination.sort} ${pagination.order}
	    	</otherwise>
		 </choose>	
  </select>
  
 	 <!-- 根据部件ID、部件号查询 -->
  	<select id="selectBybjs" resultMap="BaseResultMap">
  		select 
  		<include refid="Base_Column_List"></include>
  		from d_008 where 
  		<trim prefix="(" suffix=")" prefixOverrides="or">
	    	<if test="bjIdList != null">
		    	ID in
		    	<foreach collection="bjIdList" open="(" close=")" item="idItem" separator=",">
		    		#{idItem}
		    	</foreach>
	    	</if>
	    	<if test="bjhList != null">
		    	or BJH in
		    	<foreach collection="bjhList" open="(" close=")" item="idItem" separator=",">
		    		#{idItem}
		    	</foreach>
	    	</if>
    	</trim>
    	and zt = 1
  		and dprtcode = #{dprtcode, jdbcType=VARCHAR}
  	</select>
  	
  	 <!-- 查询所有航材主数据 -->
  	<select id="selectAllByDprtcode" parameterType="java.lang.String" resultMap="BaseResultMap">
  		select 
  		<include refid="Base_Column_List"></include>
  		from d_008  
    	where zt = 1 and dprtcode = #{dprtcode, jdbcType=VARCHAR}
  	</select>
  	<update id="updateByBjhDprtcode" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData">
		update D_008
		set BJH = #{bjh,jdbcType=VARCHAR},
		DPRTCODE = #{dprtcode,jdbcType=VARCHAR},
		JHLY=#{jhly,jdbcType=VARCHAR},
		BZJH=#{bzjh,jdbcType=VARCHAR},
		GSE=#{gse,jdbcType=VARCHAR},
		ZZCS=#{zzcs,jdbcType=VARCHAR},
		ZZJBS=#{zzjbs,jdbcType=DECIMAL},
		ZWMS = #{zwms,jdbcType=VARCHAR},
		YWMS = #{ywms,jdbcType=VARCHAR},
		JLDW = #{jldw,jdbcType=VARCHAR},
		CJJH = #{cjjh,jdbcType=VARCHAR},
		ZJH = #{zjh,jdbcType=VARCHAR},
		HCJZ = #{hcjz,jdbcType=DECIMAL},
		GLJB = #{gljb,jdbcType=DECIMAL},
		SXKZ = #{sxkz,jdbcType=DECIMAL},
		HCLX = #{hclx,jdbcType=DECIMAL},
		HCLX_EJ = #{hclxEj,jdbcType=DECIMAL},
		IS_MEL = #{isMel,jdbcType=DECIMAL},
		MIN_KCL = #{minKcl,jdbcType=DECIMAL},
		MAX_KCL = #{maxKcl,jdbcType=DECIMAL},
		BZ = #{bz,jdbcType=VARCHAR},
		XH = #{xh,jdbcType=VARCHAR},
		XINGH = #{xingh,jdbcType=VARCHAR},
		GG = #{gg,jdbcType=VARCHAR},
		ZT = #{zt,jdbcType=DECIMAL},
		BMID = #{bmid,jdbcType=VARCHAR},
		CJRID = #{cjrid,jdbcType=VARCHAR},
		CJSJ = sysdate
		where  BJH = #{bjh} and DPRTCODE = #{dprtcode} and zt=1
	</update>
	
	<!-- 根据件号和组织机构查询 -->
	<select id="selectByBjhAndDprt" parameterType="map" resultMap="MaterialJoinMap">
  		SELECT 
  		<include refid="Material_User_List" />
  		FROM D_008 D
  		LEFT JOIN D_005 D005 ON D.ZJH = D005.ZJH AND D.DPRTCODE = D005.DPRTCODE and d.zt = 1
  		LEFT JOIN T_USER U ON D.CJRID = U.ID
  		WHERE 
  		D.BJH = #{bjh, jdbcType=VARCHAR}
  		AND D.DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
  		AND D.ZT = 1
  	</select>
  	
  	<!-- 根据件号和组织机构查询 -->
	<select id="checkUptById" parameterType="java.lang.String" resultMap="BaseResultMap">
  		SELECT 
  		<include refid="Base_Column_List" />
  		FROM D_008 D
  		where 
			(
			   exists(select 1 FROM B_H_017 BH017 WHERE BH017.BJID = D.ID)
		  	<!-- or exists(select 1 FROM B_S_003 BS003 WHERE BS003.JH = D.BJH and BS003.DPRTCODE = D.DPRTCODE and BS003.ZT IN (1,2)) -->
		  	or exists(select 1 FROM B_S2_004 BS2004 WHERE BS2004.BJH = D.BJH and BS2004.DPRTCODE = D.DPRTCODE and BS2004.YXBS = 1)
		  	or exists(select 1 FROM B_H_010 BH010 WHERE BH010.JH = D.BJH and BH010.DPRTCODE = D.DPRTCODE)
			or exists(
				select 1 FROM B_H_00201 BH00201
				LEFT JOIN B_H_002 BH002
				ON BH002.ID = BH00201.MAINID
				WHERE BH00201.BJID = D.ID and BH002.ZT NOT IN (8)
			)
			or exists(
				select 1 FROM B_H_01801 BH01801
				LEFT JOIN B_H_018 BH018
				ON BH018.ID = BH01801.MAINID
				WHERE BH01801.BJID = D.ID and BH018.ZT NOT IN (8)
			)
			)
			and D.ID = #{id,jdbcType=VARCHAR} 
  	</select>
  	
  	<!-- 作废部件 -->
  	<update id="cancel" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData">
		update D_008 D
		set 
		D.ZT = #{zt,jdbcType=VARCHAR},
		D.BMID = #{bmid,jdbcType=VARCHAR},
		D.CJRID = #{cjrid,jdbcType=VARCHAR},
		D.CJSJ = sysdate
		where D.ID = #{id,jdbcType=VARCHAR} 
	</update>
  	
  	<!-- 修改装机清单时，同步航材主数据 -->
  	<update id="updateByLoadingList" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData">
		update D_008
		set 
		ZWMS = #{zwms,jdbcType=VARCHAR},
		YWMS = #{ywms,jdbcType=VARCHAR},
		CJJH = #{cjjh,jdbcType=VARCHAR},
		ZJH  = #{zjh,jdbcType=VARCHAR},
		GLJB = #{gljb,jdbcType=DECIMAL},
		HCLX = 1,
		CJRID = #{cjrid,jdbcType=VARCHAR},
		CJSJ = sysdate
		where  BJH = #{bjh} and DPRTCODE = #{dprtcode} and zt=1
	</update>
	<select id="getHcByDprtcode" parameterType="java.lang.String" resultMap="BaseResultMap" >
		select 
           	<include refid="Base_Column_List" />
           from D_008
           where  DPRTCODE = #{dprtcode}
	</select>
	
	<!-- 根据部件号、机构代码查询耗材 -->
	<select id="selectBjhAndDprt" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
		select d.id, d.zwms, d.ywms, d.bjh, d.jldw, d.hclx, t1.kykcsl
		  from d_008 d
		  left join (select t.bjid, sum(t.kcsl) kykcsl, t.dprtcode
              		from b_h_001 t
                    Where t.zt = 2
                    Group by t.bjid, t.dprtcode) t1
		  on d.id = t1.bjid
        where d.dprtcode = #{dprtcode}
        	and 
	      		(
		      	 	d.bjh in
		            (select D017.TDJH from D_017 D017 where D017.DPRTCODE = #{dprtcode} AND D017.BJH = #{bjh} AND D017.ZT = 1)
		            OR
		            d.bjh in 
		            (select D017.BJH from D_017 D017 where D017.DPRTCODE = #{dprtcode} AND D017.TDJH = #{bjh} AND D017.KNXBS = 2 AND D017.ZT = 1)
	      		)
  	</select>
  	
  	<select id="selectWinList" resultMap="MaterialJoinMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
		select d.id, d.zwms, d.ywms, d.bjh, d.jldw, d.jhly, d.hclx,d.xingh, d.HCLX_EJ, t1.kykcsl,
			t6.tdjczs,
       		t6.kcsl dxtdsl,
       		D017.TDJXX <!-- 替代件信息：替代件号+库存数量+冻结数量+替代件描述   可用数量=库存数量-冻结数量 -->
		  from d_008 d
		  left join (select t.bjid, sum(t.kcsl) kykcsl, t.dprtcode
              from (select b_h_001.bjid, b_h_001.kcsl, b_h_001.dprtcode
                      from b_h_001
                     Where b_h_001.cklb in (0,4, 5, 6, 7, 8)
                       and b_h_001.zt = 2
                    union all
                    select b_h_003.bjid, b_h_003.kcsl, b_h_003.dprtcode
                      from b_h_003
                      join d_008
                        on b_h_003.bjid = d_008.id
                     Where d_008.hclx in (2, 3)) t
                     Group by t.bjid, t.dprtcode) t1
		          on d.id = t1.bjid
		          
			left join (select d017.dprtcode,
                    d017.bjh,
                    count(d017.bs) tdjczs,
                    sum(h001.kcsl) kcsl,
                    sum(h001.kykcsl) kykcsl
               from (select d_017.dprtcode, d_017.bjh, d_017.tdjh, 1 bs
                       from d_017
                      where d_017.zt = 1
                     union
                     select d_017.dprtcode,
                            d_017.tdjh     bjh,
                            d_017.bjh      tdjh,
                            1              bs
                       from d_017
                      where d_017.knxbs = 2
                        and d_017.zt = 1) d017
               left join (select dprtcode,
                                	  bjh,
                                sum(kcsl) kcsl,
                                sum(kcsl - (CASE WHEN djsl IS NULL THEN 0 ELSE djsl END)) kykcsl
                           from b_h_001
                          where zt = 2
                          group by dprtcode, bjh) h001
                 on d017.dprtcode = h001.dprtcode
                and d017.tdjh = h001.bjh
              group by d017.dprtcode, d017.bjh) t6
    		on d.dprtcode = t6.dprtcode
   			and d.bjh = t6.bjh
   			
   			<!-- 等效替代件库存信息 -->
		  	LEFT JOIN (SELECT D017.DPRTCODE,
		                    D017.BJH,
		                    WM_CONCAT(D017.TDJH || '#_#' || H001.TDJKCSL || '#_#' ||
		                              H001.TDJDJSL || '#_#' || D017.TDJMS) TDJXX
		               FROM (SELECT D_017.DPRTCODE,
		                            D_017.BJH,
		                            D_017.TDJH,
		                            D_017.TDJMS
		                       FROM D_017
		                      WHERE D_017.ZT = 1
		                     UNION
		                     SELECT D_017.DPRTCODE,
		                            D_017.TDJH     BJH,
		                            D_017.BJH      TDJH,
		                            D_017.TDJMS
		                       FROM D_017
		                      WHERE D_017.KNXBS = 2
		                        AND D_017.ZT = 1) D017
		               LEFT JOIN (SELECT H001.DPRTCODE,
		                                H001.BJH,
		                                SUM(H001.KCSL) TDJKCSL,
		                                SUM(H001.DJSL) TDJDJSL
		                           FROM B_H_001 H001
		                          WHERE H001.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		                            AND H001.ZT = 2
		                          GROUP BY H001.DPRTCODE, H001.BJH) H001
		                 ON H001.DPRTCODE = D017.DPRTCODE
		                AND H001.BJH = D017.TDJH
		              GROUP BY D017.DPRTCODE, D017.BJH) D017
		    ON D017.DPRTCODE = d.DPRTCODE
		   AND D017.BJH = d.bjh

        <include refid="Main_Win_Data_Param"></include>
        order by d.bjh asc
  	</select>
  	
	<sql id="Main_Win_Data_Param">
	   	where 
		d.zt =1
      	<if test="keyword != null and keyword != ''">
		    and (UPPER(d.zwms) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.ywms) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.bjh) like UPPER('%'||#{keyword}||'%') )            <!--  左右匹配 查询关键字 -->
		</if> 
		<!-- 组织机构-->
        <if test="dprtcode != null and dprtcode!= ''">
           	and  d.dprtcode = #{dprtcode}
        </if> 
        <if test="paramsMap != null and paramsMap.hclx != null and paramsMap.hclx != ''">
		    and d.HCLX = #{paramsMap.hclx}
		</if>
        <if test="paramsMap != null and paramsMap.existsBjhList != null and paramsMap.existsBjhList != ''">
		    and d.BJH not in
     			 <foreach item="item" index="index" collection="paramsMap.existsBjhList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
		<if test="paramsMap != null and paramsMap.existsIdList != null and paramsMap.existsIdList != ''">
		    and d.ID not in
     			 <foreach item="item" index="index" collection="paramsMap.existsIdList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
		<if test="paramsMap != null and paramsMap.hclxlist != null and paramsMap.hclxlist != ''">
		    and d.HCLX in
     			 <foreach item="item" index="index" collection="paramsMap.hclxlist" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		</if>
	</sql>
  	<select id="selectPartList" resultMap="BaseResultMap" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" >
  		select 
    	d.ID, d.BJH, d.DPRTCODE, d.ZWMS, d.YWMS, d.JLDW, d.CJJH, d.ZJH, d.HCJZ, d.GLJB, d.SXKZ, d.HCLX, d.HCLX_EJ, 
    	d.IS_MEL, d.MIN_KCL,d.MAX_KCL, d.BZ,d.XH,d.GG,d.XINGH, d.ZT, d.BMID, d.CJRID, d.CJSJ
    	from D_008 d
    	where  d.zt=1  AND d.dprtcode = #{dprtcode,jdbcType=VARCHAR}
    	AND D.GLJB=3
    	<if test="keyword != null and keyword != ''">
		    and (UPPER(d.ZWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.YWMS) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.XINGH) like UPPER('%'||#{keyword}||'%')
		    	or UPPER(d.BJH) like UPPER('%'||#{keyword}||'%')  )           <!--  左右匹配 查询关键字 -->
		</if>
  	</select>
  	
  	<!-- 根据组织机构获取部件前十条数据 -->
  	<select id="queryLimitTen" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="BaseResultMap">
  		select 
  		<include refid="Base_Column_List"></include>
  		from (      
	  		select 
	  		<include refid="Base_Column_List"></include>
	  		,row_number() over (order by bjh)rn
	  		from d_008  
	    	where zt = 1 and dprtcode = #{dprtcode, jdbcType=VARCHAR} and upper(bjh) like UPPER('%'||#{bjh}||'%')
	    ) where rn &lt;= 10
  	</select>
  	
  	<!-- 装机清单更新部件主数据 -->
  	<update id="updateByInstallationList" parameterType="com.eray.thjw.produce.po.InstallationListEditable">
		UPDATE D_008
			SET 
				ZWMS = #{zwmc,jdbcType=VARCHAR},
				YWMS = #{ywmc,jdbcType=VARCHAR},
				CJJH = #{cjjh,jdbcType=VARCHAR},
				ZJH  = #{zjh,jdbcType=VARCHAR},
				XINGH = #{xh,jdbcType=DECIMAL},
				JLDW = #{jldw,jdbcType=VARCHAR}
		WHERE  BJH = #{bjh,jdbcType=VARCHAR} AND DPRTCODE = #{dprtcode,jdbcType=VARCHAR} AND ZT = 1
	</update>
	
	
	 <select id="selectByBjhAndXlh" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="certificateMap">
   		select t1.bjh,
		       t1.xlh,
		       t1.pch,
		       t1.DPRTCODE,
		       d008.xingh,
		       t1.zwms,
		       t1.ywms,
		       d008.zjh,
		       d008.cjjh,
		       d008.jhly,
		       D005.ZWMS zjhzwms, --章节号中文名称
	       	   D005.YWMS zjhywms, --章节号英文名称
	       	   C1.ID AS C1ID, C1.JH AS C1JH, C1.XLH AS C1XLH, C1.PCH AS C1PCH, C1.ZSBH AS C1ZSBH, 
   			   C1.ZSCFWZ AS C1ZSCFWZ, C1.ZJLX AS C1ZJLX, C1.QSRQ AS C1QSRQ
		  from (select distinct DPRTCODE, bjh, xlh, pch, zwmc as zwms, ywmc as ywms
		          from b_s2_004 s2004
		         where S2004.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		           AND S2004.YXBS = 1
		           AND (S2004.XLH IS NOT NULL or S2004.pch IS NOT NULL)
		        union
		        select distinct DPRTCODE, bjh, sn xlh, pch, zwms, ywms
		          from b_h_017 bh017
		         where bh017.DPRTCODE = #{dprtcode,jdbcType=VARCHAR}
		           AND (bh017.sn 
		
		 IS NOT NULL or bh017.pch IS NOT NULL)) t1
		  left join d_008 d008 on d008.dprtcode = t1.dprtcode
		                      and d008.bjh = t1.bjh
		  LEFT JOIN D_005 D005
		    ON D005.DPRTCODE = D008.DPRTCODE
		   AND D005.ZJH = D008.ZJH
		  LEFT JOIN B_H2_024 C1 ON 
	    	  CASE WHEN t1.XLH IS NULL THEN '-' ELSE t1.XLH END = C1.XLH 
	      AND CASE WHEN t1.PCH IS NULL THEN '-' ELSE t1.PCH END = C1.PCH
	      AND CASE WHEN t1.XLH IS NOT NULL THEN '-' ELSE C1.PCH END = C1.PCH
	      where 1=1
		<if test="dprtcode != null and dprtcode != '' " >   
             AND  t1.DPRTCODE  = #{dprtcode, jdbcType=VARCHAR}
        </if>
	    <if test="bjh != null and bjh != '' " >   
             AND  t1.bjh  = #{bjh, jdbcType=VARCHAR}
        </if>
        <if test="paramsMap != null and paramsMap.xlh != null and paramsMap.xlh != ''">
           and  t1.xlh = #{paramsMap.xlh }
         </if>
        <if test="paramsMap != null and paramsMap.pch != null and paramsMap.pch != ''">
           and  t1.pch = #{paramsMap.pch }
         </if>
   		
   </select>
	<!-- 查询航材证书列表 -->
	 <select id="queryAllCertificate" parameterType="com.eray.thjw.aerialmaterial.po.HCMainData" resultMap="BaseResultMap">
   		select t1.bjh,
		       t1.xlh,
		       t1.pch,
		       t1.DPRTCODE,
		       d008.xingh,
		       d008.zwms,
		       d008.ywms,
		       d008.zjh,
		       d008.cjjh,
		       d008.jhly,
		       D005.ZWMS zjhzwms, 
	       	   D005.YWMS zjhywms, 
	       	   (SELECT 1 FROM B_H2_024 C1
	         WHERE CASE WHEN t1.XLH IS NULL THEN '-' ELSE t1.XLH END = C1.XLH 
			   AND CASE WHEN t1.PCH IS NULL THEN '-' ELSE t1.PCH END = C1.PCH
			   AND t1.BJH = C1.JH
		       AND t1.DPRTCODE = C1.DPRTCODE
		       AND C1.ZT = 1
	           AND ROWNUM = 1) CERTIFICATECOUNT
		  from (select distinct DPRTCODE, bjh, xlh, case when xlh is not null then null else pch end pch
  from b_s2_004 s2004
 where S2004.DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
   AND S2004.YXBS = 1
   AND (S2004.XLH IS NOT NULL or S2004.pch IS NOT NULL)
union
select distinct DPRTCODE, bjh, sn xlh, case when sn is not null then null else pch end pch
  from b_h_017 bh017
 where bh017.DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
   AND (bh017.sn IS NOT NULL or bh017.pch IS NOT NULL)) t1
		  left join d_008 d008 on d008.dprtcode = t1.dprtcode
		                      and d008.bjh = t1.bjh
		  LEFT JOIN D_005 D005
		    ON D005.DPRTCODE = D008.DPRTCODE
		   AND D005.ZJH = D008.ZJH
		     <include refid="CertificateParam"></include>                  
   			<choose>                                                                                 
		    	<when test='pagination.sort == "auto"'>                       
		    		order by t1.bjh  		
		    	</when>
		    	<otherwise>
				    order by ${pagination.sort} ${pagination.order}
		    	</otherwise>
	 </choose> 
   		
   </select>
   
    <!-- 搜索参数 -->
  <sql id="CertificateParam">
 	 where 1=1
        <if test="keyword != null and keyword != ''">
		     AND (UPPER(t1.BJH) LIKE UPPER('%'||#{keyword}||'%')
		     OR   UPPER(t1.XLH) LIKE UPPER('%'||#{keyword}||'%')
		     OR   UPPER(t1.pch) LIKE UPPER('%'||#{keyword}||'%')
		     OR   UPPER(d008.zwms) LIKE UPPER('%'||#{keyword}||'%')
		     OR   UPPER(d008.ywms) LIKE UPPER('%'||#{keyword}||'%')
		     OR   UPPER(d008.cjjh) LIKE UPPER('%'||#{keyword}||'%')
		     	) <!-- 左右匹配 查询关键字 -->
		</if>
	    <if test="dprtcode != null and dprtcode != '' " >   
             AND  t1.DPRTCODE  = #{dprtcode, jdbcType=VARCHAR}
        </if>
	    <if test="bjh != null and bjh != '' " >   
             AND  t1.bjh  = #{bjh, jdbcType=VARCHAR}
        </if>
        <if test="paramsMap != null and paramsMap.xlh != null and paramsMap.xlh != ''">
           and  t1.xlh = #{paramsMap.xlh }
         </if>
  </sql>
	
</mapper>