<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.eray.thjw.produce.dao.MonitoringCurrentMapper" >
  <resultMap id="BaseResultMap" type="com.eray.thjw.produce.po.MonitoringCurrent" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="DPRTCODE" property="dprtcode" jdbcType="VARCHAR" />
    <result column="WHBMID" property="whbmid" jdbcType="VARCHAR" />
    <result column="WHRID" property="whrid" jdbcType="VARCHAR" />
    <result column="WHSJ" property="whsj" jdbcType="TIMESTAMP" />
    <result column="LYLX" property="lylx" jdbcType="DECIMAL" />
    <result column="LYID" property="lyid" jdbcType="VARCHAR" />
    <result column="LYBH" property="lybh" jdbcType="VARCHAR" />
    <result column="WXFAID" property="wxfaid" jdbcType="VARCHAR" />
    <result column="WXFABH" property="wxfabh" jdbcType="VARCHAR" />
    <result column="EOXC" property="eoxc" jdbcType="DECIMAL" />
    <result column="FJZCH" property="fjzch" jdbcType="VARCHAR" />
    <result column="FJXLH" property="fjxlh" jdbcType="VARCHAR" />
    <result column="ZJQDID" property="zjqdid" jdbcType="VARCHAR" />
    <result column="BJH" property="bjh" jdbcType="VARCHAR" />
    <result column="XLH" property="xlh" jdbcType="VARCHAR" />
    <result column="JSSJ" property="jssj" jdbcType="TIMESTAMP" />
    <result column="BYXJKSJID" property="byxjksjid" jdbcType="VARCHAR" />
    <result column="WZ" property="wz" jdbcType="DECIMAL" />
    <result column="HDWZ" property="hdwz" jdbcType="DECIMAL" />
    <result column="JSGS" property="jsgs" jdbcType="DECIMAL" />
    <!-- 扩充字段 start -->
    <result column="ATTACHCOUNT" property="paramsMap.attachCount" jdbcType="VARCHAR" /><!-- 附件数量 -->
    <result column="CHECKEDID" property="paramsMap.checkedId" jdbcType="VARCHAR" /><!-- 选中的监控数据id -->
    <result column="BJXH" property="paramsMap.xh" jdbcType="VARCHAR" /><!-- 型号 -->
    <result column="FJZWSTR" property="paramsMap.fjzw" jdbcType="VARCHAR" /><!-- 飞机站位 -->
    <result column="JKSCSJ" property="paramsMap.scsj" jdbcType="VARCHAR" /><!-- 监控项目+计划值+实际值-->
    <result column="JKJHSJSJ" property="paramsMap.jhsjsj" jdbcType="VARCHAR" /><!-- 监控数据-->
    <result column="ISWARNING" property="paramsMap.isWarning" jdbcType="VARCHAR" /><!-- 预警标识 -->
    <result column="KGKID" property="paramsMap.gkid" jdbcType="VARCHAR" /><!-- 工卡id-->
    <result column="KGKBH" property="paramsMap.gkbh" jdbcType="VARCHAR" /><!-- 工卡编号-->
    <result column="KGKFJ" property="paramsMap.gkfj" jdbcType="VARCHAR" /><!-- 工卡附件-->
    <result column="KGKFJID" property="paramsMap.gkfjid" jdbcType="VARCHAR" /><!-- 工卡附件id-->
    <result column="KGZNRFJID" property="paramsMap.gznrfjid" jdbcType="VARCHAR" /><!-- 工作内容附件id-->
    <result column="KGDID" property="paramsMap.gdid" jdbcType="VARCHAR" /><!-- 工单id-->
    <result column="KGDBH" property="paramsMap.gdbh" jdbcType="VARCHAR" /><!-- 工单编号-->
    <result column="KGBID" property="paramsMap.gbid" jdbcType="VARCHAR" /><!-- 工包id-->
    <result column="KGBBH" property="paramsMap.gbbh" jdbcType="VARCHAR" /><!-- 工包编号-->
    
    <result column="GDGBSTR" property="paramsMap.gdgbstr" jdbcType="VARCHAR" /><!-- 工单id,工单编号,工包id,工包编号-->
    
    <result column="KDLID" property="paramsMap.dlid" jdbcType="VARCHAR" /><!-- 大类id-->
    <result column="KJX" property="paramsMap.jx" jdbcType="VARCHAR" /><!-- 机型-->
    <result column="KDLBH" property="paramsMap.dlbh" jdbcType="VARCHAR" /><!-- 大类编号-->
    <result column="KDLZWMS" property="paramsMap.dlzwms" jdbcType="VARCHAR" /><!-- 大类中文描述-->
    <result column="KDLYWMS" property="paramsMap.dlywms" jdbcType="VARCHAR" /><!-- 大类英文描述-->
    <result column="KZJH" property="paramsMap.zjh" jdbcType="VARCHAR" /><!-- 章节号-->
    <result column="KZJHZWMS" property="paramsMap.zjhzwms" jdbcType="VARCHAR" /><!-- 章节号中文描述-->
    <result column="KZJHYWMS" property="paramsMap.zjhywms" jdbcType="VARCHAR" /><!-- 章节号英文描述-->
    <result column="KZDRUSERNAME" property="paramsMap.zdrzwms" jdbcType="VARCHAR" /><!-- 制单人中文描述述-->
    <result column="KZDRREALNAME" property="paramsMap.zdrywms" jdbcType="VARCHAR" /><!-- 制单人英文描述-->
    <result column="BZ" property="paramsMap.bz" jdbcType="VARCHAR" /><!-- 维修项目备注-->
    
    <result column="POID" property="paramsMap.id" jdbcType="VARCHAR" /><!-- 生产指令id-->
    <result column="POZLBH" property="paramsMap.zlbh" jdbcType="VARCHAR" /><!-- 生产指令编号-->
    <result column="POZLMS" property="paramsMap.zlms" jdbcType="VARCHAR" /><!-- 生产指令描述-->
    <result column="POBB" property="paramsMap.bb" jdbcType="VARCHAR" /><!-- 生产指令版本-->
    <result column="POJX" property="paramsMap.jx" jdbcType="VARCHAR" /><!-- 生产指令机型-->
    <result column="POHDWZ" property="paramsMap.hdwz" jdbcType="VARCHAR" /><!-- 生产指令后到为准-->
    <result column="POJSGS" property="paramsMap.jsgs" jdbcType="VARCHAR" /><!-- 生产指令计算公式-->
    
    <result column="ZZJG" property="paramsMap.dprtname" jdbcType="VARCHAR" /><!-- 组织机构-->
    
    <!-- 扩充字段 end -->
  </resultMap>
  
  <!-- 配置监控数据关系 注意：在写对应关系时,id字段需要重命名 -->
	<resultMap type="com.eray.thjw.produce.po.MonitoringCurrent" id="MonitoringCurrentWithRelMap" extends="BaseResultMap">  
		<!-- 配置监控数据与用户关系 -->
	  	<association property="zdr" javaType="com.eray.thjw.po.User">  
	        <id column="ZDR_ID" property="id"/>  
	        <result column="ZDR_USERNAME" property="username"/>  
	        <result column="ZDR_REALNAME" property="realname"/>  
	    </association>  
	    <!-- 配置监控数据与维修项目关系 -->
	    <association property="maintenanceProject" javaType="com.eray.thjw.project2.po.MaintenanceProject">
	    
	    	<id column="MP_ID" property="id"/>
	     	<result column="MP_RWH" property="rwh"/>
	     	<result column="MP_DPRTCODE" property="dprtcode"/>
	        <result column="MP_BB" property="bb"/>
	        <result column="MP_WXXMLX" property="wxxmlx" />
	        <result column="MP_ZJH" property="zjh" />
	        <result column="MP_CKH" property="ckh" />
	        <result column="MP_RWMS" property="rwms"/>
	        <result column="MP_GZLX" property="gzlx"/>
	        <result column="MP_GKBH" property="gkbh"/>
	        <result column="MP_ISHDWZ" property="isHdwz"/>
	        <result column="MP_JSGS" property="jsgs"/>
	    </association>
	    <!-- 配置监控数据与EO关系 -->
	    <association property="engineeringOrder" javaType="com.eray.thjw.project2.po.EngineeringOrder">
	    	<id column="EO_ID" property="id"/>
	     	<result column="EO_EOBH" property="eobh"/>
	        <result column="EO_BB" property="bb"/>
	        <result column="EO_ZJH" property="zjh"/>
	        <result column="EO_EOZT" property="eozt" />
	        <result column="EO_ZXFS" property="zxfs"/>
	        <result column="EO_GZLX" property="gzlx"/>
	        <result column="EO_HDWZ" property="hdwz"/>
	        <result column="EO_JSGS" property="jsgs"/>
	    </association>
	    <!-- 配置监控数据与附件关系 -->
	    <association property="attachment" javaType="com.eray.thjw.flightdata.po.Attachment">  
	        <id column="WCA_ID" property="id" jdbcType="VARCHAR" />
		    <result column="WCA_MAINID" property="mainid" jdbcType="VARCHAR" />
		    <result column="WCA_DPRTCODE" property="dprtcode" jdbcType="VARCHAR" />
		    <result column="WCA_YSWJM" property="yswjm" jdbcType="VARCHAR" />
		    <result column="WCA_WBWJM" property="wbwjm" jdbcType="VARCHAR" />
		    <result column="WCA_NBWJM" property="nbwjm" jdbcType="VARCHAR" />
		    <result column="WCA_WJDX" property="wjdx" jdbcType="DECIMAL" />
		    <result column="WCA_CFLJ" property="cflj" jdbcType="VARCHAR" />
		    <result column="WCA_HZM" property="hzm" jdbcType="VARCHAR" />
	    </association>
	</resultMap> 
	<!-- 
	<resultMap type="com.eray.thjw.produce.po.MonitoringCurrent" id="YcMpBaseResultMap" > 
        <id column="jksjid" property="id" jdbcType="VARCHAR" />
	    <result column="zjqdid" property="zjqdid" jdbcType="VARCHAR" />
	    <result column="lyid" property="lyid" jdbcType="VARCHAR" />
	    <result column="bjh" property="bjh" jdbcType="VARCHAR" />
	    <result column="xlh" property="xlh" jdbcType="VARCHAR" />
	    <result column="lylx" property="lylx" jdbcType="Integer" />
	    
	    <result column="dlbh" property="paramsMap.dlbh" jdbcType="VARCHAR" />
	    <result column="dlzwms" property="paramsMap.dlzwms" jdbcType="VARCHAR" />
	    <result column="dlywms" property="paramsMap.dlywms" jdbcType="VARCHAR" />
	    <result column="gkid" property="paramsMap.gkid" jdbcType="VARCHAR" />
	    <result column="gkbh" property="paramsMap.gkbh" jdbcType="VARCHAR" />
	    
	    <result column="jhsjsj" property="paramsMap.jhsjsj" jdbcType="VARCHAR" />   
        <result column="xh" property="paramsMap.xh" jdbcType="VARCHAR" />
	    <result column="gdid" property="paramsMap.gdid" jdbcType="VARCHAR" />
	    <result column="gdbh" property="paramsMap.gdbh" jdbcType="VARCHAR" />
	    <result column="gbid" property="paramsMap.gbid" jdbcType="VARCHAR" />
	    <result column="gbbh" property="paramsMap.gbbh" jdbcType="VARCHAR" />
       
	    <association property="maintenanceProject" javaType="com.eray.thjw.project2.po.MaintenanceProject">
	    	<id column="lyid" property="id"/>
	     	<result column="wxxmlx" property="wxxmlx"/>
	        <result column="zjh" property="zjh" />
	        <result column="lybh" property="rwh" />
	        <result column="bb" property="bb"/>
	        
	        <result column="ckh" property="ckh" />
	        <result column="rwms" property="rwms"/>
	        <result column="gzlx" property="gzlx"/>
	        <result column="is_hdwz" property="isHdwz"/>
	    </association>
	</resultMap> 
	
	<resultMap type="com.eray.thjw.produce.po.MonitoringCurrent" id="YcEoBaseResultMap" > 
        <id column="jksjid" property="id" jdbcType="VARCHAR" />
	    <result column="zjqdid" property="zjqdid" jdbcType="VARCHAR" />
	    <result column="lyid" property="lyid" jdbcType="VARCHAR" />
	    <result column="bjh" property="bjh" jdbcType="VARCHAR" />
	    <result column="xlh" property="xlh" jdbcType="VARCHAR" />
	    <result column="lylx" property="lylx" jdbcType="Integer" />
	    
	    <result column="fjzw" property="paramsMap.fjzw" jdbcType="VARCHAR" />
	    <result column="jhsjsj" property="paramsMap.jhsjsj" jdbcType="VARCHAR" />
	    <result column="xh" property="paramsMap.xh" jdbcType="VARCHAR" />
	    
	    <result column="gdid" property="paramsMap.gdid" jdbcType="VARCHAR" />
	    <result column="gdbh" property="paramsMap.gdbh" jdbcType="VARCHAR" />
	    <result column="gbid" property="paramsMap.gbid" jdbcType="VARCHAR" />
	    <result column="gbbh" property="paramsMap.gbbh" jdbcType="VARCHAR" />
	     
	    <association property="engineeringOrder" javaType="com.eray.thjw.project2.po.EngineeringOrder">
	    	<id column="lyid" property="id"/>
	     	<result column="lybh" property="eobh"/>
	        <result column="BB" property="bb"/>
	        <result column="zjh" property="zjh"/>
	        <result column="eozt" property="eozt" />
	        
	        <result column="zxfs" property="zxfs"/>
	        <result column="gzlx" property="gzlx"/>
	        <result column="hdwz" property="hdwz"/>
	        <result column="jsgs" property="jsgs"/>
	    </association>  
	</resultMap>  -->
	
	  
       
       
  <sql id="Base_Column_List" >
    ID, DPRTCODE, WHBMID, WHRID, WHSJ, LYLX, LYID, LYBH, WXFAID, WXFABH, EOXC, FJZCH, 
    FJXLH, ZJQDID, BJH, XLH, JSSJ, BYXJKSJID, WZ, HDWZ, JSGS
  </sql>
  
  	<sql id="Monitoring_Current_List" >
   		B.ID, B.DPRTCODE, B.WHBMID, B.WHRID, B.WHSJ, B.LYLX, B.LYID, B.LYBH, B.WXFAID, B.WXFABH, B.EOXC, B.FJZCH, 
    	B.FJXLH, B.ZJQDID, B.BJH, B.XLH, B.JSSJ, B.BYXJKSJID, B.WZ, B.HDWZ, B.JSGS
	</sql>
	
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from B_S2_902
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <!-- 获取定检包下的监控数据 -->
  	<select id="query4FixedPackage" resultType="java.lang.String" parameterType="java.lang.String" >
   		select s2902_xg.id jksjid
  		from b_s2_902 s2902
  		join b_g2_012 g2012
    	on s2902.lyid = g2012.id
   		and g2012.wxxmlx = 4
   		and s2902.lylx = 1
   		and s2902.id = #{jksjid,jdbcType=VARCHAR}
  		join b_g2_01103 g201103
    	on g201103.mainid = s2902.wxfaid
   		and g201103.wxxmid = s2902.lyid
  		join b_g2_012 g2012_xg
    	on g201103.xgwxxmid = g2012_xg.id
   		and g2012_xg.yxbs = 1
  		join b_s2_902 s2902_xg
    	on s2902_xg.dprtcode = s2902.dprtcode
   		and s2902_xg.lylx = 1
   		and s2902_xg.lyid = g2012_xg.id
   		and s2902_xg.fjzch = s2902.fjzch
 		where g2012_xg.syx = '00000'
    	or exists (select 1
        from b_g2_01203 g201203
        where g201203.mainid = g201103.xgwxxmid
        and g201203.fjzch = #{fjzch, jdbcType=VARCHAR})
   		
  </select>
  
    <!-- 根据监控数据id查询任务信息(维修项目) -->
  	<select id="selectRelProjectById" resultMap="MonitoringCurrentWithRelMap" parameterType="java.lang.String" >
	    select 
	    	<include refid="Monitoring_Current_List" />
	    	, ZDR.ID as ZDR_ID
        	, ZDR.USERNAME as ZDR_USERNAME
        	, ZDR.REALNAME as ZDR_REALNAME
        	, D005.ZJH AS KZJH
        	, D005.ZWMS AS KZJHZWMS
        	, D005.YWMS AS KZJHYWMS
        	, WCA.ID AS WCA_ID
		    , WCA.MAINID AS WCA_MAINID
		    , WCA.DPRTCODE AS WCA_DPRTCODE
		    , WCA.YSWJM AS WCA_YSWJM
		    , WCA.WBWJM AS WCA_WBWJM
		    , WCA.NBWJM AS WCA_NBWJM
		    , WCA.WJDX AS WCA_WJDX
		    , WCA.CFLJ AS WCA_CFLJ
		    , WCA.HZM AS WCA_HZM
		    , MP.ID AS MP_ID
		    , MP.BB AS MP_BB
		    , MP.RWH AS MP_RWH
		    , MP.RWMS AS MP_RWMS
		    , MP.CKH AS MP_CKH
		    , MP.GKBH AS MP_GKBH
		    , MP.IS_HDWZ AS MP_ISHDWZ
		    , MP.JSGS AS MP_JSGS
		    , d008.xingh as BJXH
		    , B13.id as KGKID
	       	, B13.gkh as KGKBH
	       	, B13.GKFJID AS KGKFJID
	       	, B13.GZNRFJID AS KGZNRFJID
	       	,D011.ATTACHCOUNT
	    from B_S2_902 B
	    JOIN B_G2_012 MP ON B.LYID = MP.ID
	    LEFT JOIN B_G2_01102 B02 ON B.WXFAID = B02.MAINID AND B.LYID = B02.WXXMID
	    LEFT JOIN B_G2_013 B13 ON B02.GKID = B13.ID and B13.zt = 7
	    LEFT JOIN D_011 WCA ON B13.GKFJID = WCA.MAINID and WCA.YXZT = 1
	    LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
        ON D011.MAINID = B13.ID
	    LEFT JOIN T_USER ZDR ON B.WHRID = ZDR.ID
        LEFT JOIN D_005 D005 on MP.DPRTCODE = D005.DPRTCODE and MP.ZJH = D005.ZJH
        LEFT JOIN D_008 d008 on d008.DPRTCODE = B.DPRTCODE and d008.BJH = B.BJH
	    where B.ID = #{id,jdbcType=VARCHAR}
	</select>
	
	<!-- 根据监控数据id查询任务信息(EO) -->
  	<select id="selectRelEOById" resultMap="MonitoringCurrentWithRelMap" parameterType="java.lang.String" >
	    select 
	    	<include refid="Monitoring_Current_List" />
	    	, ZDR.ID as ZDR_ID
        	, ZDR.USERNAME as ZDR_USERNAME
        	, ZDR.REALNAME as ZDR_REALNAME
        	, D005.ZJH AS KZJH
        	, D005.ZWMS AS KZJHZWMS
        	, D005.YWMS AS KZJHYWMS
		    , EO.ID AS EO_ID
		    , EO.BB AS EO_BB
		    , EO.EOBH AS EO_EOBH
		    , EO.EOZT AS EO_EOZT
		    , EO.ZXFS AS EO_ZXFS
		    , EO.HDWZ AS EO_HDWZ
		    , EO.JSGS AS EO_JSGS
		    , d008.xingh as BJXH
	    from B_S2_902 B
	    JOIN B_G2_010 EO ON B.LYID = EO.ID
	    LEFT JOIN T_USER ZDR ON B.WHRID = ZDR.ID
        LEFT JOIN D_005 D005 on EO.DPRTCODE = D005.DPRTCODE and EO.ZJH = D005.ZJH
        LEFT JOIN D_008 d008 on d008.DPRTCODE = B.DPRTCODE and d008.BJH = B.BJH
	    where B.ID = #{id,jdbcType=VARCHAR}
	</select>
	
	<!-- 根据监控数据id查询任务信息(生产指令) -->
  	<select id="selectRelPoById" resultMap="MonitoringCurrentWithRelMap" parameterType="java.lang.String" >
	    select 
	    	<include refid="Monitoring_Current_List" />
	    	, ZDR.ID as ZDR_ID
        	, ZDR.USERNAME as ZDR_USERNAME
        	, ZDR.REALNAME as ZDR_REALNAME
        	, D005.ZJH AS KZJH
        	, D005.ZWMS AS KZJHZWMS
        	, D005.YWMS AS KZJHYWMS
        	, WCA.ID AS WCA_ID
		    , WCA.MAINID AS WCA_MAINID
		    , WCA.DPRTCODE AS WCA_DPRTCODE
		    , WCA.YSWJM AS WCA_YSWJM
		    , WCA.WBWJM AS WCA_WBWJM
		    , WCA.NBWJM AS WCA_NBWJM
		    , WCA.WJDX AS WCA_WJDX
		    , WCA.CFLJ AS WCA_CFLJ
		    , WCA.HZM AS WCA_HZM
		    , PO.ID AS POID
		    , PO.ZLBH AS POZLBH
		    , PO.ZLMS AS POZLMS
		    , PO.BB AS POBB
		    , PO.JX AS POJX
		    , PO.IS_HDWZ AS POHDWZ
		    , PO.JSGS AS POJSGS
		    , B13.id as KGKID
	       	, B13.gkh as KGKBH
	       	, B13.GKFJID AS KGKFJID
	       	, B13.GZNRFJID AS KGZNRFJID
	       	,D011.ATTACHCOUNT
	    from B_S2_902 B
	    JOIN B_G2_014 PO ON B.LYID = PO.ID
	    LEFT JOIN B_G2_013 B13 ON PO.dprtcode = B13.dprtcode and PO.GKBH = B13.GKH and B13.zt = 7 and B13.zxbs = 2
	    LEFT JOIN D_011 WCA ON B13.GKFJID = WCA.MAINID and WCA.YXZT = 1
	    LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
        ON D011.MAINID = B13.ID
	    LEFT JOIN T_USER ZDR ON B.WHRID = ZDR.ID
        LEFT JOIN D_005 D005 on PO.DPRTCODE = D005.DPRTCODE and PO.ZJH = D005.ZJH
	    where B.ID = #{id,jdbcType=VARCHAR}
	</select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from B_S2_902
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
    insert into B_S2_902 (ID, DPRTCODE, WHBMID, 
      WHRID, WHSJ, LYLX, 
      LYID, LYBH, WXFAID, 
      WXFABH, EOXC, FJZCH, 
      FJXLH, ZJQDID, BJH, 
      XLH, JSSJ, BYXJKSJID, 
      WZ, HDWZ, JSGS)
    values (#{id,jdbcType=VARCHAR}, #{dprtcode,jdbcType=VARCHAR}, #{whbmid,jdbcType=VARCHAR}, 
      #{whrid,jdbcType=VARCHAR}, #{whsj,jdbcType=TIMESTAMP}, #{lylx,jdbcType=DECIMAL}, 
      #{lyid,jdbcType=VARCHAR}, #{lybh,jdbcType=VARCHAR}, #{wxfaid,jdbcType=VARCHAR}, 
      #{wxfabh,jdbcType=VARCHAR}, #{eoxc,jdbcType=DECIMAL}, #{fjzch,jdbcType=VARCHAR}, 
      #{fjxlh,jdbcType=VARCHAR}, #{zjqdid,jdbcType=VARCHAR}, #{bjh,jdbcType=VARCHAR}, 
      #{xlh,jdbcType=VARCHAR}, #{jssj,jdbcType=TIMESTAMP}, #{byxjksjid,jdbcType=VARCHAR}, 
      #{wz,jdbcType=DECIMAL},#{hdwz,jdbcType=DECIMAL},#{jsgs,jdbcType=DECIMAL})
  </insert>
  
  <insert id="insertSelective" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
    insert into B_S2_902
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="dprtcode != null" >
        DPRTCODE,
      </if>
      <if test="whbmid != null" >
        WHBMID,
      </if>
      <if test="whrid != null" >
        WHRID,
      </if>
      <if test="whsj != null" >
        WHSJ,
      </if>
      <if test="lylx != null" >
        LYLX,
      </if>
      <if test="lyid != null" >
        LYID,
      </if>
      <if test="lybh != null" >
        LYBH,
      </if>
      <if test="wxfaid != null" >
        WXFAID,
      </if>
      <if test="wxfabh != null" >
        WXFABH,
      </if>
      <if test="eoxc != null" >
        EOXC,
      </if>
      <if test="fjzch != null" >
        FJZCH,
      </if>
      <if test="fjxlh != null" >
        FJXLH,
      </if>
      <if test="zjqdid != null" >
        ZJQDID,
      </if>
      <if test="bjh != null" >
        BJH,
      </if>
      <if test="xlh != null" >
        XLH,
      </if>
      <if test="jssj != null" >
        JSSJ,
      </if>
      <if test="byxjksjid != null" >
        BYXJKSJID,
      </if>
      <if test="wz != null" >
        WZ,
      </if>
      <if test="hdwz != null" >
        HDWZ,
      </if>
      <if test="jsgs != null" >
        JSGS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="dprtcode != null" >
        #{dprtcode,jdbcType=VARCHAR},
      </if>
      <if test="whbmid != null" >
        #{whbmid,jdbcType=VARCHAR},
      </if>
      <if test="whrid != null" >
        #{whrid,jdbcType=VARCHAR},
      </if>
      <if test="whsj != null" >
        #{whsj,jdbcType=TIMESTAMP},
      </if>
      <if test="lylx != null" >
        #{lylx,jdbcType=DECIMAL},
      </if>
      <if test="lyid != null" >
        #{lyid,jdbcType=VARCHAR},
      </if>
      <if test="lybh != null" >
        #{lybh,jdbcType=VARCHAR},
      </if>
      <if test="wxfaid != null" >
        #{wxfaid,jdbcType=VARCHAR},
      </if>
      <if test="wxfabh != null" >
        #{wxfabh,jdbcType=VARCHAR},
      </if>
      <if test="eoxc != null" >
        #{eoxc,jdbcType=DECIMAL},
      </if>
      <if test="fjzch != null" >
        #{fjzch,jdbcType=VARCHAR},
      </if>
      <if test="fjxlh != null" >
        #{fjxlh,jdbcType=VARCHAR},
      </if>
      <if test="zjqdid != null" >
        #{zjqdid,jdbcType=VARCHAR},
      </if>
      <if test="bjh != null" >
        #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="xlh != null" >
        #{xlh,jdbcType=VARCHAR},
      </if>
      <if test="jssj != null" >
        #{jssj,jdbcType=TIMESTAMP},
      </if>
      <if test="byxjksjid != null" >
        #{byxjksjid,jdbcType=VARCHAR},
      </if>
      <if test="wz != null" >
        #{wz,jdbcType=DECIMAL},
      </if>
      <if test="hdwz != null" >
        #{hdwz,jdbcType=DECIMAL},
      </if>
      <if test="jsgs != null" >
        #{jsgs,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
    update B_S2_902
    <set >
      <!-- <if test="dprtcode != null" >
        DPRTCODE = #{dprtcode,jdbcType=VARCHAR},
      </if> -->
      <if test="whbmid != null" >
        WHBMID = #{whbmid,jdbcType=VARCHAR},
      </if>
      <if test="whrid != null" >
        WHRID = #{whrid,jdbcType=VARCHAR},
        WHSJ = sysdate,
      </if>
      <if test="lylx != null" >
        LYLX = #{lylx,jdbcType=DECIMAL},
      </if>
      <if test="lyid != null" >
        LYID = #{lyid,jdbcType=VARCHAR},
      </if>
      <if test="lybh != null" >
        LYBH = #{lybh,jdbcType=VARCHAR},
      </if>
      <if test="wxfaid != null" >
        WXFAID = #{wxfaid,jdbcType=VARCHAR},
      </if>
      <if test="wxfabh != null" >
        WXFABH = #{wxfabh,jdbcType=VARCHAR},
      </if>
      <if test="eoxc != null" >
        EOXC = #{eoxc,jdbcType=DECIMAL},
      </if>
      <if test="fjzch != null" >
        FJZCH = #{fjzch,jdbcType=VARCHAR},
      </if>
      <if test="fjxlh != null" >
        FJXLH = #{fjxlh,jdbcType=VARCHAR},
      </if>
      <if test="zjqdid != null" >
        ZJQDID = #{zjqdid,jdbcType=VARCHAR},
      </if>
      <if test="bjh != null" >
        BJH = #{bjh,jdbcType=VARCHAR},
      </if>
      <if test="xlh != null" >
        XLH = #{xlh,jdbcType=VARCHAR},
      </if>
      <if test="jssj != null" >
        JSSJ = #{jssj,jdbcType=TIMESTAMP},
      </if>
      <if test="byxjksjid != null" >
        BYXJKSJID = #{byxjksjid,jdbcType=VARCHAR},
      </if>
      <if test="wz != null" >
        WZ = #{wz,jdbcType=DECIMAL},
      </if>
      <if test="hdwz != null" >
        HDWZ = #{hdwz,jdbcType=DECIMAL},
      </if>
      <if test="jsgs != null" >
        JSGS = #{jsgs,jdbcType=DECIMAL},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <!-- 根据维修方案编号删除当前监控数据（对飞机/装机件） -->
  <delete id="deleteByMaintenanceScheme" >
    delete from B_S2_902
	 where DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
	   and FJZCH is not null
	   and WXFABH = #{wxfabh, jdbcType=VARCHAR}
  </delete>
  
  <!-- 根据飞机注册号删除当前监控数据 -->
  <delete id="deleteByFjzch" >
    delete from B_S2_902
	 where DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
	   and FJZCH = #{fjzch, jdbcType=VARCHAR}
  </delete>
  
  <!-- 根据来源编号和来源类型删除当前监控数据 -->
  <delete id="deleteByLybhAndLx" >
    delete from B_S2_902
	 where DPRTCODE = #{dprtcode, jdbcType=VARCHAR}
	   and LYBH = #{lybh, jdbcType=VARCHAR}
	   and LYLX = #{lylx, jdbcType=DECIMAL}
  </delete>
  
  <!-- 供计划预测使用 -->
  <select id="selectAll4Eo" resultType="java.util.Map"  parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	   select 
	   
	   g2010.id     lyid,
       g2010.eobh   lybh,
       g2010.zjh||' '||Z.YWMS zjh,
       g2010.bb,
       g2010.eozt rwms,      
       g2010.gzlx,       
       g2010.hdwz,
       g2010.jsgs,
       g2010.zxfs,
       g2010.hdwz is_hdwz,
       g2010.dprtcode,
	   
	   s2902.zjqdid,
       s2902.id     jksjid,
       s2902.bjh,
       s2902.xlh,
       s2902.lylx,
       COALESCE(s2902.wz, s2004.wz) wz,	
       s2902.fjzch,
       s2902.fjxlh,
       
	   
       g2995.fjzw,  
	   s2904.jhsjsj,
	    d008.xh,	
	    d008.xingh,   
       s2008.id     gdid,
       s2008.gdbh,
       s2007.id     gbid,
       s2007.gbbh
       
  from b_s2_902 s2902
  join b_g2_010 g2010
    on s2902.lyid = g2010.id
   and s2902.dprtcode = #{dprtcode, jdbcType=VARCHAR}
   and s2902.fjzch = #{fjzch, jdbcType=VARCHAR}
   and s2902.lylx = 2 --EO
  left join D_005 Z on Z.DPRTCODE = #{dprtcode, jdbcType=VARCHAR} and g2010.ZJH = Z.ZJH
  left join d_008 d008
    on d008.dprtcode = s2902.dprtcode
   and d008.bjh = s2902.bjh
  left join b_s2_008 s2008
    on s2008.jksjid = s2902.id
   and s2008.zt != 9
  left join b_s2_007 s2007
    on s2007.id = s2008.gbid
  left join (select b_g2_995.ywid, wm_concat(b_g2_995.gbh) fjzw
               from b_g2_995
              where b_g2_995.ywlx = 6
                and b_g2_995.lx = 3
              group by b_g2_995.ywid) g2995
    on g2995.ywid = g2010.id
  left join b_s2_004 s2004 on s2004.id=s2902.zjqdid
  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
               from (select t4.jksjid,
                            wm_concat(t4.jklbh || '#_#' ||  t4.jhqsz || '#_#' ||
                                       t4.jhz   || '#_#' ||  t4.sjz  || '#_#' ||
                                       t4.syz   || '#_#' ||  t4.zqz  || '#_#' ||
                                       t4.dw_zqz || '#_#' ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                          to_date(t4.jhz, 'yyyy-mm-dd') -
                                          to_date(to_char(sysdate, 'yyyy-mm-dd'),
                                               'yyyy-mm-dd') 
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.jhz is not null
                                and t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode, jdbcType=VARCHAR}
                                and t2.fjzch = #{fjzch, jdbcType=VARCHAR}
                                and t2.lylx = 2 <!-- EO -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh) t4
                                ) t6
              group by t6.jksjid) s2904
    on s2904.jksjid = s2902.id
 where 1 = 1
 
 <if test="paramsMap.keyword != null and paramsMap.keyword != ''">
        and (
        	    UPPER(g2010.eobh) like UPPER('%'||#{paramsMap.keyword}||'%' )
        	 or UPPER(g2010.eozt) like UPPER('%'||#{paramsMap.keyword}||'%' )
        	 or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%' )
	         or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%' )
	         or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%' )
          )
</if>
<if test="lylx != null">
        and   s2902.lylx = #{lylx, jdbcType=VARCHAR}
</if>

 order by g2010.eobh asc

 
  </select>
  
  
  <!-- 供计划预测使用 -->
  <select id="selectAll4Mp" resultType="java.util.Map"   parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	   select 
	   g2012.id       lyid,
       g2012.wxxmlx,
       g2012.zjh||' '||Z.YWMS zjh,
       g2012.rwh      lybh,
       g2012.bb,
       g2012.ckh,
       g2012.rwms,       
       g2012.gzlx,
	   g2012.is_hdwz,
	   g2012.dprtcode,
	   
	   s2902.id       jksjid,
       s2902.zjqdid,
       s2902.bjh,
       s2902.xlh,
	   s2902.lylx,
	   COALESCE(s2902.wz, s2004.wz) wz,	   
	   s2902.fjzch,
       s2902.fjxlh,
	   
       g201101.dlbh,
       g201101.dlzwms,
       g201101.dlywms,     
       g2013.id gkid,
       g2013.gkh gkbh,
       g2013.GKFJID AS KGKFJID, 
       g2013.GZNRFJID AS KGZNRFJID, 
       D011.ATTACHCOUNT,
       
	    s2904.jhsjsj,
	    d008.xh,	 
	    d008.xingh, 
       s2008.id       gdid,
       s2008.gdbh,
       s2007.id       gbid,
       s2007.gbbh,
       WCA.WBWJM||
       	(
       		CASE 
          	WHEN WCA.HZM is not null THEN '.'
          	WHEN WCA.HZM is null THEN ''
       		END 
   	   		)
       	||WCA.HZM GKFJ,
  		WCA.ID as GKFJID
       
  from b_s2_902 s2902
  join b_g2_012 g2012
    on s2902.lyid = g2012.id
   and s2902.dprtcode = #{dprtcode, jdbcType=VARCHAR}
   and s2902.fjzch = #{fjzch, jdbcType=VARCHAR}
   and s2902.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
  join b_g2_01101 g201101
    on g2012.wxxmdlid = g201101.id
  join b_g2_01102 g201102
    on g201102.wxxmid = g2012.id
  join b_g2_011 g2011
    on g2011.dprtcode = g2012.dprtcode
   and g2011.wxfabh = g2012.wxfabh
   and g2011.zxbs = 2
   and g2011.id = g201102.mainid
  LEFT JOIN D_005 Z on Z.DPRTCODE = #{dprtcode, jdbcType=VARCHAR} and g2012.ZJH = Z.ZJH 
  left join b_g2_013 g2013 on g2013.id = g201102.gkid and g2013.zt=7
   LEFT JOIN D_011 WCA ON g2013.GKFJID = WCA.MAINID and WCA.YXZT = 1   
  LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
   ON D011.MAINID = g2013.ID
  left join b_s2_008 s2008
    on s2008.jksjid = s2902.id
   and s2008.zt != 9
  left join b_s2_007 s2007
    on s2007.id = s2008.gbid
  left join d_008 d008
    on d008.dprtcode = s2902.dprtcode
   and d008.bjh = s2902.bjh
  left join b_s2_004 s2004 on s2004.id=s2902.zjqdid
  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
               from (select t4.jksjid,
                            wm_concat(t4.jklbh || '#_#' ||  t4.jhqsz  || '#_#' ||
                                       t4.jhz   || '#_#' ||  t4.sjz  || '#_#' ||
                                       t4.syz   || '#_#' ||  t4.zqz  || '#_#' ||
                                       t4.dw_zqz || '#_#' ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                      	to_date(t4.jhz, 'yyyy-mm-dd') -
                                       	to_date(to_char(sysdate, 'yyyy-mm-dd'),
                                               'yyyy-mm-dd') 
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode, jdbcType=VARCHAR}
                                and t2.fjzch = #{fjzch, jdbcType=VARCHAR}
                                
                                and t2.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh) t4) t6
              group by t6.jksjid) s2904
    on s2904.jksjid = s2902.id
 where 1 = 1
 <if test="paramsMap.keyword != null and paramsMap.keyword != ''">
        and (
                 UPPER(g2012.rwh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(g2012.ckh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(g2012.rwms) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%' )
          )
</if>

<if test="lylx != null">
        and   s2902.lylx = #{lylx, jdbcType=VARCHAR}
</if>


      		
/* 查询条件：ATA */
/* 查询条件：维修项目大类 */
/* 查询条件：keyword */
 order by g2012.rwh asc
 
  </select>
  
  <!-- 供计划预测使用 -->
  <select id="selectAll4Po" resultType="java.util.Map"   parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	   select 
	   g2014.id       lyid,
       g2014.zjh||' '||Z.YWMS zjh,
       g2014.zlbh      lybh,
       g2014.bb,
       g2014.zlms rwms,       
	   g2014.is_hdwz,
	   g2014.dprtcode,
	   
	   s2902.id       jksjid,
       s2902.zjqdid,
       s2902.bjh,
       s2902.xlh,
	   s2902.lylx,
	   COALESCE(s2902.wz, s2004.wz) wz,	   
	   s2902.fjzch,
       s2902.fjxlh,
       g2013.id gkid,
       g2013.gkh gkbh,
       g2013.GKFJID AS KGKFJID, 
       g2013.GZNRFJID AS KGZNRFJID, 
       D011.ATTACHCOUNT,
	    s2904.jhsjsj,
	    d008.xh,	 
	    d008.xingh, 
       s2008.id       gdid,
       s2008.gdbh,
       s2007.id       gbid,
       s2007.gbbh,
       WCA.WBWJM||
       	(
       		CASE 
          	WHEN WCA.HZM is not null THEN '.'
          	WHEN WCA.HZM is null THEN ''
       		END 
   	   		)
       	||WCA.HZM GKFJ,
  		WCA.ID as GKFJID
       
  from b_s2_902 s2902
  join b_g2_014 g2014
    on s2902.lyid = g2014.id
   and s2902.dprtcode = #{dprtcode, jdbcType=VARCHAR}
   and s2902.fjzch = #{fjzch, jdbcType=VARCHAR}
   and s2902.lylx = 3 <!-- 维修项目。如果是EO，那么就是2,如果是生产指令，那么就是3 -->
  LEFT JOIN D_005 Z on Z.DPRTCODE = #{dprtcode, jdbcType=VARCHAR} and g2014.ZJH = Z.ZJH 
  LEFT JOIN B_G2_013 g2013 ON g2014.dprtcode = g2013.dprtcode and g2014.GKBH = g2013.GKH and g2013.zt = 7 and g2013.zxbs = 2
  LEFT JOIN D_011 WCA ON g2013.GKFJID = WCA.MAINID and WCA.YXZT = 1   
  LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
   ON D011.MAINID = g2013.ID
  left join b_s2_008 s2008
    on s2008.jksjid = s2902.id
   and s2008.zt != 9
  left join b_s2_007 s2007
    on s2007.id = s2008.gbid
  left join d_008 d008
    on d008.dprtcode = s2902.dprtcode
   and d008.bjh = s2902.bjh
  left join b_s2_004 s2004 on s2004.id=s2902.zjqdid
  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
               from (select t4.jksjid,
                            wm_concat(t4.jklbh || '#_#' ||  t4.jhqsz  || '#_#' ||
                                       t4.jhz   || '#_#' ||  t4.sjz  || '#_#' ||
                                       t4.syz   || '#_#' ||  t4.zqz  || '#_#' ||
                                       t4.dw_zqz || '#_#' ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                      	to_date(t4.jhz, 'yyyy-mm-dd') -
                                       	to_date(to_char(sysdate, 'yyyy-mm-dd'),
                                               'yyyy-mm-dd') 
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode, jdbcType=VARCHAR}
                                and t2.fjzch = #{fjzch, jdbcType=VARCHAR}
                                
                                and t2.lylx = 3
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh) t4) t6
              group by t6.jksjid) s2904
    on s2904.jksjid = s2902.id
 where 1 = 1
 <if test="paramsMap.keyword != null and paramsMap.keyword != ''">
        and (
                 UPPER(g2014.zlbh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(g2014.zlms) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
	          or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%' )
          )
</if>

<if test="lylx != null">
        and   s2902.lylx = #{lylx, jdbcType=VARCHAR}
</if>
 order by g2014.zlbh asc
 
  </select>
  
  	<!-- 根据查询条件分页查询飞机维修项目监控信息 -->
  	<select id="queryAllPageMaintenanceList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
		select s2902.id,
			   s2902.dprtcode,
		       s2902.zjqdid,
		       s2902.bjh,
		       s2902.xlh,
		       s2902.whsj,
		       s2902.hdwz,
			   g2012.id AS MP_ID,
		       g2012.wxxmlx AS MP_WXXMLX,
		       g2012.zjh AS MP_ZJH,
		       g2012.rwh AS MP_RWH,
		       g2012.bb AS MP_BB,
		       g2012.ckh AS MP_CKH,
		       g2012.rwms AS MP_RWMS,
		       g2012.is_hdwz AS MP_ISHDWZ,
		       B13.id as KGKID,
	       	   B13.gkh as KGKBH,
	           B13.GKFJID AS KGKFJID,
	           B13.GZNRFJID AS KGZNRFJID,
	           D011.ATTACHCOUNT,
		       g201101.id as KDLID,
		       g201101.dlbh as KDLBH,
		       g201101.dlzwms as KDLZWMS,
		       g201101.dlywms as KDLYWMS,
		       d008.xingh as BJXH,
		       s2903.scsj as JKSCSJ,
		       s2904.jhsjsj as JKJHSJSJ,
		       Z.ZJH AS KZJH,
		       Z.ZWMS AS KZJHZWMS,
		       Z.YWMS AS KZJHYWMS,
		       U.USERNAME AS KZDRUSERNAME, 
		       U.REALNAME AS KZDRREALNAME
		  from b_s2_902 s2902
		  join b_g2_012 g2012
		    on s2902.lyid = g2012.id
		   and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		   and s2902.fjzch = #{paramsMap.fjzch}
		  join b_g2_01101 g201101
		    on g2012.wxxmdlid = g201101.id
		  join b_g2_01102 g201102
	      on g201102.wxxmid = g2012.id
	      join b_g2_011 g2011
	     on g2011.dprtcode = g2012.dprtcode
	   	 and g2011.wxfabh = g2012.wxfabh
	   	 and g2011.zxbs = 2
	   	 and g2011.id = g201102.mainid
		  LEFT JOIN B_G2_013 B13 ON g201102.GKID = B13.ID and B13.zt = 7
		  LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
	        ON D011.MAINID = B13.ID
		  left join d_008 d008
		    on d008.dprtcode = s2902.dprtcode
		   and d008.bjh = s2902.bjh
		   LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		   LEFT JOIN D_005 Z on g2012.DPRTCODE = Z.DPRTCODE and g2012.ZJH = Z.ZJH
		  left join (select t2.jksjid, max(t2.scsj) scsj
		               from (select t1.jksjid,
		                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
		                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
		                       from b_s2_903 t1
		                      where t1.zt = 1) t2
		              group by t2.jksjid) s2903
		    on s2903.jksjid = s2902.id
		  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
		               from (select t4.jksjid,
		                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
		                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
		                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
		                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
		                                      t4.ydz_qdw || '#_#' || t4.ydz_h ||
		                                      '#_#' || t4.ydz_hdw || '#_#' ||
		                                      t4.jhxlh) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
		                       from (select t4.jksjid,
		                                    t4.jklbh,
		                                    t4.jhqsz,
		                                    t4.jhz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_char(sysdate, 'yyyy-mm-dd')
		                                      else
		                                       (case
		                                         when t2.zjqdid is null then
		                                          COALESCE(t11.ljz, 0) +
		                                          COALESCE(t11.csz, 0)
		                                         else
		                                          COALESCE(t13.sj_fz, 0) +
		                                          COALESCE(t13.csz, 0)
		                                       end) || ''
		                                    end sjz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_date(t4.jhz, 'yyyy-mm-dd') -
		                                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
		                                      else
		                                       cast(t4.jhz as integer) -
		                                       (case
		                                          when t2.zjqdid is null then
		                                           COALESCE(t11.ljz, 0) +
		                                           COALESCE(t11.csz, 0)
		                                          else
		                                           COALESCE(t13.sj_fz, 0) +
		                                           COALESCE(t13.csz, 0)
		                                        end)
		                                    end syz,
		                                    t4.zqz,
		                                    t4.dw_zqz,
		                                    t4.ydz_q,
		                                    t4.ydz_qdw,
		                                    t4.ydz_h,
		                                    t4.ydz_hdw,
		                                    case
		                                      when t2.zjqdid is null then
		                                       case
		                                         when t11.jh is null then
		                                          t11.fjzch || '#_#' || t11.xlh
		                                         else
		                                          t11.jh || '#_#' || t11.xlh
		                                       end
		                                      else
		                                       t13.jh || '#_#' || t13.xlh
		                                    end jhxlh
		                               from b_s2_904 t4
		                               join b_s2_902 t2
		                                 on t4.jhz is not null
		                                and t4.zt = 1
		                                and t2.id = t4.jksjid
		                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		                                and t2.fjzch = #{paramsMap.fjzch}
		                               left join b_s2_911 t11
		                                 on t2.dprtcode = t11.dprtcode
		                                and t2.fjzch = t11.fjzch
		                                and t4.jklbh = t11.jklbh
		                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
		                               left join b_s2_913 t13
		                                 on t2.dprtcode = t13.dprtcode
		                                and t2.zjqdid = t13.zjqdid
		                                and t4.jklbh = t13.jklbh) t4) t6
		              group by t6.jksjid) s2904
		    on s2904.jksjid = s2902.id
		 where 1 = 1
		 <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
		    and (
		    	   UPPER(g2012.RWH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2012.CKH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2012.RWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.ZJH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.YWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    )
		 </if>
		 <if test="paramsMap != null and paramsMap.dlid != null and paramsMap.dlid != ''">
		    and g201101.id = #{paramsMap.dlid}
		 </if>
		 <if test="paramsMap != null and paramsMap.wxxmlxList != null and paramsMap.wxxmlxList != ''">
		    and g2012.wxxmlx in
     			 <foreach item="item" index="index" collection="paramsMap.wxxmlxList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		 </if>
		 <if test="id != null and id != ''">
		    and s2902.id = #{id}
		 </if>
		<!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>                       
	    		ORDER BY g2012.rwh asc
	    	</when>
	    	<otherwise>
			    ORDER BY ${pagination.sort} ${pagination.order}
	    	</otherwise>
		</choose>
		
  	</select>
  	
  	<!-- 根据查询条件分页查询当前监控数据(EO监控信息) -->
	<select id="queryAllPageEOList" resultMap="MonitoringCurrentWithRelMap"  parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	    select s2902.id,
		       s2902.dprtcode,
		       s2902.zjqdid,
		       s2902.bjh,
		       s2902.xlh,
		       s2902.whsj,
		       s2902.hdwz,
		       s2902.EOXC,
	    	   g2010.id as EO_ID,
		       g2010.eobh as EO_EOBH,
		       g2010.zjh as EO_ZJH,
		       g2010.bb as EO_BB,
		       g2010.eozt as EO_EOZT,
		       g2010.hdwz as EO_HDWZ,
		       g2010.jsgs as EO_JSGS,
		       g2010.zxfs as EO_ZXFS,
		       d008.xingh as BJXH,
		       s2903.scsj as JKSCSJ,
		       s2904.jhsjsj as JKJHSJSJ,
		       g2995.fjzw as FJZWSTR,
		       Z.ZJH AS KZJH,
		       Z.ZWMS AS KZJHZWMS,
		       Z.YWMS AS KZJHYWMS,
		       U.USERNAME AS KZDRUSERNAME, 
		       U.REALNAME AS KZDRREALNAME
		  from b_s2_902 s2902
		  join b_g2_010 g2010
		    on s2902.lyid = g2010.id
		   and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		   and s2902.fjzch = #{paramsMap.fjzch}
		  left join d_008 d008
		    on d008.dprtcode = s2902.dprtcode
		   and d008.bjh = s2902.bjh
		   LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		   LEFT JOIN D_005 Z on g2010.DPRTCODE = Z.DPRTCODE and g2010.ZJH = Z.ZJH
		  left join (select b_g2_995.ywid, wm_concat(b_g2_995.gbh) fjzw
		               from b_g2_995
		              where b_g2_995.ywlx = 6
		                and b_g2_995.lx = 3
		              group by b_g2_995.ywid) g2995
		    on g2995.ywid = g2010.id
		  left join (select t2.jksjid, max(t2.scsj) scsj
		               from (select t1.jksjid,
		                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
		                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
		                       from b_s2_903 t1
		                      where t1.zt = 1) t2
		              group by t2.jksjid) s2903
		    on s2903.jksjid = s2902.id
		  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
		               from (select t4.jksjid,
		                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
		                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
		                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
		                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
		                                      t4.ydz_qdw || '#_#' || t4.ydz_h ||
		                                      '#_#' || t4.ydz_hdw || '#_#' ||
		                                      t4.jhxlh) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
		                       from (select t4.jksjid,
		                                    t4.jklbh,
		                                    t4.jhqsz,
		                                    t4.jhz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_char(sysdate, 'yyyy-mm-dd')
		                                      else
		                                       (case
		                                         when t2.zjqdid is null then
		                                          COALESCE(t11.ljz, 0) +
		                                          COALESCE(t11.csz, 0)
		                                         else
		                                          COALESCE(t13.sj_fz, 0) +
		                                          COALESCE(t13.csz, 0)
		                                       end) || ''
		                                    end sjz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_date(t4.jhz, 'yyyy-mm-dd') -
		                                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
		                                      else
		                                       cast(t4.jhz as integer) -
		                                       (case
		                                          when t2.zjqdid is null then
		                                           COALESCE(t11.ljz, 0) +
		                                           COALESCE(t11.csz, 0)
		                                          else
		                                           COALESCE(t13.sj_fz, 0) +
		                                           COALESCE(t13.csz, 0)
		                                        end)
		                                    end syz,
		                                    t4.zqz,
		                                    t4.dw_zqz,
		                                    t4.ydz_q,
		                                    t4.ydz_qdw,
		                                    t4.ydz_h,
		                                    t4.ydz_hdw,
		                                    case
		                                      when t2.zjqdid is null then
		                                       case
		                                         when t11.jh is null then
		                                          t11.fjzch || '#_#' || t11.xlh
		                                         else
		                                          t11.jh || '#_#' || t11.xlh
		                                       end
		                                      else
		                                       t13.jh || '#_#' || t13.xlh
		                                    end jhxlh
		                               from b_s2_904 t4
		                               join b_s2_902 t2
		                                 on t4.jhz is not null
		                                and t4.zt = 1
		                                and t2.id = t4.jksjid
		                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		                                and t2.fjzch = #{paramsMap.fjzch}
		                               left join b_s2_911 t11
		                                 on t2.dprtcode = t11.dprtcode
		                                and t2.fjzch = t11.fjzch
		                                and t4.jklbh = t11.jklbh
		                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
		                               left join b_s2_913 t13
		                                 on t2.dprtcode = t13.dprtcode
		                                and t2.zjqdid = t13.zjqdid
		                                and t4.jklbh = t13.jklbh) t4) t6
		              group by t6.jksjid) s2904
		    on s2904.jksjid = s2902.id
		 where 1 = 1
		 <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
		    and (
		    	   UPPER(g2010.EOBH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2010.EOZT) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.ZJH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.YWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    )
		 </if>
		 <if test="id != null and id != ''">
		    and s2902.id = #{id}
		 </if>
		 <!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>                       
	    		ORDER BY g2010.eobh asc , s2902.EOXC asc
	    	</when>
	    	<otherwise>
			    ORDER BY ${pagination.sort} ${pagination.order}
	    	</otherwise>
		</choose>
    </select>
    
    <!-- 根据查询条件分页查询生产指令监控信息 -->
  	<select id="queryAllPagePOList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
		select s2902.id,
			   s2902.dprtcode,
		       s2902.zjqdid,
		       s2902.bjh,
		       s2902.xlh,
		       s2902.whsj,
		       s2902.hdwz,
			   g2014.id AS POID,
		       g2014.ZLBH AS POZLBH,
		       g2014.BB AS POBB,
		       g2014.JX AS POJX,
		       g2014.ZLMS AS POZLMS,
		       B13.id as KGKID,
	       	   B13.gkh as KGKBH,
	           B13.GKFJID AS KGKFJID,
	           B13.GZNRFJID AS KGZNRFJID,
	           D011.ATTACHCOUNT,
		       s2903.scsj as JKSCSJ,
		       s2904.jhsjsj as JKJHSJSJ,
		       Z.ZJH AS KZJH,
		       Z.ZWMS AS KZJHZWMS,
		       Z.YWMS AS KZJHYWMS,
		       U.USERNAME AS KZDRUSERNAME, 
		       U.REALNAME AS KZDRREALNAME
		  from b_s2_902 s2902
		  join b_g2_014 g2014
		    on s2902.lyid = g2014.id
		   and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		   and s2902.fjzch = #{paramsMap.fjzch}
		  LEFT JOIN B_G2_013 B13 ON g2014.dprtcode = B13.dprtcode and g2014.GKBH = B13.GKH and B13.zt = 7 and B13.zxbs = 2
		  LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
	        ON D011.MAINID = B13.ID
		   LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		   LEFT JOIN D_005 Z on g2014.DPRTCODE = Z.DPRTCODE and g2014.ZJH = Z.ZJH
		  left join (select t2.jksjid, max(t2.scsj) scsj
		               from (select t1.jksjid,
		                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
		                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
		                       from b_s2_903 t1
		                      where t1.zt = 1) t2
		              group by t2.jksjid) s2903
		    on s2903.jksjid = s2902.id
		  left join (select t6.jksjid, max(t6.jhsjsj) jhsjsj
		               from (select t4.jksjid,
		                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
		                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
		                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
		                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
		                                      t4.ydz_qdw || '#_#' || t4.ydz_h ||
		                                      '#_#' || t4.ydz_hdw || '#_#' ||
		                                      t4.jhxlh) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
		                       from (select t4.jksjid,
		                                    t4.jklbh,
		                                    t4.jhqsz,
		                                    t4.jhz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_char(sysdate, 'yyyy-mm-dd')
		                                      else
		                                       (case
		                                         when t2.zjqdid is null then
		                                          COALESCE(t11.ljz, 0) +
		                                          COALESCE(t11.csz, 0)
		                                         else
		                                          COALESCE(t13.sj_fz, 0) +
		                                          COALESCE(t13.csz, 0)
		                                       end) || ''
		                                    end sjz,
		                                    case
		                                      when t4.jklbh = '1_10' then
		                                       to_date(t4.jhz, 'yyyy-mm-dd') -
		                                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
		                                      else
		                                       cast(t4.jhz as integer) -
		                                       (case
		                                          when t2.zjqdid is null then
		                                           COALESCE(t11.ljz, 0) +
		                                           COALESCE(t11.csz, 0)
		                                          else
		                                           COALESCE(t13.sj_fz, 0) +
		                                           COALESCE(t13.csz, 0)
		                                        end)
		                                    end syz,
		                                    t4.zqz,
		                                    t4.dw_zqz,
		                                    t4.ydz_q,
		                                    t4.ydz_qdw,
		                                    t4.ydz_h,
		                                    t4.ydz_hdw,
		                                    case
		                                      when t2.zjqdid is null then
		                                       case
		                                         when t11.jh is null then
		                                          t11.fjzch || '#_#' || t11.xlh
		                                         else
		                                          t11.jh || '#_#' || t11.xlh
		                                       end
		                                      else
		                                       t13.jh || '#_#' || t13.xlh
		                                    end jhxlh
		                               from b_s2_904 t4
		                               join b_s2_902 t2
		                                 on t4.jhz is not null
		                                and t4.zt = 1
		                                and t2.id = t4.jksjid
		                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		                                and t2.fjzch = #{paramsMap.fjzch}
		                               left join b_s2_911 t11
		                                 on t2.dprtcode = t11.dprtcode
		                                and t2.fjzch = t11.fjzch
		                                and t4.jklbh = t11.jklbh
		                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
		                               left join b_s2_913 t13
		                                 on t2.dprtcode = t13.dprtcode
		                                and t2.zjqdid = t13.zjqdid
		                                and t4.jklbh = t13.jklbh) t4) t6
		              group by t6.jksjid) s2904
		    on s2904.jksjid = s2902.id
		 where 1 = 1
		 <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
		    and (
		    	   UPPER(g2014.ZLBH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2014.ZLMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2014.ZJH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.ZJH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(Z.YWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    )
		 </if>
		 <if test="id != null and id != ''">
		    and s2902.id = #{id}
		 </if>
		<!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>                       
	    		ORDER BY g2014.ZLBH asc,s2902.id
	    	</when>
	    	<otherwise>
			    ORDER BY ${pagination.sort} ${pagination.order}
	    	</otherwise>
		</choose>
		
  	</select>
    
    <!-- 根据查询条件分页查询当前监控数据(飞机维修项目监控信息)(预组包专用) -->
  	<select id="queryPackageMaintenanceList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	     select s2902.id,
	       		s2902.dprtcode,
	       		s2902.zjqdid,
	       		s2902.bjh,
	       		s2902.xlh,
	       		s2902.whsj,
	       		s2902.hdwz,
	            g2012.id AS MP_ID,
	   			g2012.wxxmlx AS MP_WXXMLX,
	       		g2012.zjh AS MP_ZJH,
	       		g2012.rwh AS MP_RWH,
	       		g2012.bb AS MP_BB,
	       		g2012.ckh AS MP_CKH,
	       		g2012.rwms AS MP_RWMS,
	       		g2012.dprtcode AS MP_DPRTCODE,
	       		g2012.gzlx AS MP_GZLX,
	       		g2012.is_hdwz AS MP_ISHDWZ,
	       		g2012.bz,
		       	g201101.id as KDLID,
		        g201101.dlbh as KDLBH,
		        g201101.dlzwms as KDLZWMS,
		        g201101.dlywms as KDLYWMS,
	       		d008.xingh as BJXH,
	       		s2903.scsj as JKSCSJ,
	       		s2904.jhsjsj as JKJHSJSJ,
	       		Z.ZJH AS KZJH,
		        Z.ZWMS AS KZJHZWMS,
		        Z.YWMS AS KZJHYWMS,
		        U.USERNAME AS KZDRUSERNAME, 
		        U.REALNAME AS KZDRREALNAME,
		       	s2904.is_warning as ISWARNING,
	       		B13.id as KGKID,
	       		B13.gkh as KGKBH,
	       		<!-- WCA.WBWJM||
	        	(
         		CASE 
		          	WHEN WCA.HZM is not null THEN '.'
		          	WHEN WCA.HZM is null THEN ''
         		END 
     	   		)
	        	||WCA.HZM KGKFJ, -->
	        	B13.GKFJID AS KGKFJID,
	        	B13.GZNRFJID AS KGZNRFJID,
	        	D011.ATTACHCOUNT,
	       		s2009.JKSJGDID as CHECKEDID,
	       		<!-- s2008.id as KGDID,
       			s2008.gdbh as KGDBH,
       			s2007.id as KGBID,
       			s2007.gbbh as KGBBH, -->
       			s20087.gdgbstr as GDGBSTR,
       			c.dprtname as ZZJG
  		from b_s2_902 s2902
  		join b_g2_012 g2012
    	on s2902.lyid = g2012.id
   		and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
   		and s2902.fjzch = #{paramsMap.fjzch}
   		and s2902.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
   		left join t_department c on s2902.DPRTCODE=c.id
  		join b_g2_01101 g201101
    	on g2012.wxxmdlid = g201101.id
	  	join b_g2_01102 g201102
	    on g201102.wxxmid = g2012.id
	  	join b_g2_011 g2011
	    on g2011.dprtcode = g2012.dprtcode
	   	and g2011.wxfabh = g2012.wxfabh
	   	and g2011.zxbs = 2
	   	and g2011.id = g201102.mainid
	   	
	   	<!-- 查询工单工包 -->
	   	
	   	left join (select s2008.jksjid
	   					 ,wm_concat(s2008.id 
	   					 			|| '#_#' || s2008.gdbh 
	   					 			|| '#_#' || s2007.id 
	   					 			|| '#_#' || s2007.gbbh
	   					 ) gdgbstr
  				from b_s2_008 s2008
  				join b_s2_902 s2902
  				on s2008.jksjid = s2902.id
  				join b_s2_007 s2007
    			on s2007.id = s2008.gbid
 				where s2008.zt != 9
   					  and s2008.dprtcode = #{dprtcode,jdbcType=VARCHAR}
   					  and s2008.fjzch = #{paramsMap.fjzch}
 				group by s2008.jksjid
 				) s20087
    	on s20087.jksjid = s2902.id	   	
	  	<!-- left join b_s2_008 s2008
	    on s2008.jksjid = s2902.id
	   	and s2008.zt != 9
	  	left join b_s2_007 s2007
	    on s2007.id = s2008.gbid -->
	  	left join d_008 d008
	    on d008.dprtcode = s2902.dprtcode
	   	and d008.bjh = s2902.bjh
	   	LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		LEFT JOIN D_005 Z on g2012.DPRTCODE = Z.DPRTCODE and g2012.ZJH = Z.ZJH
		LEFT JOIN B_G2_013 B13 ON g201102.GKID = B13.ID and B13.zt = 7
	    <!-- LEFT JOIN D_011 WCA ON B13.GKFJID = WCA.MAINID and WCA.YXZT = 1 -->
	    LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
        ON D011.MAINID = B13.ID
	    left join B_S2_009 s2009
    	on s2009.JKSJGDID = s2902.id
  		left join (select t2.jksjid, max(t2.scsj) scsj
               from (select t1.jksjid,
                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
                       from b_s2_903 t1
                      where t1.zt = 1) t2
              group by t2.jksjid) s2903
    	on s2903.jksjid = s2902.id
  		left join (select t6.jksjid,
                    case
                      when max(t6.hdwz) = 1 then
                       min(is_warning)
                      else
                       max(is_warning)
                    end is_warning,
                    max(t6.jhsjsj) jhsjsj
               from (select t4.jksjid,
               				 case
                              when t4.lx = 2 then
                               case
                                 when t4.syz &lt;= 0 then 2
                                 when t4.syz &lt;= t4.fz then 1
                                 else 0
                               end
                              else
                               case
                                 when t4.dw_scz = 10 then
                                  case
                                    when t4.syz &lt;= 0 then
                                     2
                                    else
                                     0
                                  end
                                 else
                                  case
                                    when t4.syz &lt;= 0 then 2
                                    when t4.syz &lt;= ceil(COALESCE(t4.jzz * 1, 0) *
                                                        (COALESCE(t4.fz, 0) / 100) *
                                                        (case
                                                           when t4.jzzdw = 12 then
                                                            30
                                                           else
                                                            1
                                                         end)) then
                                     1
                                    else
                                     0
                                  end
                               end
                            end is_warning,
                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
                                      t4.ydz_qdw || '#_#' || t4.ydz_h 
                                      || '#_#' || t4.ydz_hdw
                                      || '#_#' || t4.jhxlh
                                      || '#_#' || t4.lx
                                      || '#_#' || t4.jzz
                                      || '#_#' || t4.fz
                                      || '#_#' || t4.jzzdw
                                      || '#_#' || t4.dw_scz
                                      ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj,
                           t4.hdwz
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_date(t4.jhz, 'yyyy-mm-dd') -
                                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz,
                                    t4.ydz_q,
                                    t4.ydz_qdw,
                                    t4.ydz_h,
                                    t4.ydz_hdw,
                                    t4.dw_scz,
                                    case
                                      when t2.zjqdid is null then
                                       case
                                         when t11.jh is null then
                                          t11.fjzch || '#_#' || t11.xlh
                                         else
                                          t11.jh || '#_#' || t11.xlh
                                       end
                                      else
                                       t13.jh || '#_#' || t13.xlh
                                    end jhxlh,
                                    threshold.fz,
                                    threshold.lx,
                                    case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.scz
                                      else
                                       t4.zqz
                                    end jzz,
                                    case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.dw_scz
                                      else
                                       t4.dw_zqz
                                    end jzzdw,
                                    t2.hdwz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.jhz is not null
                                and t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
                                and t2.fjzch = #{paramsMap.fjzch}
                                and t2.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh
                               left join t_threshold_air threshold
                                 on threshold.dprtcode = t2.dprtcode
                                and threshold.fjzch = t2.fjzch
                                and threshold.jklbh = t4.jklbh
                               left join (select s2903.JKSJID, count(1) jls
                                           from b_s2_903 s2903
                                          group by s2903.JKSJID) s2903
                                 on s2903.JKSJID = t4.jksjid
                               where 1 = 1
                                ) t4
                               where 1 = 1) t6
              		group by t6.jksjid) s2904
    		on s2904.jksjid = s2902.id
		 where 1 = 1
		 <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
		    and (
		    	   UPPER(g2012.RWH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2012.CKH) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(g2012.RWMS) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
		    	<!-- or Z.ZJH like ('%'||#{paramsMap.keyword}||'%')
		    	or Z.YWMS like ('%'||#{paramsMap.keyword}||'%') -->
		    )
		 </if>
		 <if test="paramsMap != null and paramsMap.zjh != null and paramsMap.zjh != ''">
		 	and Z.ZJH = #{paramsMap.zjh}
		 </if>
		 <if test="paramsMap != null and paramsMap.dlid != null and paramsMap.dlid != ''">
		    and g201101.id = #{paramsMap.dlid}
		 </if>
		 <if test="paramsMap != null and paramsMap.warning != null and paramsMap.warning == 'checked'">
		 	and COALESCE(s2904.is_warning, 0) in (1,2)
		 </if>
		 <if test="paramsMap != null and paramsMap.wxxmlxList != null and paramsMap.wxxmlxList != ''">
		    and g2012.wxxmlx in
     			 <foreach item="item" index="index" collection="paramsMap.wxxmlxList" open="(" separator="," close=")">  
          			#{item}  
     			 </foreach>  
		 </if>
		 <if test="paramsMap.surplus != null or paramsMap.plan != null">
   			<include refid="surplus_plan_Param"></include>	
   		 </if>
   		 <if test="id != null and id != ''">
		 	and s2902.id = #{id}
		 </if>
		 <!-- order by ID asc -->
	  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
	    	<when test='pagination.sort == "auto"'>   
	    		ORDER BY COALESCE(s2904.is_warning, 0) desc, g2012.rwh asc                    
	    	</when>
	    	<otherwise>
			    ORDER BY ${pagination.sort} ${pagination.order}
	    	</otherwise>
		</choose>
		
  	</select>  
    
    <!-- 根据查询条件查询维修清单 -->
  	<select id="queryPackageMaintenanceDetailList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
	     select s2902.id,
	       		s2902.dprtcode,
	       		s2902.zjqdid,
	       		s2902.bjh,
	       		s2902.xlh,
	       		s2902.whsj,
	       		s2902.hdwz,
	            g2012.id AS MP_ID,
	   			g2012.wxxmlx AS MP_WXXMLX,
	       		g2012.zjh AS MP_ZJH,
	       		g2012.rwh AS MP_RWH,
	       		g2012.bb AS MP_BB,
	       		g2012.ckh AS MP_CKH,
	       		g2012.rwms AS MP_RWMS,
	       		g2012.dprtcode AS MP_DPRTCODE,
	       		g2012.gzlx AS MP_GZLX,
	       		g2012.is_hdwz AS MP_ISHDWZ,
		       	g201101.id as KDLID,
		        g201101.dlbh as KDLBH,
		        g201101.dlzwms as KDLZWMS,
		        g201101.dlywms as KDLYWMS,
	       		d008.xingh as BJXH,
	       		s2903.scsj as JKSCSJ,
	       		s2904.jhsjsj as JKJHSJSJ,
	       		Z.ZJH AS KZJH,
		        Z.ZWMS AS KZJHZWMS,
		        Z.YWMS AS KZJHYWMS,
		        U.USERNAME AS KZDRUSERNAME, 
		        U.REALNAME AS KZDRREALNAME,
		       	s2904.is_warning as ISWARNING,
	       		g201102.gkid as KGKID,
	       		g201102.gkbh as KGKBH,
	       		B13.GKFJID AS KGKFJID,
	        	B13.GZNRFJID AS KGZNRFJID,
	        	D011.ATTACHCOUNT,
	       		s2009.JKSJGDID as CHECKEDID,
	       		s2008.id as KGDID,
       			s2008.gdbh as KGDBH,
       			s2007.id as KGBID,
       			s2007.gbbh as KGBBH
  		from b_s2_902 s2902
  		join b_g2_012 g2012
    	on s2902.lyid = g2012.id
   		and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
   		and s2902.fjzch = #{paramsMap.fjzch}
   		and s2902.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
   		join B_G2_01103 g201103
   		on g201103.xgwxxmid = s2902.lyid
  		join b_g2_01101 g201101
    	on g2012.wxxmdlid = g201101.id
	  	join b_g2_01102 g201102
	    on g201102.wxxmid = g2012.id
	  	join b_g2_011 g2011
	    on g2011.dprtcode = g2012.dprtcode
	   	and g2011.wxfabh = g2012.wxfabh
	   	and g2011.zxbs = 2
	   	and g2011.id = g201102.mainid
	  	left join b_s2_008 s2008
	    on s2008.jksjid = s2902.id
	   	and s2008.zt != 9
	  	left join b_s2_007 s2007
	    on s2007.id = s2008.gbid
	  	left join d_008 d008
	    on d008.dprtcode = s2902.dprtcode
	   	and d008.bjh = s2902.bjh
	   	LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		LEFT JOIN D_005 Z on g2012.DPRTCODE = Z.DPRTCODE and g2012.ZJH = Z.ZJH
		LEFT JOIN B_G2_013 B13 ON g201102.GKID = B13.ID
	    LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
        ON D011.MAINID = B13.ID
	    left join B_S2_009 s2009
    	on s2009.JKSJGDID = s2902.id
  		left join (select t2.jksjid, max(t2.scsj) scsj
               from (select t1.jksjid,
                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
                       from b_s2_903 t1
                      where t1.zt = 1) t2
              group by t2.jksjid) s2903
    	on s2903.jksjid = s2902.id
  		left join (select t6.jksjid,
                    max(is_warning) is_warning,
                    max(t6.jhsjsj) jhsjsj
               from (select t4.jksjid,
                            case
                              when t4.syz &lt;= t4.fz then
                               1
                              else
                               0
                            end is_warning,
                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
                                      t4.ydz_qdw || '#_#' || t4.ydz_h ||
                                      '#_#' || t4.ydz_hdw || '#_#' ||
                                      t4.jhxlh) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_date(t4.jhz, 'yyyy-mm-dd') -
                                       to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz,
                                    t4.ydz_q,
                                    t4.ydz_qdw,
                                    t4.ydz_h,
                                    t4.ydz_hdw,
                                    case
                                      when t2.zjqdid is null then
                                       case
                                         when t11.jh is null then
                                          t11.fjzch || '#_#' || t11.xlh
                                         else
                                          t11.jh || '#_#' || t11.xlh
                                       end
                                      else
                                       t13.jh || '#_#' || t13.xlh
                                    end jhxlh,
                                    threshold.fz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.jhz is not null
                                and t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
                                and t2.fjzch = #{paramsMap.fjzch}
                                and t2.lylx = 1 <!-- 维修项目。如果是EO，那么就是2 -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh
                               left join t_threshold_air threshold
                                 on threshold.dprtcode = t2.dprtcode
                                and threshold.fjzch = t2.fjzch
                                and threshold.jklbh = t4.jklbh) t4) t6
              		group by t6.jksjid) s2904
    		on s2904.jksjid = s2902.id
		 where 1 = 1 and g201103.WXXMID = #{paramsMap.wxxmid,jdbcType=VARCHAR}
		 order by COALESCE(s2904.is_warning, 0) desc, g2012.rwh asc   
		
  	</select>  
  	
  	<!-- 根据查询条件分页查询当前监控数据(EO监控信息)(预组包专用) -->
	<select id="queryPackageEOList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
		
		select s2902.id,
		       s2902.dprtcode,
		       s2902.zjqdid,
		       s2902.bjh,
		       s2902.xlh,
		       s2902.whsj,
		       s2902.hdwz,
		       s2902.EOXC,
		       g2010.id as EO_ID,
		       g2010.eobh as EO_EOBH,
		       g2010.zjh as EO_ZJH,
		       g2010.bb as EO_BB,
		       g2010.eozt as EO_EOZT,
		       g2010.hdwz as EO_HDWZ,
		       g2010.jsgs as EO_JSGS,
		       g2010.zxfs as EO_ZXFS,
		       g2010.gzlx as EO_GZLX,
		       d008.xingh as BJXH,
		       s2903.scsj as JKSCSJ,
		       s2904.jhsjsj as JKJHSJSJ,
		       g2995.fjzw as FJZWSTR,
		       Z.ZJH AS KZJH,
		       Z.ZWMS AS KZJHZWMS,
		       Z.YWMS AS KZJHYWMS,
		       U.USERNAME AS KZDRUSERNAME, 
		       U.REALNAME AS KZDRREALNAME,
		       s2904.is_warning as ISWARNING,
		       s2009.JKSJGDID as CHECKEDID,
               s2008.id as KGDID,
       		   s2008.gdbh as KGDBH,
       		   s2007.id as KGBID,
       		   s2007.gbbh as KGBBH,
       		   c.dprtname as ZZJG
  		from b_s2_902 s2902
  		join b_g2_010 g2010
    	on s2902.lyid = g2010.id
   		and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		and s2902.fjzch = #{paramsMap.fjzch}
   		and s2902.lylx = 2 <!-- EO -->
   		left join t_department c on s2902.DPRTCODE=c.id
  		left join d_008 d008
    	on d008.dprtcode = s2902.dprtcode
   		and d008.bjh = s2902.bjh
  		left join b_s2_008 s2008
    	on s2008.jksjid = s2902.id
   		and s2008.zt != 9
  		left join b_s2_007 s2007
    	on s2007.id = s2008.gbid
    	LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		LEFT JOIN D_005 Z on g2010.DPRTCODE = Z.DPRTCODE and g2010.ZJH = Z.ZJH
		left join B_S2_009 s2009
    	on s2009.JKSJGDID = s2902.id
  		left join (select b_g2_995.ywid, wm_concat(b_g2_995.gbh) fjzw
               from b_g2_995
              where b_g2_995.ywlx = 6
                and b_g2_995.lx = 3
              group by b_g2_995.ywid) g2995
    	on g2995.ywid = g2010.id
  		left join (select t2.jksjid, max(t2.scsj) scsj
               from (select t1.jksjid,
                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
                       from b_s2_903 t1
                      where t1.zt = 1) t2
              group by t2.jksjid) s2903
    	on s2903.jksjid = s2902.id
 		left join (select t6.jksjid,
                    case
                      when max(t6.hdwz) = 1 then
                       min(is_warning)
                      else
                       max(is_warning)
                    end is_warning,
                    max(t6.jhsjsj) jhsjsj
               		from (select t4.jksjid,
               				case
                              when t4.lx = 2 then
                               case
                                 when t4.syz &lt;= 0 then 2
                                 when t4.syz &lt;= t4.fz then 1
                                 else 0
                               end
                              else
                               case
                                 when t4.dw_scz = 10 then
                                  case
                                    when t4.syz &lt;= 0 then
                                     2
                                    else
                                     0
                                  end
                                 else
                                  case
                                    when t4.syz &lt;= 0 then 2
                                    when t4.syz &lt;= ceil(COALESCE(t4.jzz * 1, 0) *
                                                        (COALESCE(t4.fz, 0) / 100) *
                                                        (case
                                                           when t4.jzzdw = 12 then
                                                            30
                                                           else
                                                            1
                                                         end)) then
                                     1
                                    else
                                     0
                                  end
                               end
                            end is_warning,
                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
                                      t4.ydz_qdw || '#_#' || t4.ydz_h 
                                      || '#_#' || t4.ydz_hdw
                                      || '#_#' || t4.jhxlh
                                      || '#_#' || t4.lx
                                      || '#_#' || t4.jzz
                                      || '#_#' || t4.fz
                                      || '#_#' || t4.jzzdw
                                      || '#_#' || t4.dw_scz
                                      ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj,
                             t4.hdwz
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_date(t4.jhz, 'yyyy-mm-dd') -
                                       to_date(to_char(sysdate, 'yyyy-mm-dd'),'yyyy-mm-dd')
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz,
                                    t4.ydz_q,
                                    t4.ydz_qdw,
                                    t4.ydz_h,
                                    t4.ydz_hdw,
                                    t4.dw_scz,
                                    case
                                      when t2.zjqdid is null then
                                       case
                                         when t11.jh is null then
                                          t11.fjzch || '#_#' || t11.xlh
                                         else
                                          t11.jh || '#_#' || t11.xlh
                                       end
                                      else
                                       t13.jh || '#_#' || t13.xlh
                                    end jhxlh,
                                    threshold.fz,
                                    threshold.lx,
                                     case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.scz
                                      else
                                       t4.zqz
                                    end jzz,
                                    case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.dw_scz
                                      else
                                       t4.dw_zqz
                                    end jzzdw,
                                    t2.hdwz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.jhz is not null
                                and t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
                                and t2.fjzch = #{paramsMap.fjzch}
                                and t2.lylx = 2 <!-- EO。如果是维修项目，那么就是1 -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh
                               left join t_threshold_air threshold
                                 on threshold.dprtcode = t2.dprtcode
                                and threshold.fjzch = t2.fjzch
                                and threshold.jklbh = t4.jklbh
                                left join (select s2903.JKSJID, count(1) jls
                                          from b_s2_903 s2903
                                          group by s2903.JKSJID) s2903
                                on s2903.JKSJID = t4.jksjid
                                ) t4) t6
              group by t6.jksjid) s2904
    	on s2904.jksjid = s2902.id
    	
 			where 1 = 1
		      <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
			    and (
			    	   UPPER(g2010.EOBH) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	or UPPER(g2010.EOZT) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	or UPPER(s2902.bjh) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	or UPPER(s2902.xlh) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	or UPPER(d008.xingh) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	<!-- or Z.ZJH like ('%'||#{paramsMap.keyword}||'%')
			    	or Z.YWMS like ('%'||#{paramsMap.keyword}||'%') -->
			    )
			 </if>
		 	 <if test="paramsMap != null and paramsMap.warning != null and paramsMap.warning == 'checked'">
		 		and COALESCE(s2904.is_warning, 0) in (1,2)
		 	</if>
		 	<if test="paramsMap != null and paramsMap.zjh != null and paramsMap.zjh != ''">
		 		and Z.ZJH = #{paramsMap.zjh}
		 	</if>
		 	<if test="paramsMap.surplus != null or paramsMap.plan != null">
  				<include refid="surplus_plan_Param"></include>	
    		</if>
		 	<!-- order by ID asc -->
		  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
		    	<when test='pagination.sort == "auto"'>   
		    		order by COALESCE(s2904.is_warning, 0) desc, g2010.eobh asc, s2902.EOXC asc               
		    	</when>
		    	<otherwise>
				    ORDER BY ${pagination.sort} ${pagination.order}
		    	</otherwise>
			</choose>
   </select>
   
   <!-- 根据查询条件分页查询当前监控数据(生产指令监控信息)(预组包专用) -->
	<select id="queryPackagePOList" resultMap="MonitoringCurrentWithRelMap" parameterType="com.eray.thjw.produce.po.MonitoringCurrent" >
		
		select s2902.id,
		       s2902.dprtcode,
		       s2902.zjqdid,
		       s2902.whsj,
		       s2902.hdwz,
		       g2014.id AS POID,
		       g2014.ZLBH AS POZLBH,
		       g2014.BB AS POBB,
		       g2014.JX AS POJX,
		       g2014.ZLMS AS POZLMS,
		       s2903.scsj as JKSCSJ,
		       s2904.jhsjsj as JKJHSJSJ,
		       Z.ZJH AS KZJH,
		       Z.ZWMS AS KZJHZWMS,
		       Z.YWMS AS KZJHYWMS,
		       U.USERNAME AS KZDRUSERNAME, 
		       U.REALNAME AS KZDRREALNAME,
		       s2904.is_warning as ISWARNING,
		       s2009.JKSJGDID as CHECKEDID,
               s2008.id as KGDID,
       		   s2008.gdbh as KGDBH,
       		   s2007.id as KGBID,
       		   s2007.gbbh as KGBBH,
       		   B13.id as KGKID,
	       	   B13.gkh as KGKBH,
	       	   B13.GKFJID AS KGKFJID,
	       	   B13.GZNRFJID AS KGZNRFJID,
       		   c.dprtname as ZZJG
  		from b_s2_902 s2902
  		join b_g2_014 g2014
    	on s2902.lyid = g2014.id
   		and s2902.dprtcode = #{dprtcode,jdbcType=VARCHAR}
		and s2902.fjzch = #{paramsMap.fjzch}
   		and s2902.lylx = 3 <!-- 生产指令 -->
   		LEFT JOIN B_G2_013 B13 ON g2014.dprtcode = B13.dprtcode and g2014.GKBH = B13.GKH and B13.zt = 7 and B13.zxbs = 2
	    LEFT JOIN (SELECT MAINID,COUNT(1) AS ATTACHCOUNT FROM D_011 where YXZT = 1 GROUP BY MAINID) D011
	    ON D011.MAINID = B13.ID
   		left join t_department c on s2902.DPRTCODE=c.id
  		left join b_s2_008 s2008
    	on s2008.jksjid = s2902.id
   		and s2008.zt != 9
  		left join b_s2_007 s2007
    	on s2007.id = s2008.gbid
    	LEFT JOIN T_USER U ON s2902.WHRID = U.ID
		LEFT JOIN D_005 Z on g2014.DPRTCODE = Z.DPRTCODE and g2014.ZJH = Z.ZJH
		left join B_S2_009 s2009
    	on s2009.JKSJGDID = s2902.id
  		left join (select t2.jksjid, max(t2.scsj) scsj
               from (select t1.jksjid,
                            wm_concat(t1.jklbh || '#_#' || t1.scjhz || '#_#' ||
                                      t1.scsjz) over(PARTITION BY t1.jksjid order by t1.jklbh) scsj
                       from b_s2_903 t1
                      where t1.zt = 1) t2
              group by t2.jksjid) s2903
    	on s2903.jksjid = s2902.id
 		left join (select t6.jksjid,
                    case
                      when max(t6.hdwz) = 1 then
                       min(is_warning)
                      else
                       max(is_warning)
                    end is_warning,
                    max(t6.jhsjsj) jhsjsj
               		from (select t4.jksjid,
               				case
                              when t4.lx = 2 then
                               case
                                 when t4.syz &lt;= 0 then 2
                                 when t4.syz &lt;= t4.fz then 1
                                 else 0
                               end
                              else
                               case
                                 when t4.dw_scz = 10 then
                                  case
                                    when t4.syz &lt;= 0 then
                                     2
                                    else
                                     0
                                  end
                                 else
                                  case
                                    when t4.syz &lt;= 0 then 2
                                    when t4.syz &lt;= ceil(COALESCE(t4.jzz * 1, 0) *
                                                        (COALESCE(t4.fz, 0) / 100) *
                                                        (case
                                                           when t4.jzzdw = 12 then
                                                            30
                                                           else
                                                            1
                                                         end)) then
                                     1
                                    else
                                     0
                                  end
                               end
                            end is_warning,
                            wm_concat(t4.jklbh || '#_#' || t4.jhqsz || '#_#' ||
                                      t4.jhz || '#_#' || t4.sjz || '#_#' ||
                                      t4.syz || '#_#' || t4.zqz || '#_#' ||
                                      t4.dw_zqz || '#_#' || t4.ydz_q || '#_#' ||
                                      t4.ydz_qdw || '#_#' || t4.ydz_h 
                                      || '#_#' || t4.ydz_hdw
                                      || '#_#' || t4.jhxlh
                                      || '#_#' || t4.lx
                                      || '#_#' || t4.jzz
                                      || '#_#' || t4.fz
                                      || '#_#' || t4.jzzdw
                                      || '#_#' || t4.dw_scz
                                      ) over(PARTITION BY t4.jksjid order by t4.jklbh) jhsjsj,
                             t4.hdwz
                       from (select t4.jksjid,
                                    t4.jklbh,
                                    t4.jhqsz,
                                    t4.jhz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_char(sysdate, 'yyyy-mm-dd')
                                      else
                                       (case
                                         when t2.zjqdid is null then
                                          COALESCE(t11.ljz, 0) +
                                          COALESCE(t11.csz, 0)
                                         else
                                          COALESCE(t13.sj_fz, 0) +
                                          COALESCE(t13.csz, 0)
                                       end) || ''
                                    end sjz,
                                    case
                                      when t4.jklbh = '1_10' then
                                       to_date(t4.jhz, 'yyyy-mm-dd') -
                                       to_date(to_char(sysdate, 'yyyy-mm-dd'),'yyyy-mm-dd')
                                      else
                                       cast(t4.jhz as integer) -
                                       (case
                                          when t2.zjqdid is null then
                                           COALESCE(t11.ljz, 0) +
                                           COALESCE(t11.csz, 0)
                                          else
                                           COALESCE(t13.sj_fz, 0) +
                                           COALESCE(t13.csz, 0)
                                        end)
                                    end syz,
                                    t4.zqz,
                                    t4.dw_zqz,
                                    t4.ydz_q,
                                    t4.ydz_qdw,
                                    t4.ydz_h,
                                    t4.ydz_hdw,
                                    t4.dw_scz,
                                    case
                                      when t2.zjqdid is null then
                                       case
                                         when t11.jh is null then
                                          t11.fjzch || '#_#' || t11.xlh
                                         else
                                          t11.jh || '#_#' || t11.xlh
                                       end
                                      else
                                       t13.jh || '#_#' || t13.xlh
                                    end jhxlh,
                                    threshold.fz,
                                    threshold.lx,
                                     case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.scz
                                      else
                                       t4.zqz
                                    end jzz,
                                    case
                                      when COALESCE(s2903.jls, 0) = 0 then
                                       t4.dw_scz
                                      else
                                       t4.dw_zqz
                                    end jzzdw,
                                    t2.hdwz
                               from b_s2_904 t4
                               join b_s2_902 t2
                                 on t4.jhz is not null
                                and t4.zt = 1
                                and t2.id = t4.jksjid
                                and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
                                and t2.fjzch = #{paramsMap.fjzch}
                                and t2.lylx = 3 <!-- 生产指令。如果是维修项目，那么就是1 -->
                               left join b_s2_911 t11
                                 on t2.dprtcode = t11.dprtcode
                                and t2.fjzch = t11.fjzch
                                and t4.jklbh = t11.jklbh
                                and (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t4.wz else 1 end) = (case when t4.jklbh = '2_30_EH' or t4.jklbh = '3_30_EC' then t11.wz else 1 end)
                               left join b_s2_913 t13
                                 on t2.dprtcode = t13.dprtcode
                                and t2.zjqdid = t13.zjqdid
                                and t4.jklbh = t13.jklbh
                               left join t_threshold_air threshold
                                 on threshold.dprtcode = t2.dprtcode
                                and threshold.fjzch = t2.fjzch
                                and threshold.jklbh = t4.jklbh
                                left join (select s2903.JKSJID, count(1) jls
                                          from b_s2_903 s2903
                                          group by s2903.JKSJID) s2903
                                on s2903.JKSJID = t4.jksjid
                                ) t4) t6
              group by t6.jksjid) s2904
    	on s2904.jksjid = s2902.id
    	
 			where 1 = 1
		      <if test="paramsMap != null and paramsMap.keyword != null and paramsMap.keyword != ''">
			    and (
			    	   UPPER(g2014.ZLBH) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	or UPPER(g2014.ZLMS) like UPPER('%'||#{paramsMap.keyword}||'%')
			    	<!-- or Z.ZJH like ('%'||#{paramsMap.keyword}||'%')
			    	or Z.YWMS like ('%'||#{paramsMap.keyword}||'%') -->
			    )
			 </if>
		 	 <if test="paramsMap != null and paramsMap.warning != null and paramsMap.warning == 'checked'">
		 		and COALESCE(s2904.is_warning, 0) in (1,2)
		 	</if>
		 	<if test="paramsMap != null and paramsMap.zjh != null and paramsMap.zjh != ''">
		 		and Z.ZJH = #{paramsMap.zjh}
		 	</if>
		 	<if test="paramsMap.surplus != null or paramsMap.plan != null">
  				<include refid="surplus_plan_Param"></include>	
    		</if>
		 	<!-- order by ID asc -->
		  	<choose><!--  进行排序判断，如果默认就是默认字段排序 -->
		    	<when test='pagination.sort == "auto"'>   
		    		order by COALESCE(s2904.is_warning, 0) desc, g2014.ZLBH asc, s2902.EOXC asc, s2902.id             
		    	</when>
		    	<otherwise>
				    ORDER BY ${pagination.sort} ${pagination.order}
		    	</otherwise>
			</choose>
   </select>
  	
  	
  	
  	<!-- ******************************************搜素条件区域 start********************************************************** -->
	
	<!-- 剩余和计划查询 start -->
	<sql id="surplus_plan_Param">
		<!-- 以下为循环 剩余 start -->
		<!-- 日历 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.rl != null and paramsMap.surplus.rl != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '1_10'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t11.jklbh = '1_10'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '1_10'
			       	where 1 = 1	
	                <!-- 日历 单位：DAY -->
		       		<if test="paramsMap.surplus.rldw == '11'">
		       			and (to_date(t4.jhz, 'yyyy-mm-dd') - to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')) &lt;= #{paramsMap.surplus.rl} 
		       		</if>
		       		<!-- 日历 单位：MON -->
		       		<if test="paramsMap.surplus.rldw == '12'">
		       			and (to_date(t4.jhz, 'yyyy-mm-dd') - to_date(to_char(sysdate, 'yyyy-mm-dd'), 'yyyy-mm-dd')) 
	                	&lt;=
	                	(ADD_MONTHS(sysdate, #{paramsMap.surplus.rl}) - sysdate)
		       		</if>
		       		and t4.jksjid = s2902.id
                ) 
        		<!-- 日历 含空 -->
        		<if test="paramsMap.surplus.rlhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '1_10'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
		</if>
		<!-- 飞行时间 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.fxsj != null and paramsMap.surplus.fxsj != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '2_10_FH'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t11.jklbh = '2_10_FH'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '2_10_FH'
			        where 1 = 1	
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.fxsj}
                 	and t4.jksjid = s2902.id
                ) 
        		<!-- 飞行时间 含空 -->
        		<if test="paramsMap.surplus.fxsjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_10_FH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 飞行循环 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.fxxh != null and paramsMap.surplus.fxxh != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '3_10_FC'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t11.jklbh = '3_10_FC'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '3_10_FC'
			        where 1 = 1	
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.fxxh}
                     and t4.jksjid = s2902.id
                ) 
        		<!-- 飞行循环 含空 -->
        		<if test="paramsMap.surplus.fxxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_10_FC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 发动机时间 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.fdjsj != null and paramsMap.surplus.fdjsj != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '2_30_EH'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t4.wz = t11.wz
			        and t11.jklbh = '2_30_EH'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '2_30_EH'
			        where 1 = 1		
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.fdjsj}
                     and t4.jksjid = s2902.id
                ) 
        		<!-- 发动机时间 含空 -->
        		<if test="paramsMap.surplus.fdjsjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_30_EH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 发动机循环 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.fdjxh != null and paramsMap.surplus.fdjxh != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '3_30_EC'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t4.wz = t11.wz
			        and t11.jklbh = '3_30_EC'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '3_30_EC'
			        where 1 = 1		
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.fdjxh}
                     and t4.jksjid = s2902.id
                ) 
        		<!-- 发动机循环 含空 -->
        		<if test="paramsMap.surplus.fdjxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_30_EC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- APU时间 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.apusj != null and paramsMap.surplus.apusj != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '2_20_AH'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t11.jklbh = '2_20_AH'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '2_20_AH'
			        where 1 = 1		
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.apusj}
                     and t4.jksjid = s2902.id
                ) 
        		<!-- APU时间 含空 -->
        		<if test="paramsMap.surplus.apusjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_20_AH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- APU循环 -->
       	<if test="paramsMap.surplus != null and paramsMap.surplus.apuxh != null and paramsMap.surplus.apuxh != ''">
       		and (
       			exists (
       				select 1
			        from b_s2_904 t4
			        join b_s2_902 t2
			        on t4.jhz is not null
			        and t4.zt = 1
			        and t2.id = t4.jksjid
			        and t2.dprtcode = #{dprtcode,jdbcType=VARCHAR}
			        and t2.fjzch = #{paramsMap.fjzch}
			        and t2.lylx = #{paramsMap.lylx} <!-- 维修项目。如果是EO，那么就是2 -->
			        and t4.jklbh = '3_20_AC'
			        left join b_s2_911 t11
			        on t2.dprtcode = t11.dprtcode
			        and t2.fjzch = t11.fjzch
			        and t4.jklbh = t11.jklbh
			        and t11.jklbh = '3_20_AC'
			        left join b_s2_913 t13
			        on t2.dprtcode = t13.dprtcode
			        and t2.zjqdid = t13.zjqdid
			        and t4.jklbh = t13.jklbh
			        and t13.jklbh = '3_20_AC'
			        where 1 = 1		
                	<include refid="surplus_plan_Param_2"></include>	
                     &lt;= #{paramsMap.surplus.apuxh}
                     and t4.jksjid = s2902.id
                ) 
        		<!-- APU循环 含空 -->
        		<if test="paramsMap.surplus.apuxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_20_AC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 以下为循环 剩余 end -->
       	<!-- 以下为循环 计划 start -->
       	<!-- 日历 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.rl != null and paramsMap.plan.rl != ''">
       		and (
       			exists (
       				select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '1_10'
	                and to_date(t904.jhz, 'yyyy-mm-dd') &lt;= to_date(#{paramsMap.plan.rl}, 'yyyy-mm-dd')
                )
        		<!-- 日历 含空 -->
        		<if test="paramsMap.plan.rlhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '1_10'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 飞行时间 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.fxsj != null and paramsMap.plan.fxsj != ''">
       		and (
       			exists (
       				select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '2_10_FH'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.fxsj})
                ) 
        		<!-- 飞行时间 含空 -->
        		<if test="paramsMap.plan.fxsjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_10_FH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 飞行循环 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.fxxh != null and paramsMap.plan.fxxh != ''">
       		and (
       			exists (
       				select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '3_10_FC'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.fxxh})
                ) 
        		<!-- 飞行循环 含空 -->
        		<if test="paramsMap.plan.fxxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_10_FC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 发动机时间 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.fdjsj != null and paramsMap.plan.fdjsj != ''">
       		and (
       			exists (
	       			select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '2_30_EH'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.fdjsj})	
                ) 
        		<!-- 发动机时间 含空 -->
        		<if test="paramsMap.plan.fdjsjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_30_EH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- 发动机循环 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.fdjxh != null and paramsMap.plan.fdjxh != ''">
       		and (
       			exists (
	       			select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '3_30_EC'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.fdjxh})	
                ) 
        		<!-- 发动机循环 含空 -->
        		<if test="paramsMap.plan.fdjxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_30_EC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- APU时间 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.apusj != null and paramsMap.plan.apusj != ''">
       		and (
       			exists (
	       			select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '2_20_AH'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.apusj})	
                ) 
        		<!-- APU时间 含空 -->
        		<if test="paramsMap.plan.apusjhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '2_20_AH'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
       	<!-- APU循环 -->
       	<if test="paramsMap.plan != null and paramsMap.plan.apuxh != null and paramsMap.plan.apuxh != ''">
       		and (
       			exists (
	       			select 1
                  	from b_s2_904 t904
                 	where t904.zt = 1
                   	and s2902.id = t904.jksjid
                   	and t904.jklbh = '3_20_AC'
                 	and to_number(t904.jhz) &lt;= to_number(#{paramsMap.plan.apuxh})	
                ) 
        		<!-- APU循环 含空 -->
        		<if test="paramsMap.plan.apuxhhk == 1">
        			or not exists (
        				<include refid="surplus_plan_Param_3"></include>	
                    	and s2904.jklbh = '3_20_AC'
                 	)
       			</if>
        		<!-- 下面的括号必须有 -->
        	)
       	</if>
  		<!-- 以下为循环 计划 end -->
	</sql>
	<!-- 剩余和计划查询 end -->
	
	<!-- 剩余和计划包含查询2 start -->
	<sql id="surplus_plan_Param_2">
		 and 
		 (
			cast(t4.jhz as integer) - 
		 	(
 			case
	           	when t2.zjqdid is null then	COALESCE(t11.ljz, 0) + COALESCE(t11.csz, 0)
	           	else COALESCE(t13.sj_fz, 0) + COALESCE(t13.csz, 0)
       		end
           	)
      	 ) 
	</sql>
	<!-- 剩余和计划包含查询2 end -->
	
	<!-- 剩余和计划包含查询3 start -->
	<sql id="surplus_plan_Param_3">
		select 1
        from b_s2_904 s2904
        where s2904.jksjid = s2902.id
          and s2904.zt = 1
          and s2904.jhz is not null
	</sql>
	<!-- 剩余和计划包含查询3 end -->
	
	<!-- ******************************************搜素条件区域 end****************************************************** -->
  	<!-- 根据EO执行对象删除当前监控数据 -->
  	<delete id="deleteByEOExecObject">
  		DELETE FROM B_S2_902 
  			WHERE LYID = #{lyid, jdbcType=VARCHAR}
  				<if test="fjzch != null">
  					AND FJZCH = #{fjzch, jdbcType=VARCHAR}
  				</if>
  				<if test="bjh != null">
  					AND BJH = #{bjh, jdbcType=VARCHAR}
  				</if>
  				<if test="xlh != null">
  					AND XLH = #{xlh, jdbcType=VARCHAR}
  				</if>
  	</delete>
  	
  	<!-- 根据装机清单ID删除当前监控数据 -->
  	<delete id="deleteByZjqdid">
  		delete from B_S2_902
	 			where ZJQDID = #{zjqdid, jdbcType=VARCHAR}
  	</delete>
  	
  	 <!-- 根据装机清单id更新序列号 -->
  <update id="updateXlhByZjqdid">
  	UPDATE B_S2_902 SET XLH = #{xlh, jdbcType=VARCHAR} WHERE ZJQDID = #{zjqdid, jdbcType=VARCHAR}
  </update>
</mapper>